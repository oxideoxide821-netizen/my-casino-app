<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GLARE: QUANTUM NETIZEN [ULTIMATE]</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap');
        
        :root {
            --win-bg: #c3c7cb;
            --win-blue: #000080;
            --win-blue-light: #1084d0;
            --win-shadow-dark: #404040;
            --win-shadow-mid: #808080;
            --win-light: #ffffff;
            --accent: #00f2ff;
            --warn: #ff0055;
            --success: #00ff41;
            --text-main: #000;
            --bg-color: #008080;
            --scanline-opacity: 0.15;
        }

        body.theme-matrix {
            --bg-color: #000; --accent: #0f0; --win-bg: #010a01; --win-light: #0f0;
            --win-shadow-mid: #003b00; --win-blue: #003b00; --text-main: #0f0; --warn: #00ff00;
            --scanline-opacity: 0.3;
        }
        body.theme-neon {
            --bg-color: #1a0033; --accent: #f0f; --win-bg: #2d004d; --win-light: #f0f;
            --win-shadow-mid: #4a0080; --win-blue: #800080; --text-main: #f0f; --warn: #ff00ff;
            --scanline-opacity: 0.2;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            image-rendering: pixelated; 
            user-select: none;
        }

        body { 
            background: var(--bg-color); margin: 0; padding: 0;
            font-family: 'VT323', monospace; height: 100vh; 
            overflow: hidden; transition: background 0.5s ease;
        }

        body::after {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, var(--scanline-opacity)) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 2px, 3px 100%; pointer-events: none; z-index: 99999;
            animation: scanline 8s linear infinite;
        }

        @keyframes scanline {
            0% { transform: translateY(0); }
            100% { transform: translateY(10px); }
        }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center; 
            justify-content: center; padding: 15px; z-index: 10;
        }
        .screen.active { display: flex; animation: glitchIn 0.4s cubic-bezier(0.23, 1, 0.32, 1); }
        
        @keyframes glitchIn {
            0% { opacity: 0; transform: scale(0.9) translateY(20px) skewX(10deg); filter: hue-rotate(90deg); }
            50% { opacity: 0.8; transform: scale(1.02) translateY(-5px) skewX(-5deg); }
            100% { opacity: 1; transform: scale(1) translateY(0) skewX(0); filter: hue-rotate(0); }
        }

        .window {
            background: var(--win-bg); border: 4px solid;
            border-color: var(--win-light) var(--win-shadow-dark) var(--win-shadow-dark) var(--win-light);
            width: 100%; max-width: 440px; padding: 4px;
            box-shadow: 8px 8px 0px rgba(0,0,0,0.6); display: flex; flex-direction: column;
            animation: windowFloat 6s ease-in-out infinite;
        }

        @keyframes windowFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        .title-bar {
            background: linear-gradient(90deg, var(--win-blue), var(--win-blue-light));
            color: white; padding: 4px 10px; display: flex;
            justify-content: space-between; align-items: center; font-size: 14px; 
            font-family: 'Press Start 2P', cursive; font-size: 10px;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.5);
        }
        .title-controls { display: flex; gap: 2px; }
        .win-btn { 
            background: var(--win-bg); color: black; border: 2px solid;
            border-color: var(--win-light) var(--win-shadow-dark) var(--win-shadow-dark) var(--win-light);
            padding: 0 6px; font-size: 10px; cursor: pointer; font-family: 'Press Start 2P';
            transition: all 0.1s;
        }
        .win-btn:hover { background: var(--win-blue-light); color: white; }
        .win-btn:active { 
            border-color: var(--win-shadow-dark) var(--win-light) var(--win-light) var(--win-shadow-dark); 
            transform: translate(1px, 1px); 
        }

        .dashboard {
            background: #000; border: 4px inset var(--win-light);
            margin: 8px 0; padding: 12px; display: flex;
            justify-content: space-between; align-items: center;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
        }
        .lcd-container { display: flex; flex-direction: column; align-items: center; }
        .lcd-label { 
            color: var(--win-light); font-size: 10px; margin-bottom: 4px; 
            text-transform: uppercase; letter-spacing: 2px;
            font-family: 'Press Start 2P'; opacity: 0.8;
        }
        .lcd {
            background: #1a0000; border: 3px solid #400;
            color: #f00; font-family: 'VT323', monospace;
            font-size: 36px; font-weight: bold; padding: 4px 12px;
            min-width: 100px; text-align: center; text-shadow: 0 0 10px #f00, 0 0 20px #f00;
            box-shadow: inset 0 0 10px rgba(255,0,0,0.3);
            animation: lcdPulse 2s ease-in-out infinite;
        }
        @keyframes lcdPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        .smiley {
            width: 54px; height: 54px; background: var(--win-bg);
            border: 3px solid; border-color: var(--win-light) var(--win-shadow-mid) var(--win-shadow-mid) var(--win-light);
            display: flex; align-items: center; justify-content: center;
            font-size: 34px; cursor: pointer; transition: transform 0.1s;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
        }
        .smiley:hover { transform: scale(1.05); }
        .smiley:active { 
            border-color: var(--win-shadow-mid) var(--win-light) var(--win-light) var(--win-shadow-mid); 
            transform: scale(0.95); 
        }

        .viewport {
            position: relative; border: 4px inset var(--win-light);
            background: #808080; overflow: hidden; max-height: 48vh;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        canvas { display: block; background: #bdbdbd; cursor: crosshair; }

        .xp-pop {
            position: absolute; color: var(--success); font-weight: 900;
            font-size: 28px; pointer-events: none; z-index: 999;
            text-shadow: 2px 2px #000, 0 0 15px var(--success), 0 0 30px var(--success);
            animation: xpRise 1.2s forwards;
            font-family: 'Press Start 2P';
        }
        @keyframes xpRise { 
            0% { opacity: 0; transform: scale(0.3) rotate(-10deg); } 
            20% { opacity: 1; transform: scale(1.3) rotate(5deg); } 
            100% { opacity: 0; transform: translateY(-100px) rotate(0deg); } 
        }

        .terminal {
            background: #050505; border: 4px inset var(--win-light);
            color: var(--accent); font-family: 'VT323', monospace;
            font-size: 14px; padding: 10px; height: 90px;
            margin: 8px 0; overflow: hidden; position: relative;
            box-shadow: inset 0 0 15px rgba(0,255,255,0.1);
            text-shadow: 0 0 5px var(--accent);
        }
        .terminal-cursor { 
            display: inline-block; width: 10px; height: 18px; 
            background: var(--accent); animation: blink 0.7s infinite; 
            box-shadow: 0 0 10px var(--accent);
        }
        @keyframes blink { 50% { opacity: 0; } }

        .controls { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; width: 100%; }
        .btn {
            background: var(--win-bg); border: 3px solid;
            border-color: var(--win-light) var(--win-shadow-dark) var(--win-shadow-dark) var(--win-light);
            padding: 14px; font-size: 11px; font-weight: bold;
            cursor: pointer; color: var(--text-main); display: flex;
            align-items: center; justify-content: center; gap: 8px;
            text-transform: uppercase; transition: all 0.15s;
            font-family: 'Press Start 2P'; font-size: 9px;
            position: relative; overflow: hidden;
        }
        .btn::before {
            content: ''; position: absolute; top: 0; left: -100%;
            width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }
        .btn:hover::before { left: 100%; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .btn:active { 
            border-color: var(--win-shadow-dark) var(--win-light) var(--win-light) var(--win-shadow-dark); 
            transform: translateY(0); 
        }
        .btn-gold { 
            background: linear-gradient(135deg, #ffd700, #ff8c00); 
            color: #000; text-shadow: 0 1px 0 rgba(255,255,255,0.4);
            box-shadow: 0 4px 0 #b8860b;
        }
        .btn-gold:active { box-shadow: 0 2px 0 #b8860b; transform: translateY(2px); }

        .menu-box {
            background: #fff; border: 4px inset var(--win-light);
            width: 100%; height: 250px; overflow-y: auto; padding: 10px;
            color: #000; font-size: 12px; font-family: 'VT323';
        }
        .menu-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; border-bottom: 1px solid #ddd;
            transition: all 0.2s;
        }
        .menu-row:hover { 
            background: #f0f0f0; 
            transform: translateX(5px);
            box-shadow: -3px 0 0 var(--win-blue-light);
        }
        .menu-row b { font-family: 'Press Start 2P'; font-size: 9px; }

        .glitch-text {
            animation: glitch 3s infinite;
            position: relative;
        }
        @keyframes glitch {
            0%, 90%, 100% { transform: translate(0); }
            92% { transform: translate(-2px, 2px); }
            94% { transform: translate(2px, -2px); }
            96% { transform: translate(-1px, -1px); }
            98% { transform: translate(1px, 1px); }
        }

        .combo-counter {
            position: absolute; top: 10px; right: 10px;
            font-family: 'Press Start 2P'; font-size: 20px;
            color: var(--warn); text-shadow: 0 0 10px var(--warn);
            opacity: 0; transition: opacity 0.3s;
            z-index: 100;
        }
        .combo-counter.show { opacity: 1; animation: comboPulse 0.5s; }
        @keyframes comboPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .quest-box {
            background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,140,0,0.2));
            border: 2px solid #ffd700; padding: 10px; margin: 8px 0;
            font-size: 11px;
        }
        .quest-title { color: #ffd700; font-weight: bold; margin-bottom: 5px; }
        .quest-progress { background: #333; height: 10px; margin-top: 5px; }
        .quest-fill { background: #ffd700; height: 100%; transition: width 0.3s; }

        .trade-panel {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: var(--win-bg); border: 4px solid var(--accent);
            padding: 20px; z-index: 100000; transition: transform 0.3s;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            width: 300px;
        }
        .trade-panel.show { transform: translate(-50%, -50%) scale(1); }
        .trade-slot {
            width: 60px; height: 60px; border: 3px inset var(--win-light);
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; margin: 10px auto; cursor: pointer;
            background: rgba(0,0,0,0.1);
        }
        .trade-btns { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }

        .notification {
            position: fixed; top: 20px; left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--win-bg); border: 3px solid var(--accent);
            padding: 15px 25px; font-family: 'Press Start 2P'; font-size: 10px;
            box-shadow: 0 0 20px var(--accent);
            z-index: 100001; transition: transform 0.3s;
            text-align: center;
        }
        .notification.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body class="theme-classic">

    <div id="notification" class="notification">
        <div style="color: var(--accent)">–î–û–°–¢–ò–ñ–ï–ù–ò–ï!</div>
        <div id="notif-text" style="font-size: 9px; margin-top: 5px;">–¢–µ–∫—Å—Ç</div>
    </div>

    <div id="trade-panel" class="trade-panel">
        <div style="text-align: center; font-family: 'Press Start 2P'; font-size: 10px; margin-bottom: 15px;">
            –û–ë–ú–ï–ù –° <span id="trade-partner">–î–†–£–ì</span>
        </div>
        <div style="display: flex; justify-content: space-around; align-items: center;">
            <div style="text-align: center;">
                <div>–í—ã</div>
                <div class="trade-slot" id="my-item" onclick="engine.selectTradeItem()">?</div>
            </div>
            <div style="font-size: 24px;">‚áÑ</div>
            <div style="text-align: center;">
                <div>–î—Ä—É–≥</div>
                <div class="trade-slot" id="partner-item">?</div>
            </div>
        </div>
        <div class="trade-btns">
            <button class="btn btn-gold" onclick="engine.confirmTrade()">–û–ë–ú–ï–ù</button>
            <button class="btn" onclick="engine.closeTrade()">X</button>
        </div>
    </div>

    <div id="combo" class="combo-counter">COMBO x0</div>

    <div id="scr-game" class="screen active">
        <div class="window">
            <div class="title-bar">
                <span class="glitch-text">GLARE_QUANTUM.SYS [v9.9]</span>
                <div class="title-controls">
                    <span class="win-btn" onclick="gui.to('opts')">?</span>
                    <span class="win-btn" onclick="engine.reset()">R</span>
                </div>
            </div>
            
            <div class="quest-box" id="daily-quest">
                <div class="quest-title">üìú –ó–ê–î–ê–ß–ê –î–ù–Ø: <span id="quest-name">–û—Ç–∫—Ä–æ–π 20 —è—á–µ–µ–∫</span></div>
                <div style="display: flex; justify-content: space-between; font-size: 10px;">
                    <span>–ü—Ä–æ–≥—Ä–µ—Å—Å: <span id="quest-progress">0</span>/<span id="quest-target">20</span></span>
                    <span>–ù–∞–≥—Ä–∞–¥–∞: <span id="quest-reward">500 XP</span></span>
                </div>
                <div class="quest-progress">
                    <div class="quest-fill" id="quest-bar" style="width: 0%"></div>
                </div>
            </div>

            <div class="dashboard">
                <div class="lcd-container">
                    <span class="lcd-label">SCORE_XP</span>
                    <div class="lcd" id="score-lcd">0000</div>
                </div>
                <div class="smiley" id="face" onclick="engine.reset()">üòé</div>
                <div class="lcd-container">
                    <span class="lcd-label">TIME_ELAPSED</span>
                    <div class="lcd" id="timer-lcd">00:00</div>
                </div>
            </div>
            <div class="viewport" id="vp">
                <canvas id="main-canvas"></canvas>
            </div>
            <div class="terminal" id="terminal">
                > GIGACHAT CORE: –ê–ö–¢–ò–í–ê–¶–ò–Ø... [OK]<br>
                > –ñ–î–£ –¢–í–û–ô –•–û–î, –ß–ï–õ–û–í–ï–ö.<br>
                > –°–ö–û–†–û –¢–´ –ü–û–ñ–ê–õ–ï–ï–®–¨ –û–ë –≠–¢–û–ú.
            </div>
            <div class="controls">
                <button class="btn" onclick="gui.to('shop')">üí∞ SHOP</button>
                <button class="btn" onclick="gui.to('rank')">üèÜ LEADERS</button>
                <button class="btn" onclick="gui.to('trade')">ü§ù TRADE</button>
                <button class="btn" onclick="gui.to('quests')">üìú QUESTS</button>
                <button class="btn" onclick="gui.to('opts')">‚öôÔ∏è OPTIONS</button>
                <button class="btn" style="grid-column: span 2; background: #000; color: var(--accent); border-color: var(--accent);" onclick="engine.gigaHint()">
                    üß† GIGACHAT ANALYZE (-150 XP)
                </button>
            </div>
        </div>
    </div>

    <div id="scr-shop" class="screen">
        <div class="window">
            <div class="title-bar">
                <span>SYSTEM_MARKET.INI</span>
                <span class="win-btn" onclick="gui.to('game')">X</span>
            </div>
            <div class="menu-box">
                <div class="menu-row">
                    <span><b>GRID 15x15</b> - –ù–æ–≤–∏—á–æ–∫</span>
                    <button class="win-btn" onclick="engine.buyGrid(15, 500)">500 XP</button>
                </div>
                <div class="menu-row">
                    <span><b>GRID 30x30</b> - –ü—Ä–æ—Ñ–∏</span>
                    <button class="win-btn" onclick="engine.buyGrid(30, 1500)">1500 XP</button>
                </div>
                <div class="menu-row">
                    <span><b>GRID 50x50</b> - –õ–µ–≥–µ–Ω–¥–∞</span>
                    <button class="win-btn" onclick="engine.buyGrid(50, 5000)">5000 XP</button>
                </div>
                <div class="menu-row">
                    <span><b>SHIELD</b> - –ó–∞—â–∏—Ç–∞ –æ—Ç 1 –º–∏–Ω—ã</span>
                    <button class="win-btn" onclick="engine.buyShield()">200 XP</button>
                </div>
                <div class="menu-row">
                    <span><b>TIME FREEZE</b> - –ü–∞—É–∑–∞ 10—Å</span>
                    <button class="win-btn" onclick="engine.buyTime()">300 XP</button>
                </div>
            </div>
            <button class="btn" style="width:100%; margin-top:10px" onclick="gui.to('game')">–í–ï–†–ù–£–¢–¨–°–Ø –ö –ò–ì–†–ï</button>
        </div>
    </div>

    <div id="scr-rank" class="screen">
        <div class="window">
            <div class="title-bar">
                <span>GLOBAL_RANK.LOG</span>
                <span class="win-btn" onclick="gui.to('game')">X</span>
            </div>
            <div class="menu-box" id="leader-data">
                <div class="menu-row"><b>1. GIGACHAT_ELITE</b> <span style="color:gold">999999</span></div>
                <div class="menu-row"><b>2. NETIZEN_ADMIN</b> <span style="color:silver">154000</span></div>
                <div class="menu-row"><b>3. CYBER_NINJA</b> <span style="color:#cd7f32">89000</span></div>
                <div class="menu-row"><b>4. PIXEL_HUNTER</b> <span>45000</span></div>
                <div class="menu-row"><b>5. –¢–´</b> <span id="my-stat" style="color:var(--win-blue-light); font-weight:bold">0</span></div>
            </div>
            <button class="btn" style="width:100%; margin-top:10px" onclick="gui.to('game')">–ó–ê–ö–†–´–¢–¨ –õ–û–ì–ò</button>
        </div>
    </div>

    <div id="scr-trade" class="screen">
        <div class="window">
            <div class="title-bar">
                <span>TRADE_CENTER.exe</span>
                <span class="win-btn" onclick="gui.to('game')">X</span>
            </div>
            <div class="menu-box">
                <div class="menu-row" onclick="engine.openTrade('CYBER_NINJA')">
                    <span><b>üë§ CYBER_NINJA</b><br>üü¢ –û–Ω–ª–∞–π–Ω | –†–µ–π—Ç–∏–Ω–≥: #3</span>
                    <button class="win-btn">–¢–û–†–ì–û–í–ê–¢–¨</button>
                </div>
                <div class="menu-row" onclick="engine.openTrade('PIXEL_MASTER')">
                    <span><b>üë§ PIXEL_MASTER</b><br>üü° –í –∏–≥—Ä–µ | –†–µ–π—Ç–∏–Ω–≥: #7</span>
                    <button class="win-btn">–¢–û–†–ì–û–í–ê–¢–¨</button>
                </div>
                <div class="menu-row" onclick="engine.openTrade('NEON_RIDER')">
                    <span><b>üë§ NEON_RIDER</b><br>üî¥ –û—Ñ–ª–∞–π–Ω | –†–µ–π—Ç–∏–Ω–≥: #12</span>
                    <button class="win-btn">–¢–û–†–ì–û–í–ê–¢–¨</button>
                </div>
            </div>
            <div style="padding: 10px; font-size: 11px; color: #666; text-align: center;">
                –í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞ –¥–ª—è –æ–±–º–µ–Ω–∞ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏
            </div>
            <button class="btn" style="width:100%; margin-top:10px" onclick="gui.to('game')">–ù–ê–ó–ê–î</button>
        </div>
    </div>

    <div id="scr-quests" class="screen">
        <div class="window">
            <div class="title-bar">
                <span>QUEST_LOG.dat</span>
                <span class="win-btn" onclick="gui.to('game')">X</span>
            </div>
            <div class="menu-box">
                <div class="menu-row">
                    <span><b>‚ö° –°–∫–æ—Ä–æ—Å—Ç—å</b><br>–ù–∞–±–µ—Ä–∏ –∫–æ–º–±–æ x10</span>
                    <span style="color: var(--success)">200 XP</span>
                </div>
                <div class="menu-row">
                    <span><b>üõ°Ô∏è –í—ã–∂–∏–≤—à–∏–π</b><br>–ò—Å–ø–æ–ª—å–∑—É–π —â–∏—Ç 3 —Ä–∞–∑–∞</span>
                    <span style="color: var(--success)">300 XP</span>
                </div>
                <div class="menu-row">
                    <span><b>üí∞ –ë–æ–≥–∞—á</b><br>–ù–∞–∫–æ–ø–∏ 5000 XP</span>
                    <span style="color: var(--success)">1000 XP</span>
                </div>
                <div class="menu-row">
                    <span><b>üéØ –°–Ω–∞–π–ø–µ—Ä</b><br>–û—Ç–∫—Ä–æ–π 50 —è—á–µ–µ–∫ –±–µ–∑ –ø—Ä–æ–º–∞—Ö–∞</span>
                    <span style="color: var(--success)">500 XP</span>
                </div>
            </div>
            <button class="btn" style="width:100%; margin-top:10px" onclick="gui.to('game')">–ù–ê–ó–ê–î</button>
        </div>
    </div>

    <div id="scr-opts" class="screen">
        <div class="window">
            <div class="title-bar">
                <span>CONFIG_SYSTEM.CFG</span>
                <span class="win-btn" onclick="gui.to('game')">X</span>
            </div>
            <div class="menu-box">
                <div class="menu-row"><span>–¢–ï–ú–ê: CLASSIC</span><button class="win-btn" onclick="gui.setT('classic')">SET</button></div>
                <div class="menu-row"><span>–¢–ï–ú–ê: MATRIX</span><button class="win-btn" onclick="gui.setT('matrix')">SET</button></div>
                <div class="menu-row"><span>–¢–ï–ú–ê: NEON</span><button class="win-btn" onclick="gui.setT('neon')">SET</button></div>
                <div class="menu-row"><span>–ó–í–£–ö (SFX)</span><input type="checkbox" checked onchange="engine.sfx = this.checked"></div>
                <div class="menu-row"><span>–í–ò–ë–†–ê–¶–ò–Ø</span><input type="checkbox" checked onchange="engine.vib = this.checked"></div>
                <div class="menu-row"><span>–≠–ö–°–¢–†–ï–ú–ê–õ–¨–ù–´–ô –†–ï–ñ–ò–ú</span><input type="checkbox" onchange="engine.extreme = this.checked"></div>
            </div>
            <button class="btn" style="width:100%; margin-top:10px" onclick="gui.to('game')">–ü–†–ò–ú–ï–ù–ò–¢–¨</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const canvas = document.getElementById('main-canvas');
        const ctx = canvas.getContext('2d');

        const sound = {
            ctx: null,
            play(f, d, t = 'square', v = 0.1) {
                if(!engine.sfx) return;
                if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                const o = this.ctx.createOscillator(), g = this.ctx.createGain();
                o.type = t; 
                o.frequency.setValueAtTime(f, this.ctx.currentTime);
                if(t === 'sawtooth') {
                    o.frequency.exponentialRampToValueAtTime(f * 0.5, this.ctx.currentTime + d);
                }
                g.gain.setValueAtTime(v, this.ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.0001, this.ctx.currentTime + d);
                o.connect(g); g.connect(this.ctx.destination);
                o.start(); o.stop(this.ctx.currentTime + d);
            },
            combo(n) {
                const base = 440;
                for(let i = 0; i < n; i++) {
                    setTimeout(() => this.play(base * (1 + i * 0.2), 0.1, 'sine', 0.15), i * 50);
                }
            }
        };

        const gui = {
            to(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('scr-' + id).classList.add('active');
                if(engine.vib && tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
            },
            setT(t) { 
                document.body.className = 'theme-' + t; 
                engine.logAI(`–¢–ï–ú–ê –ò–ó–ú–ï–ù–ï–ù–ê: ${t.toUpperCase()}`);
                this.to('game'); 
            },
            notify(title, text) {
                const n = document.getElementById('notification');
                n.querySelector('div').textContent = title;
                document.getElementById('notif-text').textContent = text;
                n.classList.add('show');
                setTimeout(() => n.classList.remove('show'), 3000);
            }
        };

        class Particle {
            constructor(x, y, c, type = 'normal') {
                this.x = x; this.y = y;
                this.type = type;
                this.vx = (Math.random() - 0.5) * (type === 'explosion' ? 20 : 12);
                this.vy = (Math.random() - 0.5) * (type === 'explosion' ? 20 : 12);
                this.life = 1.0; this.c = c;
                this.size = type === 'explosion' ? 6 : 4;
            }
            update() { 
                this.x += this.vx; this.y += this.vy; 
                this.vy += 0.3; this.life -= 0.02; 
                this.size *= 0.98;
            }
            draw(ctx) {
                ctx.globalAlpha = Math.max(0, this.life); 
                ctx.fillStyle = this.c;
                ctx.shadowBlur = 10; ctx.shadowColor = this.c;
                ctx.fillRect(this.x, this.y, this.size, this.size); 
                ctx.shadowBlur = 0; ctx.globalAlpha = 1;
            }
        }

        const engine = {
            grid: 10, cell: 38, xp: 0, traps: [], open: [], dead: false, parts: [],
            sfx: true, vib: true, extreme: false, startT: 0, combo: 0, lastClick: 0,
            shield: false, frozen: false, frozenTime: 0,
            quest: { name: '', target: 0, current: 0, reward: 0, type: '' },
            trade: { partner: null, myItem: null, partnerItem: null },
            inventory: { shield: 0, freeze: 0 },

            init() {
                if(tg.expand) tg.expand();
                canvas.width = canvas.height = 380;
                this.cell = 380 / this.grid;
                this.generateQuest();
                this.reset();
                this.loop();
            },

            generateQuest() {
                const quests = [
                    { name: '–û—Ç–∫—Ä–æ–π 20 —è—á–µ–µ–∫', target: 20, reward: 500, type: 'open' },
                    { name: '–ù–∞–±–µ—Ä–∏ –∫–æ–º–±–æ x5', target: 5, reward: 300, type: 'combo' },
                    { name: '–ü—Ä–æ–∂–∏–≤–∏ 60 —Å–µ–∫—É–Ω–¥', target: 60, reward: 400, type: 'time' },
                    { name: '–ù–∞–±–µ—Ä–∏ 1000 XP', target: 1000, reward: 600, type: 'xp' }
                ];
                const q = quests[Math.floor(Math.random() * quests.length)];
                this.quest = { ...q, current: 0 };
                document.getElementById('quest-name').textContent = q.name;
                document.getElementById('quest-target').textContent = q.target;
                document.getElementById('quest-reward').textContent = q.reward + ' XP';
                this.updateQuestBar();
            },

            updateQuestBar() {
                const pct = Math.min(100, (this.quest.current / this.quest.target) * 100);
                document.getElementById('quest-bar').style.width = pct + '%';
                document.getElementById('quest-progress').textContent = this.quest.current;
                
                if(this.quest.current >= this.quest.target) {
                    this.xp += this.quest.reward;
                    document.getElementById('score-lcd').textContent = String(this.xp).padStart(4, '0');
                    document.getElementById('my-stat').textContent = this.xp;
                    gui.notify('–ó–ê–î–ê–ß–ê –í–´–ü–û–õ–ù–ï–ù–ê!', `+${this.quest.reward} XP`);
                    sound.play(880, 0.3, 'sine');
                    setTimeout(() => this.generateQuest(), 2000);
                }
            },

            reset() {
                this.dead = false; this.traps = []; this.open = []; this.parts = []; 
                this.startT = Date.now(); this.combo = 0; this.shield = false;
                document.getElementById('score-lcd').innerText = '0000';
                document.getElementById('face').innerText = 'üòé';
                document.getElementById('combo').classList.remove('show');
                for(let i=0; i<this.grid*this.grid; i++) {
                    const trapChance = this.extreme ? 0.25 : 0.16;
                    if(Math.random() < trapChance) this.traps.push(i);
                    this.open[i] = false;
                }
                this.logAI("–ö–í–ê–ù–¢–û–í–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø... OK.");
                sound.play(523, 0.2, 'sine');
            },

            loop() {
                this.draw();
                this.parts = this.parts.filter(p => p.life > 0);
                this.parts.forEach(p => { p.update(); p.draw(ctx); });
                if(!this.frozen) {
                    this.updateClock();
                    this.checkQuestTime();
                }
                requestAnimationFrame(() => this.loop());
            },

            checkQuestTime() {
                if(this.quest.type === 'time' && !this.dead) {
                    const elapsed = Math.floor((Date.now() - this.startT) / 1000);
                    this.quest.current = elapsed;
                    this.updateQuestBar();
                }
            },

            draw() {
                ctx.fillStyle = '#808080';
                ctx.fillRect(0,0, canvas.width, canvas.height);
                for(let i=0; i<this.grid*this.grid; i++) {
                    let x = (i % this.grid) * this.cell, y = Math.floor(i / this.grid) * this.cell;
                    if(!this.open[i]) {
                        this.drawBtn(x, y, this.cell, true);
                    } else {
                        const isTrap = this.traps.includes(i);
                        ctx.fillStyle = isTrap ? '#300' : '#d1d1d1';
                        ctx.fillRect(x,y,this.cell,this.cell);
                        ctx.strokeStyle = isTrap ? '#600' : '#666'; 
                        ctx.strokeRect(x,y,this.cell,this.cell);
                        if(isTrap) {
                            ctx.font = `${this.cell/1.5}px Arial`; 
                            ctx.fillText('üí£', x+this.cell/6, y+this.cell/1.3);
                            ctx.fillStyle = '#f00';
                            ctx.fillRect(x+2,y+2,4,4);
                            ctx.fillRect(x+this.cell-6,y+2,4,4);
                            ctx.fillRect(x+2,y+this.cell-6,4,4);
                            ctx.fillRect(x+this.cell-6,y+this.cell-6,4,4);
                        } else {
                            ctx.fillStyle = '#444'; 
                            ctx.font = 'bold 16px Arial'; 
                            ctx.fillText('‚Ä¢', x+this.cell/2.2, y+this.cell/1.6);
                        }
                    }
                }
            },

            drawBtn(x, y, s, up) {
                ctx.fillStyle = '#bdbdbd'; ctx.fillRect(x,y,s,s);
                ctx.strokeStyle = up ? '#fff' : '#808080';
                ctx.beginPath(); ctx.moveTo(x, y+s); ctx.lineTo(x, y); ctx.lineTo(x+s, y); ctx.stroke();
                ctx.strokeStyle = up ? '#808080' : '#fff';
                ctx.beginPath(); ctx.moveTo(x, y+s); ctx.lineTo(x+s, y+s); ctx.lineTo(x+s, y); ctx.stroke();
                if(this.extreme && Math.random() > 0.95) {
                    ctx.fillStyle = 'rgba(255,0,0,0.1)';
                    ctx.fillRect(x,y,s,s);
                }
            },

            buyGrid(n, cost) {
                if(this.xp < cost) {
                    this.logAI("–ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û –ö–†–ï–î–ò–¢–û–í!");
                    sound.play(150, 0.3, 'sawtooth');
                    return;
                }
                this.xp -= cost;
                this.grid = n; this.cell = 380 / n; 
                this.init(); gui.to('game');
                this.logAI(`–°–ï–¢–ö–ê ${n}x${n} –ê–ö–¢–ò–í–ò–†–û–í–ê–ù–ê.`);
                sound.play(880, 0.3, 'square');
            },

            buyShield() {
                if(this.xp < 200) return this.logAI("–ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û XP!");
                this.xp -= 200; 
                this.inventory.shield++;
                this.logAI("–©–ò–¢ –ö–£–ü–õ–ï–ù. –ò–°–ü–û–õ–¨–ó–£–ô –í –ò–ù–í–ï–ù–¢–ê–†–ï.");
                sound.play(660, 0.2, 'sine');
            },

            buyTime() {
                if(this.xp < 300) return this.logAI("–ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û XP!");
                this.xp -= 300; 
                this.inventory.freeze++;
                this.logAI("–ó–ê–ú–û–†–û–ó–ö–ê –ö–£–ü–õ–ï–ù–ê.");
                sound.play(1100, 0.5, 'sine');
            },

            openTrade(partner) {
                this.trade.partner = partner;
                document.getElementById('trade-partner').textContent = partner;
                document.getElementById('trade-panel').classList.add('show');
                
                const items = ['üõ°Ô∏è', '‚è±Ô∏è', 'üîã', 'üçÄ'];
                document.getElementById('partner-item').textContent = items[Math.floor(Math.random() * items.length)];
            },

            selectTradeItem() {
                const myItems = [];
                if(this.inventory.shield > 0) myItems.push('üõ°Ô∏è');
                if(this.inventory.freeze > 0) myItems.push('‚è±Ô∏è');
                
                if(myItems.length === 0) {
                    this.logAI("–ù–ï–¢ –ü–†–ï–î–ú–ï–¢–û–í –î–õ–Ø –û–ë–ú–ï–ù–ê!");
                    return;
                }
                
                this.trade.myItem = myItems[0];
                document.getElementById('my-item').textContent = this.trade.myItem;
            },

            confirmTrade() {
                if(!this.trade.myItem) {
                    this.logAI("–í–´–ë–ï–†–ò–¢–ï –ü–†–ï–î–ú–ï–¢!");
                    return;
                }
                
                if(this.trade.myItem === 'üõ°Ô∏è') this.inventory.shield--;
                if(this.trade.myItem === '‚è±Ô∏è') this.inventory.freeze--;
                
                const received = document.getElementById('partner-item').textContent;
                if(received === 'üõ°Ô∏è') this.inventory.shield++;
                if(received === '‚è±Ô∏è') this.inventory.freeze++;
                if(received === 'üîã') this.xp += 100;
                if(received === 'üçÄ') this.xp += 200;
                
                document.getElementById('score-lcd').textContent = String(this.xp).padStart(4, '0');
                document.getElementById('my-stat').textContent = this.xp;
                
                gui.notify('–û–ë–ú–ï–ù –£–°–ü–ï–®–ï–ù!', `–ü–æ–ª—É—á–µ–Ω–æ: ${received}`);
                this.closeTrade();
            },

            closeTrade() {
                document.getElementById('trade-panel').classList.remove('show');
                this.trade = { partner: null, myItem: null, partnerItem: null };
                document.getElementById('my-item').textContent = '?';
            },

            handleInput(e) {
                if(this.dead || this.frozen) return;
                const rect = canvas.getBoundingClientRect();
                const x = Math.floor((e.clientX - rect.left) / this.cell);
                const y = Math.floor((e.clientY - rect.top) / this.cell);
                const idx = y * this.grid + x;
                if(x < 0 || x >= this.grid || y < 0 || y >= this.grid) return;
                if(this.open[idx]) return;
                this.open[idx] = true;

                if(this.quest.type === 'open') {
                    this.quest.current++;
                    this.updateQuestBar();
                }

                const now = Date.now();
                if(now - this.lastClick < 1000) {
                    this.combo++;
                    document.getElementById('combo').innerText = `COMBO x${this.combo}`;
                    document.getElementById('combo').classList.add('show');
                    sound.combo(Math.min(this.combo, 5));
                    
                    if(this.quest.type === 'combo' && this.combo >= this.quest.target) {
                        this.quest.current = this.combo;
                        this.updateQuestBar();
                    }
                } else {
                    this.combo = 0;
                    document.getElementById('combo').classList.remove('show');
                }
                this.lastClick = now;

                const px = x * this.cell + this.cell/2;
                const py = y * this.cell + this.cell/2;

                if(this.traps.includes(idx)) {
                    if(this.shield) {
                        this.shield = false;
                        this.logAI("–©–ò–¢ –ü–û–ì–õ–û–©–Å–ù! –ú–ò–ù–ê –ù–ï–ô–¢–†–ê–õ–ò–ó–û–í–ê–ù–ê.");
                        sound.play(440, 0.4, 'sine');
                        for(let i=0; i<20; i++) this.parts.push(new Particle(px, py, '#0ff', 'shield'));
                    } else {
                        this.boom(px, py);
                    }
                } else {
                    const gain = (25 + Math.floor(this.xp / 1000)) * (1 + this.combo * 0.1);
                    this.xp += Math.floor(gain);
                    
                    if(this.quest.type === 'xp') {
                        this.quest.current = this.xp;
                        this.updateQuestBar();
                    }
                    
                    this.popXP(e.clientX, e.clientY, Math.floor(gain));
                    document.getElementById('score-lcd').innerText = String(this.xp).padStart(4, '0');
                    document.getElementById('my-stat').innerText = this.xp;
                    sound.play(400 + (this.xp % 1000), 0.1, 'sine');
                    if(this.vib && tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
                    for(let i=0; i<10; i++) this.parts.push(new Particle(px, py, '#0ff'));
                }
            },

            boom(x, y) {
                this.dead = true;
                document.getElementById('face').innerText = 'üòµ';
                this.traps.forEach(t => this.open[t] = true);
                sound.play(80, 0.8, 'sawtooth', 0.3);
                sound.play(60, 0.6, 'square', 0.2);
                if(this.vib && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
                this.logAI("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê. –û–ë–™–ï–ö–¢ –£–ù–ò–ß–¢–û–ñ–ï–ù.");
                for(let i=0; i<50; i++) this.parts.push(new Particle(x, y, '#f00', 'explosion'));
                if(tg.sendData) tg.sendData(JSON.stringify({action: 'game_over', score: this.xp}));
            },

            popXP(x, y, v) {
                const el = document.createElement('div');
                el.className = 'xp-pop'; el.innerText = `+${v}`;
                el.style.left = `${x}px`; el.style.top = `${y}px`;
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 1200);
            },

            logAI(m) {
                const log = document.getElementById('terminal');
                const time = new Date().toLocaleTimeString('ru-RU', {hour12: false});
                log.innerHTML = `> [${time}] ${m}<br>` + log.innerHTML.split('<br>').slice(0,3).join('<br>');
            },

            updateClock() {
                if(this.dead) return;
                const s = Math.floor((Date.now() - this.startT)/1000);
                document.getElementById('timer-lcd').innerText = `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
            },

            gigaHint() {
                if(this.xp < 150) {
                    this.logAI("–ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û XP –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê!");
                    sound.play(200, 0.3, 'sawtooth');
                    return;
                }
                this.xp -= 150;
                let safe = [];
                for(let i=0; i<this.grid*this.grid; i++) {
                    if(!this.open[i] && !this.traps.includes(i)) safe.push(i);
                }
                if(safe.length > 0) {
                    const hint = safe[Math.floor(Math.random() * safe.length)];
                    this.open[hint] = true;
                    const x = (hint % this.grid) * this.cell + this.cell/2;
                    const y = Math.floor(hint / this.grid) * this.cell + this.cell/2;
                    for(let i=0; i<15; i++) this.parts.push(new Particle(x, y, '#ff0'));
                    this.logAI("GIGACHAT: –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –Ø–ß–ï–ô–ö–ê –†–ê–°–ö–†–´–¢–ê.");
                    sound.play(660, 0.2, 'sine');
                }
            }
        };

        canvas.addEventListener('click', (e) => engine.handleInput(e));
        window.onload = () => engine.init();
    </script>
</body>
</html>
