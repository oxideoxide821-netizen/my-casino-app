<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Loot Clicker: ULTRA HD</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; }
        canvas { image-rendering: pixelated; image-rendering: crisp-edges; }
    </style>
</head>
<body>
<script>
// === ЗАГРУЗОЧНАЯ СЦЕНА ===
class BootScene extends Phaser.Scene {
    constructor() {
        super({ key: 'BootScene' });
    }
    
    preload() {
        this.load.spritesheet('icons', 'icons.png', { frameWidth: 64, frameHeight: 64 });
    }
    
    create() {
        // Фон загрузки
        this.cameras.main.setBackgroundColor('#0a0a0a');
        
        // Анимация загрузки
        let centerX = this.cameras.main.centerX;
        let centerY = this.cameras.main.centerY;
        
        // Вращающаяся монета
        let coin = this.add.image(centerX, centerY - 50, 'icons', 131);
        coin.setScale(4);
        
        this.tweens.add({
            targets: coin,
            scaleX: 0.2,
            duration: 400,
            yoyo: true,
            repeat: -1,
            ease: 'Sine.easeInOut',
            onYoyo: () => {
                coin.setFrame(coin.frame.name === 131 ? 43 : 131);
            }
        });
        
        // Текст загрузки
        let text = this.add.text(centerX, centerY + 50, 'ЗАГРУЗКА...', {
            fontSize: '32px',
            fontStyle: 'bold',
            fill: '#ffd700'
        }).setOrigin(0.5);
        
        // Полоса загрузки
        let barBg = this.add.rectangle(centerX, centerY + 100, 300, 20, 0x333333);
        let bar = this.add.rectangle(centerX - 150, centerY + 100, 0, 20, 0xffd700).setOrigin(0, 0.5);
        
        // Имитация загрузки
        this.tweens.add({
            targets: bar,
            width: 300,
            duration: 2000,
            ease: 'Power2',
            onComplete: () => {
                this.cameras.main.fade(500, 0, 0, 0);
                this.time.delayedCall(500, () => {
                    this.scene.start('GameScene');
                });
            }
        });
    }
}

// === ИГРОВАЯ СЦЕНА ===
class GameScene extends Phaser.Scene {
    constructor() {
        super({ key: 'GameScene' });
    }
    
    create() {
        // === HD ПОДЗЕМЕЛЬЕ 600x900 ===
        let bg = this.add.graphics();
        
        // Мраморный пол
        bg.fillGradientStyle(0x1a1a2e, 0x16213e, 0x0f0f23, 0x0a0a1a, 1);
        bg.fillRect(0, 0, 600, 900);
        
        // Вены
        for(let i=0; i<10; i++) {
            let x = Math.random() * 600;
            bg.lineStyle(3, 0x2a2a4e, 0.3);
            bg.beginPath();
            bg.moveTo(x, 0);
            for(let y=0; y<900; y+=30) {
                bg.lineTo(x + Math.sin(y*0.015)*40, y);
            }
            bg.strokePath();
        }
        
        // Ковер
        bg.fillStyle(0x4a0404, 0.7);
        bg.beginPath();
        bg.moveTo(180, 0);
        bg.lineTo(420, 0);
        bg.lineTo(480, 900);
        bg.lineTo(120, 900);
        bg.closePath();
        bg.fillPath();
        
        bg.lineStyle(4, 0xb8860b, 0.9);
        bg.beginPath();
        bg.moveTo(180, 0);
        bg.lineTo(120, 900);
        bg.strokePath();
        bg.beginPath();
        bg.moveTo(420, 0);
        bg.lineTo(480, 900);
        bg.strokePath();
        
        // Колонны
        for(let x of [45, 555]) {
            bg.fillStyle(0x2c2c2c, 1);
            bg.fillRect(x-35, 0, 70, 900);
            for(let y=120; y<900; y+=180) {
                bg.fillStyle(0xb8860b, 0.9);
                bg.fillRect(x-40, y, 80, 10);
            }
            bg.fillStyle(0x3d3d3d, 1);
            bg.fillRect(x-45, 0, 90, 50);
            bg.fillStyle(0xb8860b, 1);
            bg.fillRect(x-50, 45, 100, 12);
        }
        
        // Свечи с PNG иконками
        let candles = [[45, 60], [555, 60], [45, 840], [555, 840]];
        candles.forEach((pos, i) => {
            // Подсвечник из спрайта
            let holder = this.add.image(pos[0], pos[1]+30, 'icons', 108);
            holder.setScale(1.5);
            holder.setTint(0xb8860b);
            
            // Свеча
            let candle = this.add.image(pos[0], pos[1], 'icons', 109);
            candle.setScale(1.2);
            
            // Пламя (анимация)
            let flame = this.add.image(pos[0], pos[1]-25, 'icons', 110 + (i%3));
            flame.setScale(1.3);
            flame.setTint(0xffaa00);
            flame.setBlendMode('ADD');
            
            this.tweens.add({
                targets: flame,
                scale: 1.5,
                y: pos[1]-30,
                duration: 150,
                yoyo: true,
                repeat: -1
            });
        });
        
        // Туман
        for(let i=0; i<8; i++) {
            let mist = this.add.image(300 + (Math.random()-0.5)*300, 750, 'icons', 0);
            mist.setScale(8, 4);
            mist.setAlpha(0.06);
            mist.setTint(0xb8860b);
            mist.setBlendMode('ADD');
            this.tweens.add({
                targets: mist,
                x: '+=100',
                y: '-=80',
                alpha: 0,
                duration: 10000,
                repeat: -1,
                delay: i * 1200
            });
        }
        
        // Виньетка
        let vignette = this.add.graphics();
        for(let i=0; i<25; i++) {
            vignette.lineStyle(i*4, 0x0a0500, i*0.03);
            vignette.strokeRect(0, 0, 600, 900);
        }

        this.items = this.physics.add.group();
        
        // === HD UI ===
        // Книга золота
        let book = this.add.rectangle(150, 60, 260, 90, 0x4a0404);
        book.setStrokeStyle(5, 0xb8860b);
        book.setDepth(10);
        
        // Монета PNG
        this.coinIcon = this.add.image(50, 60, 'icons', 131);
        this.coinIcon.setScale(2);
        this.coinIcon.setDepth(15);
        
        this.tweens.add({
            targets: this.coinIcon,
            scaleX: 0.3,
            duration: 500,
            yoyo: true,
            repeat: -1,
            onYoyo: () => {
                this.coinIcon.setFrame(this.coinIcon.frame.name === 131 ? 43 : 131);
            }
        });
        
        // Объемный текст (5 слоев)
        this.scoreShadows = [];
        for(let i=4; i>0; i--) {
            let t = this.add.text(165 + i*3, 62 + i*3, '0', {
                fontSize: '52px',
                fontStyle: 'bold',
                fill: '#000000'
            }).setOrigin(0.5).setDepth(13).setAlpha(0.4);
            this.scoreShadows.push(t);
        }
        
        this.scoreText = this.add.text(165, 60, '0', {
            fontSize: '52px',
            fontStyle: 'bold',
            fill: '#ffd700',
            stroke: '#8b6914',
            strokeThickness: 3
        }).setOrigin(0.5).setDepth(14);
        
        // Герб комбо
        this.shield = this.add.ellipse(300, 150, 160, 110, 0x2c2c2c, 0.95);
        this.shield.setStrokeStyle(4, 0xb8860b);
        this.shield.setDepth(19);
        this.shield.setAlpha(0);
        
        this.comboShadow = this.add.text(302, 152, '', {
            fontSize: '48px',
            fontStyle: 'bold',
            fill: '#000000'
        }).setOrigin(0.5).setAlpha(0).setDepth(20);
        
        this.comboText = this.add.text(300, 150, '', {
            fontSize: '48px',
            fontStyle: 'bold',
            fill: '#ffffff',
            stroke: '#000000',
            strokeThickness: 4
        }).setOrigin(0.5).setAlpha(0).setDepth(21);
        
        // Алтари магазина
        this.createAltar(100, 800, 'СИЛА', 'p1', 131, 0xc41e3a);
        this.createAltar(300, 800, 'СКОР', 'p2', 43, 0x0f52ba);
        this.createAltar(500, 800, 'УДАЧА', 'p3', 88, 0x50c878);
        
        // Спавнер
        this.time.addEvent({ delay: 1200, callback: this.spawn, callbackScope: this, loop: true });
        
        this.score = 0;
        this.combo = 0;
        this.missedItems = 0;
        this.lastClickTime = 0;
        this.shop = { click: 10, speed: 1200, prices: { p1: 100, p2: 300, p3: 1000 } };
    }
    
    createAltar(x, y, txt, type, iconFrame, color) {
        let container = this.add.container(x, y);
        container.setDepth(100);
        
        // Тень
        let shadow = this.add.ellipse(8, 20, 140, 100, 0x000000, 0.5);
        
        // Основание
        let base = this.add.ellipse(0, 15, 140, 100, 0x2a2a3e);
        base.setStrokeStyle(3, 0x4a4a5e);
        
        // Стол
        let top = this.add.ellipse(0, 0, 140, 100, 0x4a0404);
        top.setStrokeStyle(4, 0xb8860b);
        top.setInteractive();
        
        // PNG иконка предмета
        let icon = this.add.image(0, -20, 'icons', iconFrame);
        icon.setScale(1.8);
        
        // Анимация иконки
        this.tweens.add({
            targets: icon,
            y: -25,
            duration: 1500,
            yoyo: true,
            repeat: -1,
            ease: 'Sine.easeInOut'
        });
        
        // Название
        let label = this.add.text(0, 25, txt, {
            fontSize: '18px',
            fill: '#b8860b',
            fontStyle: 'bold'
        }).setOrigin(0.5);
        
        // Цена (объемная)
        let priceShadow = this.add.text(2, 47, this.shop.prices[type], {
            fontSize: '22px',
            fill: '#000000'
        }).setOrigin(0.5);
        
        let price = this.add.text(0, 45, this.shop.prices[type], {
            fontSize: '22px',
            fill: '#ffd700',
            stroke: '#4a0404',
            strokeThickness: 3
        }).setOrigin(0.5);
        
        container.add([shadow, base, top, icon, label, priceShadow, price]);
        
        top.on('pointerover', () => {
            this.tweens.add({ targets: container, y: y - 5, duration: 100 });
            top.setFillStyle(0x5a0505);
        });
        
        top.on('pointerout', () => {
            this.tweens.add({ targets: container, y: y, duration: 100 });
            top.setFillStyle(0x4a0404);
        });
        
        top.on('pointerdown', () => {
            this.tweens.add({
                targets: container,
                y: y + 3,
                duration: 50,
                yoyo: true,
                onComplete: () => {
                    if (this.score >= this.shop.prices[type]) {
                        this.score -= this.shop.prices[type];
                        if(type === 'p1') this.shop.click += 10;
                        if(type === 'p2') this.shop.speed = Math.max(200, this.shop.speed - 150);
                        if(type === 'p3') {}
                        this.shop.prices[type] = Math.floor(this.shop.prices[type] * 1.8);
                        price.setText(this.shop.prices[type]);
                        priceShadow.setText(this.shop.prices[type]);
                        this.updateScore();
                        
                        // Частицы
                        for(let i=0; i<15; i++) {
                            let p = this.add.image(x, y, 'icons', 131);
                            p.setScale(0.8);
                            p.setTint(0xffd700);
                            this.tweens.add({
                                targets: p,
                                x: x + (Math.random()-0.5)*150,
                                y: y - 150 - Math.random()*100,
                                scale: 0,
                                duration: 800,
                                onComplete: () => p.destroy()
                            });
                        }
                    } else {
                        this.cameras.main.shake(150, 0.015);
                    }
                }
            });
        });
    }
    
    spawn() {
        let x = Phaser.Math.Between(150, 450);
        // Разные PNG иконки для лута
        const lootFrames = [131, 43, 88, 91, 13, 127, 50, 55, 60];
        let frame = Phaser.Utils.Array.GetRandom(lootFrames);
        
        let item = this.items.create(x, -80, 'icons', frame);
        item.setInteractive();
        item.setScale(0);
        item.setVelocityY(Phaser.Math.Between(150, 280));
        item.setDepth(50);
        
        // Тень
        let shadow = this.add.ellipse(x, -50, 50, 18, 0x000000, 0.3);
        shadow.setDepth(49);
        item.shadow = shadow;
        
        // Появление
        this.tweens.add({
            targets: item,
            scale: 2.5,
            duration: 500,
            ease: 'Back.out',
            onUpdate: () => {
                if(item.active && shadow.active) {
                    shadow.x = item.x;
                    shadow.y = item.y + 45;
                    shadow.scaleX = item.scaleX * 0.5;
                    shadow.alpha = 0.3 * (item.scaleX / 2.5);
                }
            }
        });
        
        // Покачивание
        this.tweens.add({
            targets: item,
            x: '+=8',
            duration: 2500,
            yoyo: true,
            repeat: -1,
            ease: 'Sine.easeInOut'
        });
        
        item.on('pointerdown', () => {
            this.collect(item);
        });
    }
    
    collect(item) {
        let now = Date.now();
        let comboMult = (now - this.lastClickTime < 600) ? Math.min(5, Math.floor(++this.combo/2) + 1) : 1;
        this.lastClickTime = now;
        this.missedItems = 0;
        
        let gain = this.shop.click * comboMult;
        this.score += gain;
        
        if (item.shadow) {
            this.tweens.add({
                targets: item.shadow,
                alpha: 0,
                duration: 200,
                onComplete: () => item.shadow.destroy()
            });
        }
        
        // Взрыв PNG осколков
        for(let i=0; i<16; i++) {
            let shard = this.add.image(item.x, item.y, 'icons', item.frame.name);
            shard.setScale(1);
            let angle = (Math.PI * 2 / 16) * i;
            let dist = 80 + Math.random() * 60;
            
            this.tweens.add({
                targets: shard,
                x: item.x + Math.cos(angle) * dist,
                y: item.y + Math.sin(angle) * dist - 50,
                scale: 0,
                rotation: Math.random() * 6,
                duration: 700,
                ease: 'Power2',
                onComplete: () => shard.destroy()
            });
        }
        
        // Кольцо
        let ring = this.add.ellipse(item.x, item.y, 40, 15, 0xffd700, 0.5);
        ring.setStrokeStyle(3, 0xffffff);
        this.tweens.add({
            targets: ring,
            scaleX: 6,
            scaleY: 6,
            alpha: 0,
            duration: 600,
            onComplete: () => ring.destroy()
        });
        
        this.updateScore();
        
        // Комбо UI
        if (comboMult > 1) {
            let colors = ['#ff0000', '#ff8800', '#ffff00', '#00ff00', '#00ffff'];
            this.comboText.setFill(colors[comboMult-2]);
            this.comboText.setText('x' + comboMult);
            this.comboShadow.setText('x' + comboMult);
            
            this.shield.setAlpha(1);
            this.comboText.setAlpha(1);
            this.comboShadow.setAlpha(1);
            this.comboText.setScale(1.5);
            this.comboShadow.setScale(1.5);
            
            this.tweens.add({
                targets: [this.comboText, this.comboShadow],
                scale: 1,
                duration: 200,
                ease: 'Back.out'
            });
            
            if (this.comboTimer) clearTimeout(this.comboTimer);
            this.comboTimer = setTimeout(() => {
                this.tweens.add({
                    targets: [this.shield, this.comboText, this.comboShadow],
                    alpha: 0,
                    duration: 300
                });
                this.combo = 0;
            }, 1800);
        }
        
        // Текст золота (5 слоев)
        for(let i=4; i>=0; i--) {
            let t = this.add.text(item.x + i*2, item.y + i*2, '+' + gain, {
                fontSize: '42px',
                fontStyle: 'bold',
                fill: i === 0 ? '#ffd700' : '#000000',
                stroke: i === 0 ? '#000000' : null,
                strokeThickness: i === 0 ? 5 : 0
            }).setOrigin(0.5).setDepth(80-i).setAlpha(i===0?1:0.5);
            
            this.tweens.add({
                targets: t,
                y: item.y - 180,
                alpha: 0,
                duration: 1000,
                onComplete: () => t.destroy()
            });
        }
        
        this.tweens.add({
            targets: item,
            scaleX: 0.1,
            scaleY: 3,
            alpha: 0,
            duration: 250,
            onComplete: () => item.destroy()
        });
    }
    
    updateScore() {
        this.scoreText.setText(this.score);
        this.scoreShadows.forEach(t => t.setText(this.score));
        
        this.tweens.add({
            targets: [this.scoreText, ...this.scoreShadows],
            scale: 1.15,
            duration: 100,
            yoyo: true
        });
    }
    
    update() {
        this.items.children.iterate(i => {
            if (i) {
                if (i.shadow && i.shadow.active) {
                    i.shadow.x += (i.x - i.shadow.x) * 0.1;
                    i.shadow.y = i.y + 45;
                }
                
                if (i.y > 950) {
                    this.missedItems++;
                    let penalty = Math.min(this.score, Math.floor(this.shop.click * this.missedItems * 2));
                    this.score -= penalty;
                    
                    if (penalty > 0) {
                        let blood = this.add.text(i.x, 870, '-' + penalty, {
                            fontSize: '36px',
                            fontStyle: 'bold',
                            fill: '#8b0000',
                            stroke: '#000000',
                            strokeThickness: 4
                        }).setOrigin(0.5);
                        
                        this.tweens.add({
                            targets: blood,
                            y: 700,
                            alpha: 0,
                            duration: 1000,
                            onComplete: () => blood.destroy()
                        });
                        
                        this.updateScore();
                    }
                    
                    if (i.shadow) i.shadow.destroy();
                    i.destroy();
                    this.combo = 0;
                    this.shield.setAlpha(0);
                    this.comboText.setAlpha(0);
                    this.comboShadow.setAlpha(0);
                }
            }
        });
    }
}

// === КОНФИГ ===
const gameConfig = {
    type: Phaser.AUTO,
    width: 600,
    height: 900,
    backgroundColor: '#0a0a0a',
    pixelArt: true, // ЧЕТКИЕ ПИКСЕЛИ
    physics: { default: 'arcade' },
    scene: [BootScene, GameScene],
    scale: {
        mode: Phaser.Scale.FIT,
        autoCenter: Phaser.Scale.CENTER_BOTH
    }
};

const game = new Phaser.Game(gameConfig);
</script>
</body>
</html>
