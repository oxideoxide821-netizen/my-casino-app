<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON CODER PRO | VISION</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root { 
            --neon: #00ff88; 
            --neon-dim: rgba(0, 255, 136, 0.3);
            --bg: #020502; 
            --glass: rgba(0, 255, 136, 0.08);
            --danger: #ff4444;
            --surface: #0a0f0a;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); color: #e8f5e9; overflow: hidden; }
        #canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .app { display: flex; flex-direction: column; width: 100vw; height: 100vh; }
        
        .header { 
            padding: 16px 20px; 
            background: linear-gradient(180deg, rgba(0,0,0,0.95) 0%, rgba(0,20,10,0.9) 100%);
            border-bottom: 1px solid var(--neon-dim); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.15);
            z-index: 10; 
            flex-shrink: 0;
        }
        
        .header b { 
            color: var(--neon); 
            letter-spacing: 2px; 
            font-size: 15px;
            font-weight: 700;
            text-transform: uppercase;
            animation: neonPulse 2s ease-in-out infinite;
        }
        
        @keyframes neonPulse {
            0%, 100% { text-shadow: 0 0 10px var(--neon-dim); }
            50% { text-shadow: 0 0 20px var(--neon), 0 0 30px var(--neon); }
        }
        
        .energy { 
            background: linear-gradient(135deg, var(--neon) 0%, #00cc6a 100%);
            color: #000; 
            padding: 6px 14px; 
            border-radius: 20px; 
            font-weight: 800; 
            font-size: 11px;
            animation: energyGlow 3s ease-in-out infinite;
        }
        
        @keyframes energyGlow {
            0%, 100% { box-shadow: 0 0 15px rgba(0, 255, 136, 0.4); }
            50% { box-shadow: 0 0 25px rgba(0, 255, 136, 0.8); }
        }
        
        .energy.creator { 
            background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
            animation: creatorGlow 2s ease-in-out infinite;
        }
        
        @keyframes creatorGlow {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.9); }
        }

        #chat { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 16px; 
            scroll-behavior: smooth;
            background: linear-gradient(180deg, var(--bg) 0%, var(--surface) 100%);
        }
        
        .msg { 
            max-width: 82%; 
            padding: 14px 18px; 
            border-radius: 18px; 
            font-size: 14.5px; 
            line-height: 1.6; 
            animation: messageAppear 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        @keyframes messageAppear {
            0% { opacity: 0; transform: translateY(30px) scale(0.8); }
            70% { transform: translateY(-5px) scale(1.02); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .user { 
            background: linear-gradient(135deg, var(--neon) 0%, #00cc6a 100%);
            color: #001a0d; 
            align-self: flex-end; 
            font-weight: 600;
            border-bottom-right-radius: 4px;
            margin-left: 40px;
        }
        
        .ai { 
            background: var(--surface);
            border: 1px solid var(--glass);
            align-self: flex-start; 
            border-bottom-left-radius: 4px;
            color: #e0f2e9;
            margin-right: 40px;
        }
        
        .system { 
            background: rgba(255,68,68,0.08);
            border: 1px solid rgba(255,68,68,0.3);
            color: #ff8888; 
            align-self: center; 
            text-align: center;
            max-width: 90%;
            font-size: 13px;
        }
        
        .preview-img { 
            max-width: 100%; 
            border-radius: 12px; 
            margin-top: 8px; 
            border: 1px solid var(--neon-dim);
        }

        .photo-preview { 
            background: rgba(0,255,136,0.05); 
            border: 1px dashed var(--neon-dim); 
            border-radius: 12px; 
            padding: 12px; 
            margin-bottom: 12px; 
            position: relative;
        }
        
        .remove-photo { 
            position: absolute; 
            top: 8px; 
            right: 8px; 
            background: var(--danger); 
            color: white; 
            border: none; 
            width: 28px; 
            height: 28px; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .footer { 
            padding: 12px 16px 25px; 
            background: linear-gradient(0deg, rgba(0,0,0,0.98) 0%, rgba(0,10,5,0.95) 100%);
            border-top: 1px solid rgba(0,255,136,0.1);
            z-index: 100;
            flex-shrink: 0;
        }
        
        .input-area { 
            display: flex; 
            gap: 8px; 
            align-items: center;
        }
        
        .tool-btn { 
            background: transparent; 
            border: 1.5px solid var(--neon-dim); 
            border-radius: 14px; 
            width: 40px; 
            height: 40px; 
            color: var(--neon); 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.3s;
            flex-shrink: 0;
        }
        
        .tool-btn:hover {
            border-color: var(--neon);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
            transform: translateY(-2px);
        }
        
        .input-wrapper {
            flex: 1;
            position: relative;
        }
        
        #userInput { 
            width: 100%;
            height: 40px;
            background: rgba(255,255,255,0.03);
            border: 1.5px solid rgba(0,255,136,0.2);
            border-radius: 14px; 
            color: #fff; 
            padding: 0 12px;
            outline: none; 
            font-size: 15px;
        }
        
        #userInput:focus {
            border-color: var(--neon);
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
        }
        
        #userInput::placeholder {
            color: rgba(255, 255, 255, 0.4);
            font-size: 15px;
        }
        
        .send-btn { 
            background: linear-gradient(135deg, var(--neon) 0%, #00cc6a 100%);
            border: none; 
            border-radius: 14px; 
            width: 40px; 
            height: 40px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
            flex-shrink: 0;
        }

        pre { 
            background: #0d1117 !important; 
            border-radius: 12px; 
            padding: 16px; 
            overflow-x: auto; 
            border: 1px solid rgba(0,255,136,0.15);
            position: relative; 
            margin: 12px 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            padding-top: 50px;
        }
        
        .code-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
        }
        
        .copy-btn, .copy-full-btn {
            padding: 6px 12px; 
            font-size: 11px; 
            font-weight: 700;
            border-radius: 6px; 
            cursor: pointer;
            border: none;
        }
        
        .copy-btn { 
            background: rgba(0,255,136,0.1);
            color: var(--neon);
            border: 1px solid var(--neon-dim);
        }
        
        .copy-full-btn {
            background: linear-gradient(135deg, var(--neon) 0%, #00cc6a 100%);
            color: #000;
        }

        .scroll-down-btn { 
            position: fixed; 
            bottom: 100px; 
            right: 20px; 
            width: 48px; 
            height: 48px; 
            background: linear-gradient(135deg, var(--neon) 0%, #00cc6a 100%);
            border: none; 
            border-radius: 50%; 
            color: #000; 
            cursor: pointer; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.4);
            z-index: 100; 
        }
        
        .scroll-down-btn.visible { display: flex; }

        .history-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 85%;
            max-width: 350px;
            height: 100%;
            background: linear-gradient(180deg, #0a0f0a 0%, #050805 100%);
            border-left: 2px solid var(--neon);
            z-index: 2000;
            transition: right 0.4s;
            display: flex;
            flex-direction: column;
        }
        
        .history-panel.open { right: 0; }
        
        .history-header {
            padding: 20px;
            border-bottom: 1px solid var(--neon-dim);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-title {
            color: var(--neon);
            font-size: 16px;
            font-weight: 700;
        }
        
        .history-close {
            background: none;
            border: none;
            color: var(--neon);
            font-size: 28px;
            cursor: pointer;
        }
        
        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        .history-item {
            background: rgba(0,255,136,0.05);
            border: 1px solid var(--neon-dim);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
            cursor: pointer;
        }
        
        .history-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
        }
        
        .history-overlay.show { display: block; }
        
        @media (max-width: 480px) {
            .input-area {
                gap: 6px;
            }
            .tool-btn, .send-btn {
                width: 36px;
                height: 36px;
            }
            #userInput {
                font-size: 16px;
                padding: 0 10px;
                height: 36px;
            }
            #userInput::placeholder {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
<canvas id="canvas"></canvas>

<div class="history-overlay" id="historyOverlay" onclick="closeHistory()"></div>

<div class="history-panel" id="historyPanel">
    <div class="history-header">
        <div class="history-title">üìú –ò–°–¢–û–†–ò–Ø</div>
        <button class="history-close" onclick="closeHistory()">√ó</button>
    </div>
    <div class="history-list" id="historyList"></div>
    <button class="tool-btn" onclick="clearHistory()" style="margin: 16px; width: calc(100% - 32px);">–û–ß–ò–°–¢–ò–¢–¨ –ò–°–¢–û–†–ò–Æ</button>
</div>

<button class="scroll-down-btn" id="scrollDownBtn" onclick="scrollToBottom()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>
</button>

<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleImage(this)">
<input type="file" id="galleryInput" accept="image/*" style="display:none" onchange="handleImage(this)">

<div class="app">
    <div class="header">
        <b>‚ö°Ô∏è NEON VISION PRO</b>
        <div style="display:flex;gap:10px;align-items:center;">
            <button class="tool-btn" onclick="openHistory()" style="width:36px;height:36px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10H12V2z"></path></svg>
            </button>
            <div class="energy" id="energy">–ó–ê–ì–†–£–ó–ö–ê...</div>
        </div>
    </div>
    <div id="chat">
        <div class="msg ai">–°–∏—Å—Ç–µ–º–∞ VISION –æ–Ω–ª–∞–π–Ω. üëÅÔ∏è<br><br>–Ø –≤–∏–∂—É –≤—Å—ë: –∫–æ–¥, –ø—Ä–∏–º–µ—Ä—ã, —Å—Ö–µ–º—ã. –ü—Ä–æ—Å—Ç–æ –ø—Ä–∏—à–ª–∏ —Ñ–æ—Ç–æ –∏–ª–∏ –Ω–∞–ø–∏—à–∏ –∑–∞–¥–∞—á—É!</div>
    </div>
    <div class="footer">
        <div id="photoPreview" class="photo-preview" style="display:none;">
            <button class="remove-photo" onclick="removePhoto()">√ó</button>
            <img id="previewImg" src="" alt="Preview" style="max-width:100%;border-radius:8px;">
        </div>
        
        <div class="input-area">
            <button class="tool-btn" onclick="openCamera()" type="button" title="–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
            </button>
            
            <button class="tool-btn" onclick="openGallery()" type="button" title="–í—ã–±—Ä–∞—Ç—å –∏–∑ –≥–∞–ª–µ—Ä–µ–∏">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
            </button>
            
            <button class="tool-btn" onclick="showRef()" type="button" title="–†–µ—Ñ–µ—Ä–∞–ª–∫–∞">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
            </button>
            
            <div class="input-wrapper">
                <input type="text" id="userInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="handleKey(event)">
            </div>
            
            <button class="send-btn" id="sendBtn" onclick="handleSend()" type="button">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"></path></svg>
            </button>
        </div>
    </div>
</div>

<script>
    const ADMIN_ID = 8371345434;
    let energy = localStorage.getItem('energy') ? parseInt(localStorage.getItem('energy')) : 8;
    let currentImageData = null;
    let editingMsgId = null;
    let isCreator = false;
    let currentUserId = null;
    
    let messageHistory = JSON.parse(localStorage.getItem('vision_history') || '[]');
    const MAX_HISTORY = 20;
    
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    function init() {
        currentUserId = tg.initDataUnsafe?.user?.id || tg.initDataUnsafe?.user_id;
        if (!currentUserId) currentUserId = parseInt(localStorage.getItem('test_user_id')) || null;
        isCreator = (currentUserId === ADMIN_ID);
        
        if (isCreator) { 
            energy = 9999; 
            document.getElementById('energy').innerText = "CREATOR";
            document.getElementById('energy').classList.add('creator');
        } else { 
            document.getElementById('energy').innerText = `‚ö° ${energy}`;
        }
        renderHistory();
    }
    setTimeout(init, 100);

    const c = document.getElementById('canvas'), x = c.getContext('2d');
    let ps = [];
    function rs() { c.width = innerWidth; c.height = innerHeight; }
    window.onresize = rs; rs();
    
    class Dust { 
        constructor() { this.init(); } 
        init() { 
            this.x = Math.random() * c.width; 
            this.y = Math.random() * -c.height; 
            this.size = Math.random() * 1.5; 
            this.speed = Math.random() * 1.5 + 0.5; 
            this.opacity = Math.random() * 0.6; 
        } 
        update() { 
            this.y += this.speed; 
            if (this.y > c.height) this.init(); 
        } 
        draw() { 
            x.fillStyle = `rgba(0, 255, 136, ${this.opacity})`; 
            x.beginPath(); 
            x.arc(this.x, this.y, this.size, 0, 7); 
            x.fill(); 
        } 
    }
    for(let i=0; i<60; i++) ps.push(new Dust());
    function loop() { 
        x.clearRect(0,0,c.width,c.height); 
        ps.forEach(p=>{p.update();p.draw();}); 
        requestAnimationFrame(loop); 
    }
    loop();

    function openHistory() {
        document.getElementById('historyPanel').classList.add('open');
        document.getElementById('historyOverlay').classList.add('show');
        renderHistory();
    }
    function closeHistory() {
        document.getElementById('historyPanel').classList.remove('open');
        document.getElementById('historyOverlay').classList.remove('show');
    }
    function renderHistory() {
        const list = document.getElementById('historyList');
        if (messageHistory.length === 0) {
            list.innerHTML = '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4);">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
            return;
        }
        list.innerHTML = messageHistory.slice().reverse().map((item, idx) => `
            <div class="history-item" onclick="loadFromHistory(${messageHistory.length - 1 - idx})">
                <div style="font-size:13px;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.text || '(–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)'}</div>
                <div style="font-size:11px;color:rgba(255,255,255,0.5);">${new Date(item.time).toLocaleString('ru-RU')}</div>
            </div>
        `).join('');
    }
    function loadFromHistory(index) {
        const item = messageHistory[index];
        if (item) {
            document.getElementById('userInput').value = item.text || '';
            document.getElementById('userInput').focus();
        }
        closeHistory();
    }
    function addToHistory(text, isUser = true) {
        messageHistory.push({ text: text, isUser: isUser, time: Date.now() });
        if (messageHistory.length > MAX_HISTORY) messageHistory = messageHistory.slice(-MAX_HISTORY);
        localStorage.setItem('vision_history', JSON.stringify(messageHistory));
    }
    function clearHistory() {
        if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?')) {
            messageHistory = [];
            localStorage.removeItem('vision_history');
            renderHistory();
        }
    }

    const chat = document.getElementById('chat');
    const scrollDownBtn = document.getElementById('scrollDownBtn');
    chat.addEventListener('scroll', () => {
        const isNearBottom = chat.scrollHeight - chat.scrollTop - chat.clientHeight < 150;
        scrollDownBtn.classList.toggle('visible', !isNearBottom);
    });
    function scrollToBottom() {
        chat.scrollTop = chat.scrollHeight;
    }
    function checkScroll() {
        const isNearBottom = chat.scrollHeight - chat.scrollTop - chat.clientHeight < 150;
        if (!isNearBottom) scrollDownBtn.classList.add('visible');
        else scrollDownBtn.classList.remove('visible');
    }

    function openCamera() {
        document.getElementById('cameraInput').click();
    }
    
    function openGallery() {
        document.getElementById('galleryInput').click();
    }

    function handleImage(input) {
        const file = input.files[0];
        if (!file) return;
        
        if (file.size > 10 * 1024 * 1024) {
            alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º 10MB');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            currentImageData = e.target.result;
            document.getElementById('previewImg').src = currentImageData;
            document.getElementById('photoPreview').style.display = 'block';
            document.getElementById('userInput').focus();
            setTimeout(() => {
                chat.scrollTop = chat.scrollHeight;
            }, 100);
        };
        reader.onerror = () => {
            alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
        };
        reader.readAsDataURL(file);
        input.value = '';
    }
    
    function removePhoto() {
        currentImageData = null;
        document.getElementById('photoPreview').style.display = 'none';
        document.getElementById('previewImg').src = '';
    }
    
    function handleKey(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            handleSend();
        }
    }

    function showRef() {
        const userId = currentUserId || 'guest';
        const refLink = `https://t.me/NeonVisionBot?start=${userId}`;
        
        const div = document.createElement('div');
        div.className = 'msg ai';
        div.innerHTML = `
            <div style="font-size:13px;opacity:0.8;margin-bottom:8px;">üîó –†–ï–§–ï–†–ê–õ–¨–ù–ê–Ø –°–ò–°–¢–ï–ú–ê</div>
            <div style="background:rgba(0,0,0,0.3);padding:12px;border-radius:8px;margin:12px 0;font-family:monospace;font-size:12px;word-break:break-all;">${refLink}</div>
            <div style="font-size:13px;margin-bottom:12px;"><span style="color:var(--neon);font-weight:700;">1 –¥—Ä—É–≥ = +3 –∑–∞—Ä—è–¥–∞</span></div>
            <button onclick="navigator.clipboard.writeText('${refLink}').then(()=>alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!'))" style="width:100%;background:var(--neon);color:#000;border:none;padding:10px;border-radius:8px;font-weight:700;cursor:pointer;">–ö–û–ü–ò–†–û–í–ê–¢–¨</button>
        `;
        chat.appendChild(div);
        checkScroll();
    }

    function generateId() {
        return 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function editMessage(msgId) {
        const msgEl = document.getElementById(msgId);
        if (!msgEl) return;
        const text = msgEl.getAttribute('data-text');
        const imgData = msgEl.getAttribute('data-img');
        
        document.getElementById('userInput').value = text;
        if (imgData) {
            currentImageData = imgData;
            document.getElementById('previewImg').src = imgData;
            document.getElementById('photoPreview').style.display = 'block';
        }
        editingMsgId = msgId;
        msgEl.style.border = '2px solid var(--neon)';
        document.getElementById('userInput').focus();
    }

    function deleteMessage(msgId) {
        const msgEl = document.getElementById(msgId);
        if (msgEl) {
            msgEl.remove();
            if (editingMsgId === msgId) cancelEdit();
        }
    }

    function cancelEdit() {
        if (editingMsgId) {
            const el = document.getElementById(editingMsgId);
            if (el) el.style.border = '';
            editingMsgId = null;
        }
        document.getElementById('userInput').value = '';
        removePhoto();
    }

    async function analyzeImageWithAI(imageBase64, userText) {
        try {
            const loadMsg = document.querySelector('.msg.ai:last-child');
            if (loadMsg) loadMsg.innerHTML = 'üì§ –ó–∞–≥—Ä—É–∂–∞—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...';
            
            const base64Data = imageBase64.split(',')[1];
            
            const formData = new FormData();
            formData.append('image', base64Data);
            
            const uploadRes = await fetch('https://api.imgur.com/3/image', {
                method: 'POST',
                headers: {
                    'Authorization': 'Client-ID 546c25a59c58ad7'
                },
                body: formData
            });
            
            const uploadData = await uploadRes.json();
            
            if (!uploadData.success) {
                throw new Error('Imgur upload failed: ' + uploadData.data?.error);
            }
            
            const imageUrl = uploadData.data.link;
            
            if (loadMsg) loadMsg.innerHTML = 'üëÅÔ∏è –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ...';
            
            const prompt = userText 
                ? `–ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${imageUrl}\n\n–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userText}\n\n–û—Ç–≤–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.`
                : `–û–ø–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω–æ —á—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–∞ —ç—Ç–æ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏: ${imageUrl}\n\n–û–ø–∏—à–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã, –¥–µ–π—Å—Ç–≤–∏—è, —Ü–≤–µ—Ç–∞, –∫–æ–Ω—Ç–µ–∫—Å—Ç. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.`;
            
            const response = await fetch("https://text.pollinations.ai", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    messages: [
                        { 
                            role: "system", 
                            content: "–¢—ã - –∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –¢—ã –ø–æ–ª—É—á–∞–µ—à—å URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –¥–æ–ª–∂–µ–Ω –¥–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—Å—ã–≤–∞—Ç—å —á—Ç–æ –Ω–∞ –Ω–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–æ. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ." 
                        },
                        { 
                            role: "user", 
                            content: prompt 
                        }
                    ],
                    model: "openai",
                    seed: Math.floor(Math.random() * 1000)
                })
            });
            
            if (!response.ok) {
                throw new Error('Pollinations API error: ' + response.status);
            }
            
            let result = await response.text();
            
            result = result.replace(/\{"role":"assistant","reasoning_content":".*?","tool_calls":\[\]\}/g, '');
            result = result.replace(/\{"role":"assistant","reasoning_content":".*?"\}/g, '');
            result = result.trim();
            
            if (!result || result.length < 10) {
                return fallbackImageAnalysis(imageBase64, userText);
            }
            
            return result;
            
        } catch (err) {
            console.error('Image analysis error:', err);
            return fallbackImageAnalysis(imageBase64, userText);
        }
    }

    async function fallbackImageAnalysis(imageBase64, userText) {
        const img = new Image();
        img.src = imageBase64;
        
        await new Promise((resolve, reject) => {
            img.onload = resolve;
            img.onerror = reject;
        });
        
        const width = img.width;
        const height = img.height;
        
        let orientation = '–∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ';
        if (width > height) orientation = '–∞–ª—å–±–æ–º–Ω–æ–µ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ)';
        if (height > width) orientation = '–ø–æ—Ä—Ç—Ä–µ—Ç–Ω–æ–µ (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ)';
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 50;
        canvas.height = 50;
        ctx.drawImage(img, 0, 0, 50, 50);
        
        const imageData = ctx.getImageData(0, 0, 50, 50);
        const data = imageData.data;
        
        let r = 0, g = 0, b = 0;
        for (let i = 0; i < data.length; i += 4) {
            r += data[i];
            g += data[i + 1];
            b += data[i + 2];
        }
        
        const pixelCount = data.length / 4;
        const avgR = Math.round(r / pixelCount);
        const avgG = Math.round(g / pixelCount);
        const avgB = Math.round(b / pixelCount);
        const avgBrightness = (avgR + avgG + avgB) / 3;
        
        let brightnessDesc = '—Å—Ä–µ–¥–Ω–µ–π —è—Ä–∫–æ—Å—Ç–∏';
        if (avgBrightness > 180) brightnessDesc = '–æ—á–µ–Ω—å —è—Ä–∫–æ–µ, —Å–≤–µ—Ç–ª–æ–µ';
        else if (avgBrightness < 70) brightnessDesc = '—Ç—ë–º–Ω–æ–µ, –Ω–∏–∑–∫–æ–π —è—Ä–∫–æ—Å—Ç–∏';
        
        let dominantColor = '';
        if (avgR > avgG && avgR > avgB) dominantColor = '–∫—Ä–∞—Å–Ω–æ–≤–∞—Ç—ã–µ/–æ—Ä–∞–Ω–∂–µ–≤—ã–µ —Ç–æ–Ω–∞';
        else if (avgG > avgR && avgG > avgB) dominantColor = '–∑–µ–ª—ë–Ω—ã–µ —Ç–æ–Ω–∞';
        else if (avgB > avgR && avgB > avgG) dominantColor = '—Å–∏–Ω–∏–µ/–≥–æ–ª—É–±—ã–µ —Ç–æ–Ω–∞';
        else if (avgR > 200 && avgG > 200 && avgB > 200) dominantColor = '–±–µ–ª—ã–µ/—Å–≤–µ—Ç–ª—ã–µ —Ç–æ–Ω–∞';
        else if (avgR < 50 && avgG < 50 && avgB < 50) dominantColor = '—á—ë—Ä–Ω—ã–µ/—Ç—ë–º–Ω—ã–µ —Ç–æ–Ω–∞';
        else dominantColor = '—Å–º–µ—à–∞–Ω–Ω—ã–µ/–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ —Ç–æ–Ω–∞';
        
        const type = detectImageType(width, height, avgBrightness, dominantColor);
        
        return `üîç **–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:**

üìê **–†–∞–∑–º–µ—Ä—ã:** ${width}√ó${height} –ø–∏–∫—Å–µ–ª–µ–π
üì± **–û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è:** ${orientation}
üí° **–Ø—Ä–∫–æ—Å—Ç—å:** ${brightnessDesc}
üåà **–î–æ–º–∏–Ω–∏—Ä—É—é—â–∏–µ —Ü–≤–µ—Ç–∞:** ${dominantColor}
üì¶ **–¢–∏–ø:** ${type}

${userText ? `‚ùì **–í–æ–ø—Ä–æ—Å:** ${userText}\n\n` : ''}‚ö†Ô∏è *–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ (–≤–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é). –î–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –æ–ø–∏—à–∏—Ç–µ —á—Ç–æ –≤—ã –≤–∏–¥–∏—Ç–µ –Ω–∞ —Ñ–æ—Ç–æ.*`;
    }

    function detectImageType(width, height, brightness, color) {
        if (width === height && width < 500) return '–∏–∫–æ–Ω–∫–∞ –∏–ª–∏ –∞–≤–∞—Ç–∞—Ä';
        if (width > 1000 && height > 1000 && brightness > 150) return '—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è (–≤–æ–∑–º–æ–∂–Ω–æ –ø–µ–π–∑–∞–∂ –∏–ª–∏ –ø–æ—Ä—Ç—Ä–µ—Ç)';
        if (brightness > 200) return '–¥–æ–∫—É–º–µ–Ω—Ç –∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å —Ç–µ–∫—Å—Ç–æ–º';
        if (brightness < 100) return '—Ç—ë–º–Ω—ã–π —Å–∫—Ä–∏–Ω—à–æ—Ç –∏–ª–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å';
        if (width > height * 2) return '–ø–∞–Ω–æ—Ä–∞–º–Ω–æ–µ —Ñ–æ—Ç–æ';
        if (height > width * 2) return '—Å—Ç–æ—Ä–∏—Å –∏–ª–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ';
        if (color.includes('–∑–µ–ª—ë–Ω—ã–µ')) return '—Ñ–æ—Ç–æ –ø—Ä–∏—Ä–æ–¥—ã –∏–ª–∏ –∑–µ–ª—ë–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å';
        if (color.includes('—Å–∏–Ω–∏–µ')) return '—Ñ–æ—Ç–æ –Ω–µ–±–∞/–≤–æ–¥—ã –∏–ª–∏ —Å–∏–Ω–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å';
        return '—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
    }

    async function handleSend() {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        const sendBtn = document.getElementById('sendBtn');
        
        if (!text && !currentImageData) return;
        
        if (!isCreator && energy <= 0) { 
            alert('–ó–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –∑–∞—Ä—è–¥—ã! –ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞.');
            return; 
        }

        if (editingMsgId) {
            const oldMsg = document.getElementById(editingMsgId);
            if (oldMsg) oldMsg.remove();
            editingMsgId = null;
        }

        const msgId = generateId();
        const userDiv = document.createElement('div');
        userDiv.className = 'msg user';
        userDiv.id = msgId;
        userDiv.setAttribute('data-text', text);
        if (currentImageData) userDiv.setAttribute('data-img', currentImageData);
        
        let content = '';
        if (text) content += text.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
        if (currentImageData) {
            content += (text ? '<br>' : '') + `<img src="${currentImageData}" class="preview-img">`;
        }
        
        userDiv.innerHTML = content + `
            <div class="msg-actions" style="position:absolute;top:-24px;right:0;display:none;gap:6px;">
                <button onclick="editMessage('${msgId}')" style="background:#333;border:1px solid var(--neon);color:var(--neon);padding:4px 10px;font-size:11px;border-radius:6px;cursor:pointer;">–ò–∑–º</button>
                <button onclick="deleteMessage('${msgId}')" style="background:#333;border:1px solid var(--neon);color:var(--neon);padding:4px 10px;font-size:11px;border-radius:6px;cursor:pointer;">–£–¥–ª</button>
            </div>
        `;
        userDiv.onmouseenter = () => userDiv.querySelector('.msg-actions').style.display = 'flex';
        userDiv.onmouseleave = () => userDiv.querySelector('.msg-actions').style.display = 'none';
        
        chat.appendChild(userDiv);
        addToHistory(text || '(–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)', true);
        
        input.value = '';
        
        const imgToSend = currentImageData;
        removePhoto();
        checkScroll();
        
        if (!isCreator) {
            energy--;
            document.getElementById('energy').innerText = `‚ö° ${energy}`;
            localStorage.setItem('energy', energy);
        }

        const load = document.createElement('div');
        load.className = 'msg ai';
        load.innerHTML = 'üëÅÔ∏è –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...';
        chat.appendChild(load);
        checkScroll();
        
        sendBtn.disabled = true;

        try {
            let resText;
            
            if (imgToSend) {
                resText = await analyzeImageWithAI(imgToSend, text);
            } else {
                const historyContext = messageHistory.slice(-6).map(h => ({
                    role: h.isUser ? 'user' : 'assistant',
                    content: h.text
                }));

                const response = await fetch("https://text.pollinations.ai", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        messages: [
                            { role: "system", content: "–¢—ã NEON VISION PRO ‚Äî —ç–∫—Å–ø–µ—Ä—Ç. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º. –§–æ—Ä–º–∞—Ç–∏—Ä—É–π –∫–æ–¥ –≤ ```." },
                            ...historyContext,
                            { role: "user", content: text }
                        ],
                        model: "openai"
                    })
                });
                resText = await response.text();
            }
            
            load.remove();
            
            resText = resText.replace(/\{"role":"assistant","reasoning_content":".*?","tool_calls":\[\]\}/g, '');
            resText = resText.replace(/\{"role":"assistant","reasoning_content":".*?"\}/g, '');
            
            if (!resText || resText.length < 5) {
                resText = "–ò–∑–≤–∏–Ω–∏, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ.";
            }

            const hasCode = resText.includes('```') || resText.includes('function') || resText.includes('def ');

            const formatted = resText
                .replace(/```(\w+)?([\s\S]*?)```/g, (m, l, code) => {
                    const lang = l || 'text';
                    if (hasCode) {
                        return `<pre><div class="code-buttons"><button class="copy-full-btn" onclick="copyFull(this)">–í–°–Å</button><button class="copy-btn" onclick="copyBlock(this)">–ë–õ–û–ö</button></div><code class="language-${lang}">${code.trim().replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre>`;
                    }
                    return `<pre><div class="code-buttons"><button class="copy-btn" onclick="copyBlock(this)">–ö–û–ü–ò–†–û–í–ê–¢–¨</button></div><code class="language-${lang}">${code.trim().replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre>`;
                })
                .replace(/\*\*(.*?)\*\*/g, '<b style="color:var(--neon);">$1</b>')
                .replace(/\n/g, '<br>');

            const aiDiv = document.createElement('div');
            aiDiv.className = 'msg ai';
            aiDiv.innerHTML = formatted;
            if (hasCode) aiDiv.setAttribute('data-full', resText);
            
            chat.appendChild(aiDiv);
            addToHistory(resText, false);
            checkScroll();

        } catch (e) { 
            console.error(e);
            load.innerHTML = "‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞<br><small>–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑</small>"; 
        } finally {
            sendBtn.disabled = false;
        }
    }

    function copyBlock(btn) {
        const code = btn.closest('.code-buttons').nextElementSibling.innerText;
        navigator.clipboard.writeText(code).then(() => { 
            btn.innerText = "‚úì"; 
            setTimeout(() => btn.innerText = "–ë–õ–û–ö", 2000); 
        });
    }

    function copyFull(btn) {
        const msgEl = btn.closest('.msg');
        const fullText = msgEl.getAttribute('data-full');
        if (fullText) {
            navigator.clipboard.writeText(fullText).then(() => {
                btn.innerText = "‚úì";
                setTimeout(() => btn.innerText = "–í–°–Å", 2000);
            });
        }
    }
</script>
</body>
</html>
