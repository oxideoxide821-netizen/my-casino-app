<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>ELITE DEB // NFT CASES</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #050810;
      --panel: #0b0f1a;
      --accent: #f97316;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --border-soft: #111827;
      --good: #22c55e;
      --bad: #ef4444;
      --rare: #3b82f6;
      --epic: #a855f7;
      --legend: #eab308;
      --myth: #f97316;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Roboto", sans-serif;
      background: radial-gradient(circle at top, #111827 0%, #020617 45%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .app {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 10px 10px 14px;
      gap: 8px;
    }
    .row {
      display: flex;
      gap: 8px;
    }
    .col {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .card {
      background: linear-gradient(145deg, #020617, #020617);
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      padding: 10px;
      box-shadow: 0 0 30px rgba(0,0,0,0.6);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .card-title {
      font-size: 13px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-soft);
    }
    .badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #020617;
      color: var(--text-soft);
    }
    .balance-main {
      font-size: 22px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .balance-main span {
      font-size: 14px;
      font-weight: 500;
      color: var(--accent);
    }
    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .pill {
      padding: 4px 8px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #111827;
      font-size: 11px;
      color: var(--text-soft);
    }
    .pill strong {
      color: var(--text-main);
    }
    .section-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-soft);
      margin-bottom: 4px;
    }
    .case-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px;
      margin-top: 6px;
    }
    .case-btn {
      position: relative;
      min-height: 60px;
      border-radius: 10px;
      padding: 5px 6px;
      border: 1px solid #111827;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
      overflow: hidden;
    }
    .case-btn span.name {
      font-weight: 600;
      line-height: 1.2;
    }
    .case-btn span.price {
      font-size: 10px;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .case-btn .rarity-tag {
      position: absolute;
      top: 4px;
      right: 4px;
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(3px);
      color: #f9fafb;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .rarity-common {
      border-color: #4b5563;
      background: linear-gradient(145deg, #020617, #020617);
    }
    .rarity-rare {
      border-color: rgba(59,130,246,0.7);
      background: radial-gradient(circle at top, rgba(59,130,246,0.18), #020617);
    }
    .rarity-epic {
      border-color: rgba(168,85,247,0.7);
      background: radial-gradient(circle at top, rgba(168,85,247,0.18), #020617);
    }
    .rarity-legendary {
      border-color: rgba(234,179,8,0.7);
      background: radial-gradient(circle at top, rgba(234,179,8,0.23), #020617);
    }
    .rarity-mythic {
      border-color: rgba(249,115,22,0.9);
      background: radial-gradient(circle at top, rgba(249,115,22,0.25), #020617);
    }
    /* –ê–Ω–∏–º–∞—Ü–∏—è –∫–µ–π—Å–∞ */
    .case-anim {
      margin-top: 6px;
      border-radius: 10px;
      padding: 6px 8px;
      background: linear-gradient(145deg, #020617, #000);
      border: 1px solid #111827;
      font-size: 11px;
    }
    .case-anim-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .case-anim-bar {
      position: relative;
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      border: 1px solid #111827;
    }
    .case-anim-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0;
      background: linear-gradient(to right, #22c55e, #eab308, #f97316);
      transition: width 0.18s linear;
    }
    .case-anim-text {
      margin-top: 3px;
      font-size: 10px;
      color: var(--text-soft);
    }
    /* NFT –±–ª–æ–∫ */
    .nft-slot-empty {
      font-size: 11px;
      color: var(--text-soft);
      border-radius: 10px;
      border: 1px dashed #1f2937;
      padding: 8px;
      text-align: center;
    }
    .nft-card {
      border-radius: 10px;
      padding: 8px;
      border: 1px solid #111827;
      background: radial-gradient(circle at top left, rgba(59,130,246,0.22), #020617);
      display: flex;
      gap: 8px;
    }
    .nft-circle {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 3px solid var(--rare);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 700;
      position: relative;
      overflow: hidden;
      background: #020617;
    }
    .nft-circle::before {
      content: "";
      position: absolute;
      inset: -20%;
      background: conic-gradient(
        from 180deg,
        rgba(59,130,246,0.4),
        rgba(168,85,247,0.5),
        rgba(234,179,8,0.5),
        rgba(249,115,22,0.5),
        rgba(59,130,246,0.4)
      );
      opacity: 0.0;
      transition: opacity 0.25s;
    }
    .nft-circle.upgrading::before {
      opacity: 0.9;
      animation: spin 1.4s linear infinite;
    }
    .nft-circle-inner {
      position: relative;
      z-index: 1;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .nft-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      font-size: 11px;
    }
    .nft-name {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .nft-rarity {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-soft);
    }
    .nft-meta {
      font-size: 10px;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
    }
    /* –∫–Ω–æ–ø–∫–∏ */
    .btn-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }
    .btn {
      flex: 1;
      border-radius: 999px;
      padding: 7px 10px;
      border: 1px solid #111827;
      background: #020617;
      color: var(--text-main);
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
    }
    .btn-ghost {
      background: transparent;
      color: var(--text-soft);
    }
    .btn-accent {
      background: linear-gradient(135deg, #f97316, #ea580c);
      border-color: #fb923c;
      color: #020617;
      box-shadow: 0 0 18px rgba(249,115,22,0.45);
    }
    .btn-danger {
      background: rgba(239,68,68,0.08);
      border-color: rgba(239,68,68,0.6);
      color: #fecaca;
    }
    .btn-small {
      padding: 4px 6px;
      font-size: 11px;
    }
    /* —Å–ø–∏—Å–æ–∫ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è */
    .inv-list {
      max-height: 120px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid #111827;
      padding: 4px;
      background: #020617;
      font-size: 11px;
    }
    .inv-item {
      padding: 3px 4px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
    }
    .inv-item:nth-child(odd) {
      background-color: rgba(15,23,42,0.7);
    }
    .inv-item span.label {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .inv-item span.tag {
      font-size: 9px;
      padding: 1px 5px;
      border-radius: 999px;
      border: 1px solid #1f2937;
    }
    /* –º–æ–¥—É—à–∫–∏ */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      backdrop-filter: blur(4px);
    }
    .modal {
      width: 100%;
      max-width: 380px;
      background: #020617;
      border-radius: 14px;
      border: 1px solid #111827;
      box-shadow: 0 20px 40px rgba(0,0,0,0.7);
      padding: 10px;
      font-size: 12px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .modal-title {
      font-size: 13px;
      font-weight: 600;
    }
    .modal-body {
      margin-top: 6px;
    }
    .modal-footer {
      margin-top: 8px;
      display: flex;
      gap: 6px;
    }
    /* –ª–∏–¥–µ—Ä—ã */
    .leader-list {
      max-height: 150px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid #111827;
      padding: 4px;
      background: #020617;
      font-size: 11px;
    }
    .leader-item {
      display: flex;
      justify-content: space-between;
      gap: 4px;
      padding: 3px 4px;
      border-radius: 6px;
    }
    .leader-item:nth-child(odd) {
      background: rgba(15,23,42,0.8);
    }
    .tag-balance {
      color: #bfdbfe;
    }
    .tag-inv {
      color: #facc15;
    }
  </style>
</head>
<body>
<div class="app">
  <div class="row">
    <div class="col" style="flex: 1.2">
      <!-- –ë–∞–ª–∞–Ω—Å / —Å—Ç–∞—Ç—É—Å -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">ELITE DEB</div>
          <div class="badge" id="eventLabel">üî• –û–≥–Ω–µ–Ω–Ω–∞—è –Ω–µ–¥–µ–ª—è</div>
        </div>
        <div class="balance-main">
          <span id="balanceValue">15 000</span>
          <span>ü™ô</span>
        </div>
        <div class="pill-row">
          <div class="pill">–ò–≥—Ä–æ–∫: <strong id="playerName">–ò–≥—Ä–æ–∫</strong></div>
          <div class="pill">@<span id="playerUser">user</span></div>
          <div class="pill">–†–∞–Ω–≥: <strong id="playerRank">–ù–æ–≤–∏—á–æ–∫</strong></div>
        </div>
      </div>

      <!-- –ö–ï–ô–°–´ -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">üé∞ –ö–µ–π—Å—ã</div>
          <div class="badge">CSS / –ª–æ–∫–∞–ª—å–Ω–æ</div>
        </div>
        <div class="section-label">–ü–∞–∫–µ—Ç—ã –∫–µ–π—Å–æ–≤</div>
        <div class="case-grid" id="caseGrid"></div>
        <div id="caseAnim" class="case-anim" style="display:none;">
          <div class="case-anim-header">
            <span id="caseAnimTitle">–û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–µ–π—Å...</span>
            <span id="caseAnimLock">üîí</span>
          </div>
          <div class="case-anim-bar">
            <div id="caseAnimFill" class="case-anim-fill"></div>
          </div>
          <div id="caseAnimText" class="case-anim-text">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è RNG...</div>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div class="col" style="flex: 1">
      <!-- NFT / –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">üéí NFT –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
          <div class="badge" id="invCountBadge">0 NFT</div>
        </div>
        <div id="activeNftSlot" class="nft-slot-empty">
          NFT —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —É–ª—É—á—à–µ–Ω–∏—è.<br>–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –û—Ç–∫—Ä–æ–π –ø–∞—Ä—É –∫–µ–π—Å–æ–≤!
        </div>
        <div class="btn-row">
          <button class="btn btn-ghost btn-small" id="btnShowInv">–°–ø–∏—Å–æ–∫ NFT</button>
          <button class="btn btn-ghost btn-small" id="btnCraft">‚öóÔ∏è –ö–†–ê–§–¢ 3‚Üí1</button>
        </div>
      </div>

      <!-- –£–ª—É—á—à–∏—Ç–µ–ª—å / –õ–∏–¥–µ—Ä—ã -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">‚ö° –£–ª—É—á—à–∏—Ç–µ–ª—å / –õ–∏–¥–µ—Ä—ã</div>
          <div class="badge">risk / skill</div>
        </div>
        <div class="btn-row">
          <button class="btn btn-ghost btn-small" id="btnUpgradePanel">üåÄ –£–ª—É—á—à–∞—Ç—å NFT</button>
          <button class="btn btn-ghost btn-small" id="btnLeaders">üèÜ –õ–∏–¥–µ—Ä—ã</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –Ω–∏–∑: –¥–æ–¥–µ–ø / –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
  <div class="row">
    <div class="col" style="flex: 1.3">
      <div class="card">
        <div class="card-header">
          <div class="card-title">üíé –ö–∞—Å—Å–∞ ELITE DEB</div>
          <div class="badge">NFT BATTLE</div>
        </div>
        <div class="section-label">–ü–∞–∫–µ—Ç—ã –º–æ–Ω–µ—Ç (–ª–æ–∫–∞–ª—å–Ω–æ)</div>
        <div class="btn-row">
          <button class="btn btn-ghost btn-small" data-pack="10k">Starter ¬∑ 10 000 ü™ô</button>
          <button class="btn btn-ghost btn-small" data-pack="50k">Grinder ¬∑ 50 000 ü™ô</button>
          <button class="btn btn-ghost btn-small" data-pack="250k">Whale ¬∑ 250 000 ü™ô</button>
        </div>
        <div style="margin-top:6px;font-size:11px;color:var(--text-soft);">
          –ü–∞–∫–µ—Ç: <span id="packLabel">–Ω–µ –≤—ã–±—Ä–∞–Ω</span>
        </div>
        <div class="btn-row" style="margin-top:8px;">
          <button class="btn btn-ghost" id="btnTopupFake">‚≠ê –§–µ–π–∫-–¥–æ–¥–µ–ø (–ª–æ–∫–∞–ª—å–Ω–æ)</button>
          <button class="btn btn-accent" id="btnTopupReal">–ü–û–ü–û–õ–ù–ò–¢–¨ (—Å–≤—è–∑—å —Å –±–æ—Ç–æ–º)</button>
        </div>
      </div>
    </div>
    <div class="col" style="flex: 0.9">
      <div class="card">
        <div class="card-header">
          <div class="card-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ / –í—ã—Ö–æ–¥</div>
          <div class="badge">–ª–æ–∫–∞–ª—å–Ω–æ</div>
        </div>
        <div class="btn-row">
          <button class="btn btn-ghost btn-small" id="btnTrade">üîÅ –û–±–º–µ–Ω NFT</button>
          <button class="btn btn-ghost btn-small" id="btnDaily">üìÜ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å</button>
        </div>
        <div class="btn-row" style="margin-top:8px;">
          <button class="btn btn-ghost">–í–∏–±—Ä–∞—Ü–∏—è</button>
          <button class="btn btn-ghost">–ó–≤—É–∫–∏</button>
          <button class="btn btn-danger" id="btnExit">‚ùå –í–´–ô–¢–ò</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª: –Ω–æ–≤—ã–π NFT -->
<div id="modalNewNftBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">‚ú® –ù–æ–≤—ã–π NFT-–¥—Ä–æ–ø</div>
      <button class="btn btn-ghost btn-small" id="closeNewNft">‚úï</button>
    </div>
    <div class="modal-body" id="modalNewNftBody"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" id="btnNewNftReject">‚ùå –û—Ç–∫–∞–∑–∞—Ç—å—Å—è</button>
      <button class="btn btn-accent" id="btnNewNftAccept">‚úÖ –í –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª: —Å–ø–∏—Å–æ–∫ NFT -->
<div id="modalInvBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">üéí –ú–æ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
      <button class="btn btn-ghost btn-small" id="closeInv">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="modalInvList" class="inv-list"></div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª: —É–ª—É—á—à–∏—Ç–µ–ª—å -->
<div id="modalUpgradeBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">‚ö° –£–ª—É—á—à–∏—Ç–µ–ª—å NFT</div>
      <button class="btn btn-ghost btn-small" id="closeUpgrade">‚úï</button>
    </div>
    <div class="modal-body" id="modalUpgradeBody"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost btn-small" id="btnSelectNftForUpgrade">üéØ –í—ã–±—Ä–∞—Ç—å NFT</button>
      <button class="btn btn-accent" id="btnDoUpgrade">üöÄ –£–õ–£–ß–®–ò–¢–¨</button>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª: –ª–∏–¥–µ—Ä—ã -->
<div id="modalLeadersBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">üèÜ –õ–∏–¥–µ—Ä—ã</div>
      <button class="btn btn-ghost btn-small" id="closeLeaders">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="section-label">–ü–æ –±–∞–ª–∞–Ω—Å—É</div>
      <div id="leadersBalance" class="leader-list"></div>
      <div class="section-label" style="margin-top:6px;">–ü–æ NFT-–∏–Ω–≤–µ–Ω—Ç–∞—Ä—é</div>
      <div id="leadersInv" class="leader-list"></div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª: –æ–±–º–µ–Ω -->
<div id="modalTradeBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">üîÅ –û–±–º–µ–Ω NFT</div>
      <button class="btn btn-ghost btn-small" id="closeTrade">‚úï</button>
    </div>
    <div class="modal-body" id="modalTradeBody"></div>
  </div>
</div>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.expand();
  }

  /* ====== —Å–æ—Å—Ç–æ—è–Ω–∏–µ ====== */
  let state = {
    player: {
      name: "–ò–≥—Ä–æ–∫",
      user: "user",
      rank: "–ù–æ–≤–∏—á–æ–∫",
      balance: 15000,
      totalCases: 0
    },
    eventHotWeek: true,
    nftInventory: [],
    activeNftId: null,
    pendingNft: null,
    selectedPack: null,
    lastDailyTs: 0,
    leaders: []  // [{user,balance,invValue}]
  };

  /* ====== —É—Ç–∏–ª–∏—Ç—ã ====== */
  function fmtNum(n) {
    return n.toLocaleString("ru-RU");
  }

  function rarityConfig(rarity) {
    switch (rarity) {
      case "COMMON": return { label: "COMMON", color: "#9ca3af" };
      case "RARE": return { label: "RARE", color: "#3b82f6" };
      case "EPIC": return { label: "EPIC", color: "#a855f7" };
      case "LEGENDARY": return { label: "LEGEND", color: "#eab308" };
      case "MYTHIC": return { label: "MYTHIC", color: "#f97316" };
      default: return { label: rarity, color: "#9ca3af" };
    }
  }

  function estimateNftValue(nft) {
    const baseByRarity = {
      COMMON: 2000,
      RARE: 8000,
      EPIC: 25000,
      LEGENDARY: 70000,
      MYTHIC: 200000
    };
    const base = baseByRarity[nft.rarity] || 1000;
    return base * (1 + nft.level * 0.25);
  }

  function updateHeader() {
    document.getElementById("balanceValue").textContent = fmtNum(state.player.balance);
    document.getElementById("playerName").textContent = state.player.name;
    document.getElementById("playerUser").textContent = state.player.user;
    document.getElementById("playerRank").textContent = state.player.rank;
    document.getElementById("invCountBadge").textContent = state.nftInventory.length + " NFT";
    document.getElementById("eventLabel").textContent = state.eventHotWeek ? "üî• –û–≥–Ω–µ–Ω–Ω–∞—è –Ω–µ–¥–µ–ª—è" : "–õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º";
  }

  /* ====== –∫–µ–π—Å—ã ====== */
  const CASE_TYPES = [
    {
      id: "budget",
      name: "–£–ª–∏—á–Ω—ã–π",
      rarity: "COMMON",
      price: 1000,
      desc: "–¥–µ—à—ë–≤—ã–π, –±—ã—Å—Ç—Ä—ã–π, –º–∞—Å—Å–æ–≤—ã–π",
      weights: { COMMON: 70, RARE: 20, EPIC: 8, LEGENDARY: 2, MYTHIC: 0 }
    },
    {
      id: "mid",
      name: "–ö—Ä–æ–≤–∞–≤—ã–π —Ä–∞—Å—Å–≤–µ—Ç",
      rarity: "RARE",
      price: 5000,
      desc: "–±–∞–ª–∞–Ω—Å —Ä–∏—Å–∫–∞ –∏ –Ω–∞–≥—Ä–∞–¥—ã",
      weights: { COMMON: 40, RARE: 30, EPIC: 20, LEGENDARY: 8, MYTHIC: 2 }
    },
    {
      id: "hot",
      name: "–õ–∞–≤–∞",
      rarity: "EPIC",
      price: 15000,
      desc: "–≥–æ—Ä—è—á–∏–π —à–∞–Ω—Å –Ω–∞ —ç–ø–∏–∫",
      weights: { COMMON: 25, RARE: 30, EPIC: 30, LEGENDARY: 10, MYTHIC: 5 }
    },
    {
      id: "royal",
      name: "–¢—Ä–æ–Ω —É–¥–∞—á–∏",
      rarity: "LEGENDARY",
      price: 50000,
      desc: "–∫–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π —Ä–∏—Å–∫",
      weights: { COMMON: 15, RARE: 25, EPIC: 30, LEGENDARY: 20, MYTHIC: 10 }
    },
    {
      id: "god",
      name: "–û–ª–∏–º–ø –±–æ–≥–æ–≤",
      rarity: "MYTHIC",
      price: 150000,
      desc: "—á–∏—Å—Ç—ã–π –∞–∑–∞—Ä—Ç",
      weights: { COMMON: 5, RARE: 15, EPIC: 30, LEGENDARY: 30, MYTHIC: 20 }
    },
    {
      id: "event",
      name: "–ò–≤–µ–Ω—Ç –í—É–ª–∫–∞–Ω",
      rarity: "MYTHIC",
      price: 300000,
      desc: "–∏–≤–µ–Ω—Ç–æ–≤—ã–π —É–ª—å—Ç—Ä–∞ —Ä–∏—Å–∫",
      weights: { COMMON: 0, RARE: 10, EPIC: 25, LEGENDARY: 35, MYTHIC: 30 }
    }
  ];

  function renderCases() {
    const grid = document.getElementById("caseGrid");
    grid.innerHTML = "";
    CASE_TYPES.forEach(ct => {
      const div = document.createElement("button");
      div.type = "button";
      div.className = "case-btn " + rarityCaseClass(ct.rarity);
      div.dataset.caseId = ct.id;

      const rarCfg = rarityConfig(ct.rarity);
      const name = document.createElement("span");
      name.className = "name";
      name.textContent = ct.name;

      const price = document.createElement("span");
      price.className = "price";
      price.innerHTML = `${fmtNum(ct.price)} ü™ô`;

      const tag = document.createElement("span");
      tag.className = "rarity-tag";
      tag.textContent = rarCfg.label;

      div.appendChild(name);
      div.appendChild(price);
      div.appendChild(tag);
      grid.appendChild(div);
    });
  }

  function rarityCaseClass(r) {
    switch (r) {
      case "COMMON": return "rarity-common";
      case "RARE": return "rarity-rare";
      case "EPIC": return "rarity-epic";
      case "LEGENDARY": return "rarity-legendary";
      case "MYTHIC": return "rarity-mythic";
      default: return "rarity-common";
    }
  }

  function randomRarity(weights) {
    const entries = Object.entries(weights);
    let total = 0;
    for (const [, w] of entries) total += w;
    let roll = Math.random() * total;
    for (const [rar, w] of entries) {
      if (roll < w) return rar;
      roll -= w;
    }
    return "COMMON";
  }

  function randomNftName(rarity) {
    const baseNames = {
      COMMON: ["Street Chip", "Rusty Core", "Old Drive"],
      RARE: ["Virus Core", "Neon Blade", "Midnight Node"],
      EPIC: ["Quantum Spike", "Ghost Kernel", "Stellar Mask"],
      LEGENDARY: ["Royal Matrix", "Emperor Key", "Crown Protocol"],
      MYTHIC: ["Omega Singularity", "Godlike Seed", "Chaos Script"]
    };
    const arr = baseNames[rarity] || baseNames["COMMON"];
    const base = arr[Math.floor(Math.random() * arr.length)];
    const num = String(Math.floor(Math.random() * 999) + 1).padStart(3, "0");
    return `${base} #${num}`;
  }

  function openCase(caseId) {
    const ct = CASE_TYPES.find(c => c.id === caseId);
    if (!ct) return;

    if (state.player.balance < ct.price) {
      if (tg) tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç –¥–ª—è —ç—Ç–æ–≥–æ –∫–µ–π—Å–∞");
      return;
    }

    state.player.balance -= ct.price;
    state.player.totalCases += 1;
    updateHeader();

    animateCaseOpening(ct);
  }

  function animateCaseOpening(ct) {
    const animBox = document.getElementById("caseAnim");
    const fill = document.getElementById("caseAnimFill");
    const label = document.getElementById("caseAnimText");
    const title = document.getElementById("caseAnimTitle");
    const lock = document.getElementById("caseAnimLock");
    animBox.style.display = "block";
    fill.style.width = "0%";
    label.textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ELITE RNG...";
    title.textContent = `–û—Ç–∫—Ä—ã–≤–∞–µ–º: ${ct.name}`;
    lock.textContent = "üîí";

    const steps = [
      { t: 0, text: "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ELITE RNG...", lock: "üîí" },
      { t: 1, text: "–°–∫–∞–Ω–∏—Ä—É—é —à–∞–Ω—Å—ã –∏ —Ç–≤–æ–π —Ñ–∞—Ä—Ç...", lock: "üîê" },
      { t: 2, text: "–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –±–∞—Ä–∞–±–∞–Ω—ã –∫—Ä—É—Ç—è—Ç—Å—è...", lock: "üåÄ" },
      { t: 3, text: "–ú–∞–∫—Å —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ —Ç–≤–æ—é —Å—Ç–∞–≤–∫—É...", lock: "üëÄ" },
      { t: 4, text: "–ì–æ—Ç–æ–≤–ª—é NFT-–¥—Ä–æ–ø...", lock: "üíΩ" }
    ];
    let progress = 0;
    let idx = 0;
    const interval = setInterval(() => {
      progress += 100 / (steps.length + 1);
      if (progress > 100) progress = 100;
      fill.style.width = progress + "%";
      if (idx < steps.length) {
        label.textContent = steps[idx].text;
        lock.textContent = steps[idx].lock;
        idx++;
      } else {
        clearInterval(interval);
        lock.textContent = "‚úÖ";
        label.textContent = "RNG –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω. –í—ã–ø–∞–¥–∞—ë—Ç –¥—Ä–æ–ø...";
        setTimeout(() => {
          animBox.style.display = "none";
          doCaseDrop(ct);
        }, 380);
      }
    }, 260);
  }

  function doCaseDrop(ct) {
    const rar = randomRarity(ct.weights);
    const name = randomNftName(rar);
    const id = "nft_" + Date.now() + "_" + Math.floor(Math.random() * 9999);
    const nft = {
      id,
      name,
      rarity: rar,
      level: 0,
      exp: 0
    };
    state.pendingNft = nft;
    showNewNftModal(nft);
    updateHeader();

    trySendDataToBot({
      action: "open_case",
      caseId: ct.id,
      rarity: rar,
      nftName: nft.name,
      price: ct.price
    });
  }

  /* ====== –º–æ–¥–∞–ª: –Ω–æ–≤—ã–π NFT ====== */
  function showNewNftModal(nft) {
    const modal = document.getElementById("modalNewNftBackdrop");
    const body = document.getElementById("modalNewNftBody");
    const rarCfg = rarityConfig(nft.rarity);

    body.innerHTML = `
      <div class="nft-card" style="border-color:${rarCfg.color};background:radial-gradient(circle at top,${rarCfg.color}1f,#020617);">
        <div class="nft-circle" style="border-color:${rarCfg.color};">
          <div class="nft-circle-inner">${shortRarityLetter(nft.rarity)}</div>
        </div>
        <div class="nft-info">
          <div class="nft-name">${nft.name}</div>
          <div class="nft-rarity" style="color:${rarCfg.color};">${rarCfg.label}</div>
          <div class="nft-meta">
            <span>LVL 0 ¬∑ EXP 0%</span>
            <span>~${fmtNum(estimateNftValue(nft))} ü™ô</span>
          </div>
        </div>
      </div>
      <div style="margin-top:6px;font-size:11px;color:var(--text-soft);">
        –ú–∞–∫—Å: "–†–µ–¥–∫–æ—Å—Ç—å —É–∂–µ –Ω–µ –æ—Ç–∫–∞—Ç–∏—à—å. –ò–ª–∏ –∑–∞–±–∏—Ä–∞–µ—à—å, –∏–ª–∏ –¥–µ–ª–∞–µ—à—å –≤–∏–¥, —á—Ç–æ —ç—Ç–æ –±–∞–≥."
      </div>
    `;
    modal.style.display = "flex";
  }

  function hideNewNftModal() {
    document.getElementById("modalNewNftBackdrop").style.display = "none";
  }

  function shortRarityLetter(r) {
    switch (r) {
      case "COMMON": return "C";
      case "RARE": return "R";
      case "EPIC": return "E";
      case "LEGENDARY": return "L";
      case "MYTHIC": return "M";
      default: return "?";
    }
  }

  /* ====== –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å ====== */
  function pushNftToInventory(nft) {
    state.nftInventory.push(nft);
    if (!state.activeNftId) {
      state.activeNftId = nft.id;
    }
    recalcRank();
    renderActiveNft();
    updateHeader();
  }

  function renderActiveNft() {
    const box = document.getElementById("activeNftSlot");
    if (!state.nftInventory.length) {
      box.className = "nft-slot-empty";
      box.innerHTML = "NFT —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —É–ª—É—á—à–µ–Ω–∏—è.<br>–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –û—Ç–∫—Ä–æ–π –ø–∞—Ä—É –∫–µ–π—Å–æ–≤!";
      return;
    }
    const nft = state.nftInventory.find(n => n.id === state.activeNftId) || state.nftInventory[0];
    state.activeNftId = nft.id;
    const rarCfg = rarityConfig(nft.rarity);

    box.className = "nft-card";
    box.style.borderColor = rarCfg.color;
    box.style.background = `radial-gradient(circle at top,${rarCfg.color}1f,#020617)`;
    box.innerHTML = `
      <div class="nft-circle" id="activeNftCircle" style="border-color:${rarCfg.color};">
        <div class="nft-circle-inner">${Math.round(nft.exp || 0)}%</div>
      </div>
      <div class="nft-info">
        <div class="nft-name">${nft.name}</div>
        <div class="nft-rarity" style="color:${rarCfg.color};">${rarCfg.label} ¬∑ LVL ${nft.level}</div>
        <div class="nft-meta">
          <span>~${fmtNum(estimateNftValue(nft))} ü™ô</span>
          <span>${state.nftInventory.length} NFT –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ</span>
        </div>
      </div>
    `;
  }

  function showInvModal() {
    const backdrop = document.getElementById("modalInvBackdrop");
    const list = document.getElementById("modalInvList");
    list.innerHTML = "";
    if (!state.nftInventory.length) {
      list.innerHTML = `<div style="padding:4px;color:var(--text-soft);">–ü—É—Å—Ç–æ. –ù–∞–∫—Ä—É—Ç–∏ –ø–∞—Ä—É –∫–µ–π—Å–æ–≤.</div>`;
    } else {
      state.nftInventory.forEach(nft => {
        const rarCfg = rarityConfig(nft.rarity);
        const row = document.createElement("div");
        row.className = "inv-item";
        row.innerHTML = `
          <span class="label">${nft.name}</span>
          <span class="tag" style="color:${rarCfg.color};border-color:${rarCfg.color}99;">${rarCfg.label}</span>
          <span class="tag">LVL ${nft.level}</span>
        `;
        row.addEventListener("click", () => {
          state.activeNftId = nft.id;
          renderActiveNft();
          backdrop.style.display = "none";
        });
        list.appendChild(row);
      });
    }
    backdrop.style.display = "flex";
  }

  function hideInvModal() {
    document.getElementById("modalInvBackdrop").style.display = "none";
  }

  /* ====== —É–ª—É—á—à–∏—Ç–µ–ª—å ====== */
  function showUpgradeModal() {
    const backdrop = document.getElementById("modalUpgradeBackdrop");
    const body = document.getElementById("modalUpgradeBody");
    if (!state.nftInventory.length) {
      body.innerHTML = `<div style="font-size:11px;color:var(--text-soft);">–£ —Ç–µ–±—è –Ω–µ—Ç NFT –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è. –ü–æ—Ä–∞ —Ä–∏—Å–∫–Ω—É—Ç—å –ø–∞—Ä–æ–π –∫–µ–π—Å–æ–≤.</div>`;
    } else {
      const nft = state.nftInventory.find(n => n.id === state.activeNftId) || state.nftInventory[0];
      const rarCfg = rarityConfig(nft.rarity);
      const cost = 5000 + nft.level * 4000;
      const loseRisk = 10 + nft.level * 7;
      body.innerHTML = `
        <div style="font-size:11px;color:var(--text-soft);margin-bottom:4px;">
          –ê–∫—Ç–∏–≤–Ω—ã–π NFT –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è:
        </div>
        <div class="nft-card" style="border-color:${rarCfg.color};background:radial-gradient(circle at top,${rarCfg.color}22,#020617);">
          <div class="nft-circle" id="upgradeCircle" style="border-color:${rarCfg.color};">
            <div class="nft-circle-inner">${Math.round(nft.exp || 0)}%</div>
          </div>
          <div class="nft-info">
            <div class="nft-name">${nft.name}</div>
            <div class="nft-rarity" style="color:${rarCfg.color};">${rarCfg.label} ¬∑ LVL ${nft.level}</div>
            <div class="nft-meta">
              <span>–°—Ç–æ–∏–º–æ—Å—Ç—å: ${fmtNum(cost)} ü™ô</span>
              <span>–†–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏: ${loseRisk}%</span>
            </div>
          </div>
        </div>
        <div style="font-size:11px;color:var(--text-soft);margin-top:6px;">
          –ú–∞–∫—Å: "–ï—Å–ª–∏ –≤—ã–∂–∏–≤–µ—Ç ‚Äî —Å—Ç–∞–Ω–µ—Ç –∂—ë—Å—Ç—á–µ. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –¥–µ–ª–∞–π –≤–∏–¥, —á—Ç–æ —Ç–∞–∫ –∏ –±—ã–ª–æ."
        </div>
      `;
    }
    backdrop.style.display = "flex";
  }

  function hideUpgradeModal() {
    document.getElementById("modalUpgradeBackdrop").style.display = "none";
  }

  function selectNftForUpgrade() {
    if (!state.nftInventory.length) {
      if (tg) tg.showAlert("–ù–µ—Ç NFT –¥–ª—è –≤—ã–±–æ—Ä–∞");
      return;
    }
    const listHtml = state.nftInventory.map(n => {
      const rarCfg = rarityConfig(n.rarity);
      return `<div class="inv-item" data-nft-id="${n.id}">
        <span class="label">${n.name}</span>
        <span class="tag" style="color:${rarCfg.color};border-color:${rarCfg.color}99;">${rarCfg.label}</span>
        <span class="tag">LVL ${n.level}</span>
      </div>`;
    }).join("");
    const body = document.getElementById("modalUpgradeBody");
    body.innerHTML = `
      <div style="font-size:11px;color:var(--text-soft);margin-bottom:4px;">
        –í—ã–±–µ—Ä–∏, —á—Ç–æ –±—É–¥–µ–º –º—É—á–∏—Ç—å:
      </div>
      <div class="inv-list" id="upgradeSelectList">${listHtml}</div>
    `;
    const list = document.getElementById("upgradeSelectList");
    Array.from(list.children).forEach(el => {
      el.addEventListener("click", () => {
        state.activeNftId = el.dataset.nftId;
        renderActiveNft();
        showUpgradeModal();
      });
    });
  }

  function doUpgrade() {
    if (!state.nftInventory.length) {
      if (tg) tg.showAlert("–ù–µ—Ç NFT, –Ω–µ—á–µ–≥–æ –∞–ø–∞—Ç—å");
      return;
    }
    const nft = state.nftInventory.find(n => n.id === state.activeNftId) || state.nftInventory[0];
    const cost = 5000 + nft.level * 4000;
    const loseRisk = 10 + nft.level * 7;
    if (state.player.balance < cost) {
      if (tg) tg.showAlert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç –Ω–∞ —É–ª—É—á—à–µ–Ω–∏–µ");
      return;
    }
    state.player.balance -= cost;
    const circle = document.getElementById("upgradeCircle") || document.getElementById("activeNftCircle");
    if (circle) circle.classList.add("upgrading");

    setTimeout(() => {
      const roll = Math.random() * 100;
      if (roll < loseRisk) {
        state.nftInventory = state.nftInventory.filter(n => n.id !== nft.id);
        state.activeNftId = state.nftInventory[0]?.id || null;
        if (tg) tg.showAlert("NFT —Å–≥–æ—Ä–µ–ª –≤ –æ–≥–Ω–µ –∞–ø–≥—Ä–µ–π–¥–∞");
      } else {
        nft.level += 1;
        nft.exp = Math.min(100, (nft.exp || 0) + 35);
        if (tg) tg.showAlert("–ê–ø–≥—Ä–µ–π–¥ –ø—Ä–æ—à—ë–ª! NFT —Å—Ç–∞–ª —Å–∏–ª—å–Ω–µ–µ");
      }
      if (circle) circle.classList.remove("upgrading");
      renderActiveNft();
      hideUpgradeModal();
      recalcRank();
      updateHeader();
    }, 1100);
  }

  /* ====== –∫—Ä–∞—Ñ—Ç 3‚Üí1 ====== */
  function doCraft() {
    if (state.nftInventory.length < 3) {
      if (tg) tg.showAlert("–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 NFT –¥–ª—è –∫—Ä–∞—Ñ—Ç–∞");
      return;
    }
    const removed = state.nftInventory.splice(0, 3);
    const raritiesOrder = ["COMMON","RARE","EPIC","LEGENDARY","MYTHIC"];
    let maxIdx = 0;
    removed.forEach(n => {
      const idx = raritiesOrder.indexOf(n.rarity);
      if (idx > maxIdx) maxIdx = idx;
    });
    const nextIdx = Math.min(raritiesOrder.length - 1, maxIdx + 1);
    const newRar = raritiesOrder[nextIdx];
    const nft = {
      id: "nft_" + Date.now() + "_" + Math.floor(Math.random() * 9999),
      name: randomNftName(newRar),
      rarity: newRar,
      level: 0,
      exp: 0
    };
    state.pendingNft = nft;
    showNewNftModal(nft);
    recalcRank();
    updateHeader();
  }

  /* ====== –ª–∏–¥–µ—Ä—ã ====== */
  function recalcRank() {
    const invValue = state.nftInventory.reduce((sum, n) => sum + estimateNftValue(n), 0);
    const bal = state.player.balance;
    const power = bal + invValue * 0.6;
    if (power > 1000000) state.player.rank = "–õ–µ–≥–µ–Ω–¥–∞ –∫–∞–∑–∏–Ω–æ";
    else if (power > 300000) state.player.rank = "–ë–æ—Å—Å –∞–∑–∞—Ä—Ç–∞";
    else if (power > 100000) state.player.rank = "–°–µ—Ä—å—ë–∑–Ω—ã–π —Å—Ç–∞–≤–æ—á–Ω–∏–∫";
    else state.player.rank = "–ù–æ–≤–∏—á–æ–∫";
    updateHeader();

    const userKey = state.player.user || "user";
    const current = state.leaders.find(l => l.user === userKey);
    const invScore = invValue;
    if (current) {
      current.balance = bal;
      current.invValue = invScore;
    } else {
      state.leaders.push({
        user: userKey,
        name: state.player.name,
        balance: bal,
        invValue: invScore
      });
    }
  }

  function showLeadersModal() {
    recalcRank();
    const back = document.getElementById("modalLeadersBackdrop");
    const balBox = document.getElementById("leadersBalance");
    const invBox = document.getElementById("leadersInv");

    const byBalance = [...state.leaders].sort((a,b)=>b.balance - a.balance).slice(0,10);
    const byInv = [...state.leaders].sort((a,b)=>b.invValue - a.invValue).slice(0,10);

    if (!byBalance.length) {
      balBox.innerHTML = `<div style="padding:4px;color:var(--text-soft);">–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –æ—Ç–º–µ—Ç–∏–ª—Å—è.</div>`;
      invBox.innerHTML = `<div style="padding:4px;color:var(--text-soft);">–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –æ—Ç–º–µ—Ç–∏–ª—Å—è.</div>`;
    } else {
      balBox.innerHTML = byBalance.map((u,i)=>`
        <div class="leader-item">
          <span>${i+1}. ${u.name} (@${u.user})</span>
          <span class="tag-balance">${fmtNum(u.balance)} ü™ô</span>
        </div>
      `).join("");
      invBox.innerHTML = byInv.map((u,i)=>`
        <div class="leader-item">
          <span>${i+1}. ${u.name} (@${u.user})</span>
          <span class="tag-inv">${fmtNum(Math.round(u.invValue))} ü™ô</span>
        </div>
      `).join("");
    }

    back.style.display = "flex";
  }

  function hideLeadersModal() {
    document.getElementById("modalLeadersBackdrop").style.display = "none";
  }

  /* ====== –æ–±–º–µ–Ω NFT ====== */
  function showTradeModal() {
    const back = document.getElementById("modalTradeBackdrop");
    const body = document.getElementById("modalTradeBody");
    let code = "";
    if (state.nftInventory.length) {
      const nft = state.nftInventory[0];
      code = btoa(JSON.stringify({
        type: "nft_trade",
        nft,
        from: state.player.user
      }));
    }
    body.innerHTML = `
      <div style="font-size:11px;color:var(--text-soft);">
        –ó–¥–µ—Å—å –ª–æ–∫–∞–ª—å–Ω—ã–π –æ–±–º–µ–Ω: —Ç—ã –∫–æ–ø–∏—Ä—É–µ—à—å –∫–æ–¥, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å –¥—Ä—É–≥—É, –æ–Ω –≤—Å—Ç–∞–≤–ª—è–µ—Ç —É —Å–µ–±—è.<br>
        –†–µ–∞–ª—å–Ω—ã–π –æ–±–º–µ–Ω —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –º–æ–∂–Ω–æ –ø–æ–≤–µ—Å–∏—Ç—å –Ω–∞ /trade.
      </div>
      <div style="margin-top:6px;font-size:11px;">
        <strong>–ö–æ–¥ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É (–ø–µ—Ä–≤—ã–π NFT –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ):</strong>
      </div>
      <textarea readonly style="width:100%;height:60px;margin-top:4px;background:#020617;color:#e5e7eb;border-radius:8px;border:1px solid #111827;font-size:10px;padding:4px;">${code || "–Ω–µ—Ç NFT –¥–ª—è –æ–±–º–µ–Ω–∞"}</textarea>
      <div style="margin-top:6px;font-size:11px;">
        <strong>–í—Å—Ç–∞–≤–∏—Ç—å –∫–æ–¥ –æ—Ç –¥—Ä—É–≥–∞:</strong>
      </div>
      <textarea id="tradeInput" style="width:100%;height:60px;margin-top:4px;background:#020617;color:#e5e7eb;border-radius:8px;border:1px solid #111827;font-size:10px;padding:4px;" placeholder="–í—Å—Ç–∞–≤—å —Å—é–¥–∞ trade-–∫–æ–¥..."></textarea>
      <div class="btn-row" style="margin-top:6px;">
        <button class="btn btn-ghost btn-small" id="btnTradeApply">–ü—Ä–∏–Ω—è—Ç—å NFT</button>
      </div>
    `;
    back.style.display = "flex";
    const btn = document.getElementById("btnTradeApply");
    btn.onclick = () => {
      const val = document.getElementById("tradeInput").value.trim();
      if (!val) return;
      try {
        const decoded = JSON.parse(atob(val));
        if (decoded.type === "nft_trade" && decoded.nft) {
          const existing = state.nftInventory.find(n => n.id === decoded.nft.id);
          if (!existing) {
            state.nftInventory.push(decoded.nft);
            state.activeNftId = decoded.nft.id;
            renderActiveNft();
            recalcRank();
            updateHeader();
            if (tg) tg.showAlert("NFT –ø—Ä–∏–Ω—è—Ç –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å");
          } else {
            if (tg) tg.showAlert("–¢–∞–∫–æ–π NFT —É–∂–µ –µ—Å—Ç—å");
          }
        }
      } catch (e) {
        if (tg) tg.showAlert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –æ–±–º–µ–Ω–∞");
      }
    };
  }

  function hideTradeModal() {
    document.getElementById("modalTradeBackdrop").style.display = "none";
  }

  /* ====== –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å ====== */
  function takeDaily() {
    const now = Date.now();
    if (now - state.lastDailyTs < 24 * 3600 * 1000) {
      if (tg) tg.showAlert("–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å —É–∂–µ –∑–∞–±—Ä–∞–Ω, –∂–¥–∏ –µ—â—ë –Ω–µ–º–Ω–æ–≥–æ");
      return;
    }
    const base = 5000;
    const bonus = state.eventHotWeek ? base * 2 : base;
    state.player.balance += bonus;
    state.lastDailyTs = now;
    if (tg) tg.showAlert(`–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å: +${fmtNum(bonus)} ü™ô`);
    updateHeader();
  }

  /* ====== –∫–∞—Å—Å–∞ / –¥–æ–¥–µ–ø ====== */
  function selectPack(packId) {
    state.selectedPack = packId;
    const label = document.getElementById("packLabel");
    if (!packId) {
      label.textContent = "–Ω–µ –≤—ã–±—Ä–∞–Ω";
      return;
    }
    const map = {
      "10k": "Starter ¬∑ 10 000 ü™ô",
      "50k": "Grinder ¬∑ 50 000 ü™ô",
      "250k": "Whale ¬∑ 250 000 ü™ô"
    };
    label.textContent = map[packId] || "–Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–π –ø–∞–∫–µ—Ç";
  }

  function fakeTopup() {
    if (!state.selectedPack) {
      if (tg) tg.showAlert("–í—ã–±–µ—Ä–∏ –ø–∞–∫–µ—Ç");
      return;
    }
    const map = { "10k": 10000, "50k": 50000, "250k": 250000 };
    const val = map[state.selectedPack] || 0;
    state.player.balance += val;
    updateHeader();
    if (tg) tg.showAlert(`–§–µ–π–∫-–¥–æ–¥–µ–ø –ª–æ–∫–∞–ª—å–Ω–æ: +${fmtNum(val)} ü™ô`);
  }

  function realTopup() {
    if (!state.selectedPack) {
      if (tg) tg.showAlert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –ø–∞–∫–µ—Ç");
      return;
    }
    const map = { "10k": 10000, "50k": 50000, "250k": 250000 };
    const val = map[state.selectedPack] || 0;
    trySendDataToBot({
      action: "topup_request",
      pack: state.selectedPack,
      amount: val
    });
    if (tg) tg.showAlert("–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±–æ—Ç—É");
  }

  function trySendDataToBot(payload) {
    if (!tg) return;
    try {
      tg.sendData(JSON.stringify(payload));
    } catch (e) {
      console.warn("sendData error", e);
    }
  }

  /* ====== –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è / —Å–æ–±—ã—Ç–∏—è ====== */
  function initPlayerFromTelegram() {
    if (!tg) return;
    const user = tg.initDataUnsafe?.user;
    if (user) {
      state.player.name = user.first_name || "–ò–≥—Ä–æ–∫";
      state.player.user = user.username || "user";
    }
  }

  function attachEvents() {
    document.getElementById("caseGrid").addEventListener("click", e => {
      const btn = e.target.closest(".case-btn");
      if (!btn) return;
      const cid = btn.dataset.caseId;
      openCase(cid);
    });

    document.getElementById("btnShowInv").onclick = showInvModal;
    document.getElementById("closeInv").onclick = hideInvModal;

    document.getElementById("btnUpgradePanel").onclick = showUpgradeModal;
    document.getElementById("closeUpgrade").onclick = hideUpgradeModal;
    document.getElementById("btnSelectNftForUpgrade").onclick = selectNftForUpgrade;
    document.getElementById("btnDoUpgrade").onclick = doUpgrade;

    document.getElementById("btnLeaders").onclick = showLeadersModal;
    document.getElementById("closeLeaders").onclick = hideLeadersModal;

    document.getElementById("btnCraft").onclick = doCraft;

    document.getElementById("btnNewNftReject").onclick = () => {
      state.pendingNft = null;
      hideNewNftModal();
    };
    document.getElementById("btnNewNftAccept").onclick = () => {
      if (state.pendingNft) {
        pushNftToInventory(state.pendingNft);
        state.pendingNft = null;
      }
      hideNewNftModal();
    };
    document.getElementById("closeNewNft").onclick = hideNewNftModal;

    document.getElementById("btnTopupFake").onclick = fakeTopup;
    document.getElementById("btnTopupReal").onclick = realTopup;

    document.querySelectorAll("[data-pack]").forEach(btn => {
      btn.onclick = () => {
        selectPack(btn.dataset.pack);
      };
    });

    document.getElementById("btnTrade").onclick = showTradeModal;
    document.getElementById("closeTrade").onclick = hideTradeModal;

    document.getElementById("btnDaily").onclick = takeDaily;

    document.getElementById("btnExit").onclick = () => {
      if (tg) tg.close();
    };
  }

  function init() {
    initPlayerFromTelegram();
    renderCases();
    renderActiveNft();
    recalcRank();
    updateHeader();
    attachEvents();
  }

  init();
</script>
</body>
                               </html>
