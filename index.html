<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>ELITE DEB // NFT BATTLE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-main: #020617;
      --bg-card: rgba(15,23,42,0.96);
      --bg-soft: rgba(15,23,42,0.8);
      --accent-gold: linear-gradient(135deg,#f59e0b,#fbbf24,#f59e0b);
      --accent-fire: linear-gradient(135deg,#ef4444,#f97316,#f59e0b);
      --text-primary: #e5e7eb;
      --text-secondary: #9ca3af;
      --border-soft: rgba(148,163,184,0.25);
      --glow-blue: rgba(59,130,246,0.6);
      --glow-gold: rgba(251,191,36,0.7);
      --shadow-main: 0 24px 48px rgba(0,0,0,0.85);
    }
    * { box-sizing:border-box;margin:0;padding:0; }
    body {
      font-family: -apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI',system-ui,sans-serif;
      background: radial-gradient(circle at top, #1f2937 0%, #020617 45%, #000 100%);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }
    body::before {
      content:'';
      position:fixed;
      inset:0;
      background:
        radial-gradient(circle at 10% 90%,rgba(59,130,246,0.25) 0%,transparent 55%),
        radial-gradient(circle at 90% 10%,rgba(168,85,247,0.25) 0%,transparent 55%),
        radial-gradient(circle at 50% 40%,rgba(251,191,36,0.18) 0%,transparent 55%);
      pointer-events:none;
      z-index:-1;
    }
    .app {
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    .main {
      flex:1;
      padding:12px;
      padding-bottom:80px;
      overflow-y:auto;
      scrollbar-width:none;
    }
    .main::-webkit-scrollbar{display:none;}
    .screen {
      display:none;
      min-height:100%;
      gap:16px;
    }
    .screen.active{display:flex;}
    .card {
      background:var(--bg-card);
      border-radius:18px;
      border:1px solid var(--border-soft);
      padding:14px 14px 16px;
      box-shadow:var(--shadow-main);
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:'';
      position:absolute;
      inset:-40%;
      background:linear-gradient(120deg,transparent 0%,rgba(255,255,255,0.04) 40%,transparent 70%);
      opacity:0;
      transform:translateX(-100%);
    }
    .card:hover::before{
      opacity:1;
      animation:cardShimmer 1.9s linear infinite;
    }
    @keyframes cardShimmer{
      0%{transform:translateX(-100%);}
      100%{transform:translateX(100%);}
    }
    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .card-title{
      font-size:15px;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.5);
      color:var(--text-secondary);
    }
    .grid-2{
      display:grid;
      grid-template-columns:1.15fr 0.85fr;
      gap:12px;
    }
    .grid-3{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:8px;
    }
    /* –ë–∞–ª–∞–Ω—Å */
    .balance-main{
      font-size:24px;
      font-weight:800;
      display:flex;
      align-items:baseline;
      gap:8px;
    }
    .balance-main span.unit{
      font-size:13px;
      font-weight:600;
      color:#f97316;
    }
    .sub-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
    }
    .chip{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.4);
      font-size:11px;
      color:var(--text-secondary);
      background:rgba(15,23,42,0.9);
    }
    /* –ö–µ–π—Å—ã */
    .case-list{
      margin-top:4px;
    }
    .case-card{
      position:relative;
      padding:10px 8px;
      border-radius:14px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.35);
      margin-bottom:6px;
      cursor:pointer;
      overflow:hidden;
      transition:all 0.2s;
    }
    .case-card:hover{
      transform:translateY(-2px);
      box-shadow:0 18px 32px rgba(0,0,0,0.7);
    }
    .case-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:2px;
    }
    .case-name{
      font-size:13px;
      font-weight:600;
    }
    .case-price{
      font-size:11px;
      color:var(--text-secondary);
      display:flex;
      align-items:center;
      gap:4px;
    }
    .case-desc{
      font-size:11px;
      color:var(--text-secondary);
      margin-top:2px;
    }
    .case-rarity-tag{
      position:absolute;
      right:6px;
      top:6px;
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      text-transform:uppercase;
      letter-spacing:0.08em;
    }
    .rarity-common{background:rgba(107,114,128,0.22);color:#9ca3af;}
    .rarity-rare{background:rgba(59,130,246,0.25);color:#60a5fa;}
    .rarity-epic{background:rgba(168,85,247,0.28);color:#e9d5ff;}
    .rarity-legendary{background:rgba(251,191,36,0.32);color:#fef3c7;}
    .rarity-mythic{background:rgba(248,113,113,0.35);color:#fee2e2;}
    /* –ê–Ω–∏–º–∞—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–µ–π—Å–∞ */
    .case-anim-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.96);
      backdrop-filter:blur(20px);
      z-index:90;
      display:none;
      align-items:center;
      justify-content:center;
    }
    .case-anim-overlay.active{display:flex;}
    .case-anim-box{
      width:min(360px,90vw);
      background:var(--bg-card);
      border-radius:22px;
      border:1px solid var(--border-soft);
      padding:16px;
      box-shadow:var(--shadow-main);
      text-align:center;
    }
    .case-anim-title{
      font-size:16px;
      font-weight:700;
      margin-bottom:6px;
    }
    .case-anim-status{
      font-size:12px;
      color:var(--text-secondary);
      margin-bottom:10px;
    }
    .case-anim-bar{
      height:10px;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.5);
      overflow:hidden;
      margin-bottom:10px;
    }
    .case-anim-fill{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,#22c55e,#eab308,#f97316);
      box-shadow:0 0 18px rgba(234,179,8,0.7);
      transition:width 0.14s cubic-bezier(0.68,-0.55,0.265,1.55);
      position:relative;
      overflow:hidden;
    }
    .case-anim-fill::after{
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,0.4) 50%,transparent 100%);
      animation:barShimmer 1.4s infinite;
    }
    @keyframes barShimmer{
      0%{transform:translateX(-100%);}
      100%{transform:translateX(100%);}
    }
    .case-anim-lock{
      font-size:24px;
      margin-bottom:10px;
    }
    .case-drop{
      margin-top:8px;
      padding:10px;
      border-radius:16px;
      border:1px solid rgba(251,191,36,0.6);
      background:rgba(15,23,42,0.95);
      font-size:13px;
      box-shadow:0 0 30px rgba(251,191,36,0.6);
    }
    /* NFT —ç–∫—Ä–∞–Ω */
    .nft-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .nft-main{
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:8px;
    }
    .nft-avatar{
      width:74px;
      height:74px;
      border-radius:20px;
      background:radial-gradient(circle at 0 0,#4f46e5,#0f172a);
      border:2px solid rgba(129,140,248,0.7);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:22px;
      font-weight:800;
      position:relative;
      overflow:hidden;
    }
    .nft-avatar::before{
      content:'';
      position:absolute;
      inset:-40%;
      background:conic-gradient(from 0deg,rgba(129,140,248,0.2),rgba(244,114,182,0.35),rgba(250,204,21,0.35),rgba(129,140,248,0.2));
      animation:nftSpin 3.2s linear infinite;
      mix-blend-mode:screen;
    }
    .nft-avatar-inner{
      position:relative;
      z-index:1;
      text-shadow:0 0 20px rgba(129,140,248,0.8);
    }
    @keyframes nftSpin{to{transform:rotate(360deg);}}
    .nft-info h3{margin:0;font-size:16px;}
    .nft-info-sub{
      font-size:11px;
      color:var(--text-secondary);
      margin-top:2px;
    }
    .nft-meta-row{
      display:flex;
      gap:10px;
      margin-top:6px;
      font-size:11px;
      color:var(--text-secondary);
    }
    .tag{
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      font-size:10px;
    }
    .nft-circle-meter{
      margin-top:8px;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
    }
    .circle-wrap{
      width:46px;
      height:46px;
      border-radius:999px;
      border:2px solid rgba(148,163,184,0.6);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:600;
      position:relative;
      overflow:hidden;
    }
    .circle-fill{
      position:absolute;
      inset:-10%;
      background:conic-gradient(#22c55e,#eab308,#f97316,#ef4444,#22c55e);
      transform:rotate(0deg);
      opacity:0;
    }
    .circle-inner{
      position:relative;
      z-index:1;
      background:#020617;
      border-radius:999px;
      padding:8px 10px;
    }
    .circle-wrap.upgrading .circle-fill{
      opacity:0.9;
      animation:circleSpin 1.4s linear infinite;
    }
    @keyframes circleSpin{to{transform:rotate(360deg);}}
    .nft-list{
      margin-top:10px;
      max-height:140px;
      overflow-y:auto;
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.4);
      background:rgba(15,23,42,0.9);
      font-size:11px;
    }
    .nft-row{
      padding:5px 8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
    }
    .nft-row:nth-child(odd){background:rgba(15,23,42,0.9);}
    .nft-row:nth-child(even){background:rgba(15,23,42,0.7);}
    .nft-row:hover{background:rgba(30,64,175,0.45);}
    /* –ú–∞–≥–∞–∑–∏–Ω */
    .pack-row{
      display:flex;
      gap:8px;
      margin-top:6px;
    }
    .pack{
      flex:1;
      padding:8px;
      border-radius:12px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.4);
      font-size:11px;
      cursor:pointer;
      transition:all 0.2s;
    }
    .pack.selected{
      border-color:rgba(251,191,36,0.9);
      box-shadow:0 0 24px rgba(251,191,36,0.6);
    }
    .pack h4{margin-bottom:2px;font-size:12px;}
    .pack-desc{color:var(--text-secondary);}
    /* –¢–æ–ø—ã */
    .leader-list{
      margin-top:6px;
      max-height:180px;
      overflow-y:auto;
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.4);
      background:rgba(15,23,42,0.9);
      font-size:11px;
    }
    .leader-row{
      padding:4px 8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .leader-row:nth-child(even){background:rgba(15,23,42,0.7);}
    .leader-score-balance{color:#bfdbfe;}
    .leader-score-inv{color:#facc15;}
    /* –Ω–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è */
    .bottom-nav{
      position:fixed;
      left:0;right:0;bottom:0;
      background:rgba(15,23,42,0.96);
      border-top:1px solid rgba(148,163,184,0.3);
      backdrop-filter:blur(18px);
      padding:4px 10px 10px;
      display:flex;
      gap:8px;
      z-index:20;
    }
    .nav-item{
      flex:1;
      text-align:center;
      padding:8px 4px 6px;
      border-radius:14px;
      font-size:11px;
      color:var(--text-secondary);
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:2px;
      transition:all 0.2s;
    }
    .nav-item-icon{font-size:18px;}
    .nav-item.active{
      background:var(--glow-blue);
      color:#020617;
      box-shadow:0 0 26px var(--glow-blue);
    }
    /* –æ–±—â–∏–µ –∫–Ω–æ–ø–∫–∏ */
    .btn{
      border:none;
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      transition:all 0.2s;
    }
    .btn-primary{
      background:var(--accent-gold);
      color:#0f172a;
      box-shadow:0 10px 25px rgba(251,191,36,0.6);
    }
    .btn-primary:hover{transform:translateY(-1px);}
    .btn-ghost{
      background:rgba(15,23,42,0.9);
      color:var(--text-secondary);
      border:1px solid rgba(148,163,184,0.5);
    }
    .btn-danger{
      background:rgba(239,68,68,0.2);
      color:#fecaca;
      border:1px solid rgba(239,68,68,0.6);
    }
    .btn-small{padding:6px 8px;font-size:11px;}
    /* –æ–±–º–µ–Ω */
    .textarea {
      width:100%;
      min-height:60px;
      background:rgba(15,23,42,0.9);
      border-radius:10px;
      border:1px solid rgba(148,163,184,0.5);
      color:var(--text-primary);
      font-size:11px;
      padding:6px;
      resize:vertical;
    }
    /* –∞–¥–∞–ø—Ç–∏–≤ */
    @media(min-width:768px){
      .main{padding:20px;padding-bottom:90px;max-width:960px;margin:0 auto;}
      .grid-3{grid-template-columns:repeat(4,1fr);}
      .bottom-nav{max-width:960px;left:50%;transform:translateX(-50%);}
    }
  </style>
</head>
<body>
<div class="app">
  <main class="main">
    <!-- –≠–ö–†–ê–ù –ö–ï–ô–°–û–í -->
    <section id="screen-cases" class="screen active">
      <div class="grid-2">
        <div class="card">
          <div class="card-header">
            <div class="card-title">üíé –ë–∞–ª–∞–Ω—Å</div>
            <div class="badge" id="badgeEvent">üî• –û–≥–Ω–µ–Ω–Ω–∞—è –Ω–µ–¥–µ–ª—è</div>
          </div>
          <div class="balance-main">
            <span id="balanceValue">15 000</span>
            <span class="unit">ü™ô</span>
          </div>
          <div class="sub-row">
            <div class="chip">–ò–≥—Ä–æ–∫: <span id="playerName">–ò–≥—Ä–æ–∫</span></div>
            <div class="chip">@<span id="playerUser">user</span></div>
            <div class="chip">–†–∞–Ω–≥: <span id="playerRank">–ù–æ–≤–∏—á–æ–∫</span></div>
          </div>
          <div class="sub-row" style="margin-top:6px;">
            <div class="chip">–í—Å–µ–≥–æ –∫–µ–π—Å–æ–≤: <span id="totalCases">0</span></div>
            <div class="chip">–õ—É—á—à–∏–π –¥—Ä–æ–ø: <span id="bestDrop">–Ω–µ—Ç</span></div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">üìÜ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å</div>
            <div class="badge">+ –∏–≤–µ–Ω—Ç —à–∞–Ω—Å</div>
          </div>
          <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">
            –†–∞–∑ –≤ 24 —á–∞—Å–∞ –ú–∞–∫—Å –≤—ã–¥–∞–µ—Ç –ø–æ–¥–∞—Ä–æ–∫. –í –∏–≤–µ–Ω—Ç ‚Äî x2.
          </div>
          <button id="btnDaily" class="btn btn-primary" style="width:100%;margin-bottom:6px;">–ó–∞–±—Ä–∞—Ç—å –±–æ–Ω—É—Å ü™ô</button>
          <button id="btnToggleEvent" class="btn btn-ghost btn-small" style="width:100%;">üî• –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∏–≤–µ–Ω—Ç (–ª–æ–∫–∞–ª—å–Ω–æ)</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="card-header">
          <div class="card-title">üé∞ –ö–µ–π—Å—ã</div>
          <div class="badge">100% –ª–æ–∫–∞–ª—å–Ω—ã–π RNG</div>
        </div>
        <div class="case-list" id="caseList"></div>
      </div>
    </section>

    <!-- –≠–ö–†–ê–ù NFT -->
    <section id="screen-nft" class="screen">
      <div class="card">
        <div class="card-header">
          <div class="card-title">üéí NFT –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
          <div class="badge"><span id="nftCount">0</span> NFT</div>
        </div>
        <div id="nftMainBlock">
          <div style="font-size:12px;color:var(--text-secondary);">
            –¢—É—Ç –±—É–¥—É—Ç NFT, –∫–æ–≥–¥–∞ —Ç—ã –Ω–∞—á–Ω–µ—à—å —Ö–æ–∑—è–π–Ω–∏—á–∞—Ç—å —Å –∫–µ–π—Å–∞–º–∏.
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">‚öóÔ∏è –ö—Ä–∞—Ñ—Ç –∏ —É–ª—É—á—à–µ–Ω–∏—è</div>
          <div class="badge">risk / reward</div>
        </div>
        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">
          –°–æ–±–µ—Ä–∏ 3 NFT –∏ —Å–∫—Ä–∞—Ñ—Ç–∏ –Ω–æ–≤—ã–π —Ä–∞–Ω–≥. –ò–ª–∏ —Ä–∏—Å–∫—É–π —á–µ—Ä–µ–∑ —É–ª—É—á—à–∏—Ç–µ–ª—å ‚Äî —à–∞–Ω—Å –≤—ã–∂–∏—Ç—å –Ω–µ –≤—Å–µ–≥–¥–∞ –Ω–∞ —Ç–≤–æ–µ–π —Å—Ç–æ—Ä–æ–Ω–µ.
        </div>
        <div class="sub-row">
          <button id="btnCraft" class="btn btn-ghost btn-small">‚öóÔ∏è –ö–†–ê–§–¢ 3‚Üí1</button>
          <button id="btnUpgrade" class="btn btn-ghost btn-small">‚ö° –£–õ–£–ß–®–ò–¢–ï–õ–¨</button>
        </div>
        <div style="margin-top:10px;font-size:11px;color:var(--text-secondary);">
          –ú–∞–∫—Å: "–Ø –∑–∞ –∞–ø–≥—Ä–µ–π–¥—ã. –ù–æ –µ—Å–ª–∏ —Å–≥–æ—Ä–∏—Ç ‚Äî –Ω–µ –Ω–æ–π, —Ç—ã —Å–∞–º –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É."
        </div>
      </div>
    </section>

    <!-- –≠–ö–†–ê–ù –ú–ê–ì–ê–ó–ò–ù -->
    <section id="screen-shop" class="screen">
      <div class="card">
        <div class="card-header">
          <div class="card-title">üíé –ö–∞—Å—Å–∞ ELITE DEB</div>
          <div class="badge">NFT BATTLE</div>
        </div>
        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:6px;">
          –í—ã–±–µ—Ä–∏ –ø–∞–∫–µ—Ç –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –¥–æ–¥–µ–ø–∞. –ü–æ—Ç–æ–º –º–æ–∂–Ω–æ –ø–æ–¥–≤—è–∑–∞—Ç—å —Å—é–¥–∞ —Ä–µ–∞–ª—å–Ω—ã–π –¥–æ–Ω–∞—Ç —á–µ—Ä–µ–∑ –±–æ—Ç–∞.
        </div>
        <div class="pack-row">
          <div class="pack" data-pack="10k">
            <h4>Starter</h4>
            <div class="pack-desc">–î–ª—è —Ä–∞–∑–≥–æ–Ω–∞ ¬∑ +10 000 ü™ô</div>
          </div>
          <div class="pack" data-pack="50k">
            <h4>Grinder</h4>
            <div class="pack-desc">–ö–µ–π—Å—ã 24/7 ¬∑ +50 000 ü™ô</div>
          </div>
        </div>
        <div class="pack-row" style="margin-top:8px;">
          <div class="pack" data-pack="250k">
            <h4>Whale</h4>
            <div class="pack-desc">NFT‚Äë–∏–º–ø–µ—Ä–∏—è ¬∑ +250 000 ü™ô</div>
          </div>
          <div class="pack" data-pack="1m">
            <h4>ELITE</h4>
            <div class="pack-desc">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–≥–æ–Ω ¬∑ +1 000 000 ü™ô</div>
          </div>
        </div>
        <div style="margin-top:10px;font-size:12px;">
          –¢–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä: <span id="packLabel" style="color:#fbbf24;">–Ω–µ –≤—ã–±—Ä–∞–Ω</span>
        </div>
        <div class="sub-row" style="margin-top:10px;">
          <button id="btnFakeTopup" class="btn btn-ghost" style="flex:1;">‚≠ê –§–µ–π–∫-–¥–æ–¥–µ–ø (–ª–æ–∫–∞–ª—å–Ω–æ)</button>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">üëë VIP-–∫–æ–Ω—Ç—Ä–∞–∫—Ç —Å –ú–∞–∫—Å–æ–º</div>
          <div class="badge">24 —á–∞—Å–∞</div>
        </div>
        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:6px;">
          –û—Å—Ç–∞–≤–ª—è–µ—à—å 10% –±–∞–ª–∞–Ω—Å–∞ –ú–∞–∫—Å—É ‚Äî –ø–æ–ª—É—á–∞–µ—à—å 24 —á–∞—Å–∞ –±–æ–Ω—É—Å–æ–≤: x1.2 –∫ –ø—Ä–æ–¥–∞–∂–µ NFT, –±–æ–ª—å—à–µ —à–∞–Ω—Å —ç–ø–∏–∫–∞ –∏ –≤—ã—à–µ.
        </div>
        <button id="btnVip" class="btn btn-primary" style="width:100%;">‚úíÔ∏è –ü–æ–¥–ø–∏—Å–∞—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç</button>
        <div id="vipStatus" style="margin-top:6px;font-size:11px;color:var(--text-secondary);">
          –ö–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω.
        </div>
      </div>
    </section>

    <!-- –≠–ö–†–ê–ù –¢–û–ü–´/–û–ë–ú–ï–ù -->
    <section id="screen-top" class="screen">
      <div class="card">
        <div class="card-header">
          <div class="card-title">üèÜ –õ–∏–¥–µ—Ä—ã (–ª–æ–∫–∞–ª—å–Ω–æ)</div>
          <div class="badge">–ø–æ –±–∞–ª–∞–Ω—Å—É –∏ NFT</div>
        </div>
        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:6px;">
          –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ª —Å–ª–∞–≤—ã. –ö–∞–∂–¥—ã–π —Ä–∞–∑, –∫–∞–∫ —Ç—ã –∑–∞—Ö–æ–¥–∏—à—å –≤ –º–∏–Ω–∏‚Äë–∞–ø, —Ç–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –æ—Å—Ç–∞—ë—Ç—Å—è.
        </div>
        <div style="font-size:11px;color:var(--text-secondary);margin-bottom:4px;">–ü–æ –±–∞–ª–∞–Ω—Å—É:</div>
        <div id="leadersBalance" class="leader-list"></div>
        <div style="font-size:11px;color:var(--text-secondary);margin:8px 0 4px;">–ü–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—é:</div>
        <div id="leadersInv" class="leader-list"></div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">üîÅ –û–±–º–µ–Ω NFT</div>
          <div class="badge">—á–µ—Ä–µ–∑ –∫–æ–¥</div>
        </div>
        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:6px;">
          –ì–µ–Ω–µ—Ä–∏—Ä—É–π –∫–æ–¥ –Ω–∞ NFT ‚Äî –ø–µ—Ä–µ—Å—ã–ª–∞–π –¥—Ä—É–≥—É. –û–Ω –≤—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–¥ —É —Å–µ–±—è –∏ –∑–∞–±–∏—Ä–∞–µ—Ç –ø—Ä–µ–¥–º–µ—Ç.
        </div>
        <div style="font-size:11px;margin-bottom:4px;">–ö–æ–¥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (–∞–∫—Ç–∏–≤–Ω—ã–π NFT):</div>
        <textarea id="tradeCodeOut" class="textarea" readonly>–Ω–µ—Ç NFT –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏</textarea>
        <div style="font-size:11px;margin-top:6px;">–í—Å—Ç–∞–≤–∏—Ç—å –∫–æ–¥ –æ—Ç –¥—Ä—É–≥–∞:</div>
        <textarea id="tradeCodeIn" class="textarea" placeholder="–í—Å—Ç–∞–≤—å —Å—é–¥–∞ –∫–æ–¥ –æ–±–º–µ–Ω–∞..."></textarea>
        <div class="sub-row" style="margin-top:8px;">
          <button id="btnGenTrade" class="btn btn-ghost btn-small">üéØ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
          <button id="btnApplyTrade" class="btn btn-primary btn-small">‚úÖ –ü—Ä–∏–Ω—è—Ç—å NFT</button>
        </div>
      </div>
    </section>

    <!-- –≠–ö–†–ê–ù –ù–ê–°–¢–†–û–ô–ö–ò -->
    <section id="screen-settings" class="screen">
      <div class="card">
        <div class="card-header">
          <div class="card-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
          <div class="badge">–ª–æ–∫–∞–ª—å–Ω–æ</div>
        </div>
        <div class="sub-row">
          <button id="btnVibration" class="btn btn-ghost btn-small">üì≥ –í–∏–±—Ä–∞—Ü–∏—è: –í–ö–õ</button>
          <button id="btnSound" class="btn btn-ghost btn-small">üîä –ó–≤—É–∫: –í–ö–õ</button>
        </div>
        <div style="margin-top:10px;font-size:12px;color:var(--text-secondary);">
          –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º storage –±—Ä–∞—É–∑–µ—Ä–∞ –≤–Ω—É—Ç—Ä–∏ Telegram, –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–æ–≤.
        </div>
        <button id="btnReset" class="btn btn-danger" style="margin-top:10px;width:100%;">üß® –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å (–ª–æ–∫–∞–ª—å–Ω–æ)</button>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">‚ùå –í—ã—Ö–æ–¥</div>
          <div class="badge">WebApp</div>
        </div>
        <button id="btnExit" class="btn btn-ghost" style="width:100%;">–ó–∞–∫—Ä—ã—Ç—å –º–∏–Ω–∏‚Äë–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
      </div>
    </section>
  </main>

  <!-- –Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å -->
  <nav class="bottom-nav">
    <div class="nav-item active" data-screen="cases">
      <span class="nav-item-icon">üé∞</span>
      <span class="nav-label">–ö–µ–π—Å—ã</span>
    </div>
    <div class="nav-item" data-screen="nft">
      <span class="nav-item-icon">üéí</span>
      <span class="nav-label">NFT</span>
    </div>
    <div class="nav-item" data-screen="shop">
      <span class="nav-item-icon">üíé</span>
      <span class="nav-label">–ö–∞—Å—Å–∞</span>
    </div>
    <div class="nav-item" data-screen="top">
      <span class="nav-item-icon">üèÜ</span>
      <span class="nav-label">–¢–æ–ø</span>
    </div>
    <div class="nav-item" data-screen="settings">
      <span class="nav-item-icon">‚öôÔ∏è</span>
      <span class="nav-label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
    </div>
  </nav>
</div>

<!-- –û–≤–µ—Ä–ª–µ–π –∞–Ω–∏–º–∞—Ü–∏–∏ –∫–µ–π—Å–∞ -->
<div id="caseAnimOverlay" class="case-anim-overlay">
  <div class="case-anim-box">
    <div class="case-anim-title" id="caseAnimTitle">–û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–µ–π—Å...</div>
    <div class="case-anim-status" id="caseAnimStatus">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ELITE RNG...</div>
    <div class="case-anim-lock" id="caseAnimLock">üîí</div>
    <div class="case-anim-bar">
      <div class="case-anim-fill" id="caseAnimFill"></div>
    </div>
    <div id="caseAnimDrop"></div>
  </div>
</div>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) tg.expand();

  /* === —Å–æ—Å—Ç–æ—è–Ω–∏–µ === */
  let state = {
    player: {
      name: "–ò–≥—Ä–æ–∫",
      user: "user",
      balance: 15000,
      totalCases: 0,
      bestRarity: null,
      vipUntil: 0,
      vibration: true,
      sound: true
    },
    eventHot: true,
    nft: [], // {id,name,rarity,level,exp}
    activeNftId: null,
    lastDailyTs: 0,
    selectedPack: null,
    leaders: []
  };

  const RARITIES = ["COMMON","RARE","EPIC","LEGENDARY","MYTHIC"];
  const CASES = [
    {
      id:"street",
      name:"–£–ª–∏—á–Ω—ã–π —Å—Ç–∞—Ä—Ç",
      rarity:"COMMON",
      price:1000,
      desc:"–î–µ—à–µ–≤–æ, –±—ã—Å—Ç—Ä–æ, –º–∞—Å—Å–æ–≤–æ.",
      weights:{COMMON:70,RARE:20,EPIC:8,LEGENDARY:2,MYTHIC:0}
    },
    {
      id:"blood",
      name:"–ö—Ä–æ–≤–∞–≤—ã–π —Ä–∞—Å—Å–≤–µ—Ç",
      rarity:"RARE",
      price:5000,
      desc:"–ë–∞–ª–∞–Ω—Å —Ä–∏—Å–∫–∞ –∏ –Ω–∞–≥—Ä–∞–¥—ã.",
      weights:{COMMON:35,RARE:30,EPIC:22,LEGENDARY:10,MYTHIC:3}
    },
    {
      id:"lava",
      name:"–õ–∞–≤–∞",
      rarity:"EPIC",
      price:15000,
      desc:"–ì–æ—Ä—è—á–∏–π —à–∞–Ω—Å –Ω–∞ —ç–ø–∏–∫.",
      weights:{COMMON:25,RARE:28,EPIC:30,LEGENDARY:12,MYTHIC:5}
    },
    {
      id:"royal",
      name:"–¢—Ä–æ–Ω —É–¥–∞—á–∏",
      rarity:"LEGENDARY",
      price:60000,
      desc:"–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π —Ä–∏—Å–∫ ‚Äî –∫–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π –¥—Ä–æ–ø.",
      weights:{COMMON:18,RARE:25,EPIC:30,LEGENDARY:18,MYTHIC:9}
    },
    {
      id:"olymp",
      name:"–û–ª–∏–º–ø –±–æ–≥–æ–≤",
      rarity:"MYTHIC",
      price:160000,
      desc:"–ß–∏—Å—Ç—ã–π –∞–∑–∞—Ä—Ç, –±–µ–∑ –ø–æ–¥—É—à–µ–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.",
      weights:{COMMON:10,RARE:20,EPIC:30,LEGENDARY:25,MYTHIC:15}
    }
  ];

  /* === utils === */
  function fmt(n){return n.toLocaleString("ru-RU");}
  function rarCfg(r){
    switch(r){
      case "COMMON":return{label:"COMMON",class:"rarity-common",color:"#9ca3af"};
      case "RARE":return{label:"RARE",class:"rarity-rare",color:"#60a5fa"};
      case "EPIC":return{label:"EPIC",class:"rarity-epic",color:"#e9d5ff"};
      case "LEGENDARY":return{label:"LEGEND",class:"rarity-legendary",color:"#fef3c7"};
      case "MYTHIC":return{label:"MYTHIC",class:"rarity-mythic",color:"#fee2e2"};
      default:return{label:r,class:"rarity-common",color:"#9ca3af"};
    }
  }
  function randomRarity(weights){
    let total=0;
    Object.values(weights).forEach(w=>total+=w);
    let roll=Math.random()*total;
    for(const [r,w] of Object.entries(weights)){
      if(roll<w) return r;
      roll-=w;
    }
    return "COMMON";
  }
  function randomName(r){
    const map={
      COMMON:["Street Chip","Rusty Core","Old Drive","Dust Key"],
      RARE:["Virus Core","Neon Blade","Midnight Node","Cold Barrel"],
      EPIC:["Quantum Spike","Ghost Kernel","Stellar Mask","Abyssal Dagger"],
      LEGENDARY:["Royal Matrix","Emperor Key","Crown Protocol","Gold Operator"],
      MYTHIC:["Omega Singularity","Godlike Seed","Chaos Script","Zero Origin"]
    };
    const arr=map[r]||map["COMMON"];
    const base=arr[Math.floor(Math.random()*arr.length)];
    const num=String(Math.floor(Math.random()*999)+1).padStart(3,"0");
    return `${base} #${num}`;
  }
  function estimateValue(nft){
    const baseMap={COMMON:2000,RARE:8000,EPIC:25000,LEGENDARY:80000,MYTHIC:240000};
    const base=baseMap[nft.rarity]||2000;
    return Math.round(base*(1+nft.level*0.35));
  }
  function bestRarity(current,newR){
    if(!newR) return current;
    if(!current) return newR;
    return RARITIES.indexOf(newR)>RARITIES.indexOf(current)?newR:current;
  }

  /* === localStorage === */
  const STORAGE_KEY="elite_deb_nft_battle_v1";
  function loadState(){
    try{
      const raw=localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const data=JSON.parse(raw);
      state=Object.assign(state,data);
      // —É–ø—Ä–æ—â—ë–Ω–Ω–æ: –±–∞–ª–∞–Ω—Å/–ª–∏–¥–µ—Ä—ã/NFT
      if(!Array.isArray(state.nft)) state.nft=[];
      if(!Array.isArray(state.leaders)) state.leaders=[];
    }catch(e){}
  }
  function saveState(){
    try{
      localStorage.setItem(STORAGE_KEY,JSON.stringify(state));
    }catch(e){}
  }

  /* === –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI === */
  function updateHeader(){
    document.getElementById("balanceValue").textContent=fmt(state.player.balance);
    document.getElementById("playerName").textContent=state.player.name;
    document.getElementById("playerUser").textContent=state.player.user;
    document.getElementById("totalCases").textContent=state.player.totalCases;
    document.getElementById("nftCount").textContent=state.nft.length;
    const rar=state.player.bestRarity;
    document.getElementById("bestDrop").textContent=rar?rar:"–Ω–µ—Ç";
    document.getElementById("badgeEvent").textContent=state.eventHot?"üî• –û–≥–Ω–µ–Ω–Ω–∞—è –Ω–µ–¥–µ–ª—è":"–û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º";

    const invValue=state.nft.reduce((s,n)=>s+estimateValue(n),0);
    const power=state.player.balance+invValue*0.6;
    let rank="–ù–æ–≤–∏—á–æ–∫";
    if(power>=1000000) rank="–õ–µ–≥–µ–Ω–¥–∞ –∫–∞–∑–∏–Ω–æ";
    else if(power>=300000) rank="–ë–æ—Å—Å –∞–∑–∞—Ä—Ç–∞";
    else if(power>=100000) rank="–°–µ—Ä—å—ë–∑–Ω—ã–π —Å—Ç–∞–≤–æ—á–Ω–∏–∫";
    document.getElementById("playerRank").textContent=rank;

    // VIP
    const now=Date.now();
    const vipEl=document.getElementById("vipStatus");
    if(state.player.vipUntil>now){
      const diff=state.player.vipUntil-now;
      const hours=Math.floor(diff/3600000);
      const mins=Math.floor((diff%3600000)/60000);
      vipEl.textContent=`–ö–æ–Ω—Ç—Ä–∞–∫—Ç –∞–∫—Ç–∏–≤–µ–Ω –µ—â—ë ${hours}—á ${mins}–º. –ë–æ–Ω—É—Å—ã –∫ –¥—Ä–æ–ø—É –∏ —Ü–µ–Ω–∞–º.`;
    }else{
      vipEl.textContent="–ö–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω.";
    }

    // –ª–∏–¥–µ—Ä—ã
    updateLeaders();
  }

  function renderCases(){
    const container=document.getElementById("caseList");
    container.innerHTML="";
    CASES.forEach(c=>{
      const rar=rarCfg(c.rarity);
      const div=document.createElement("div");
      div.className="case-card";
      div.dataset.caseId=c.id;
      div.innerHTML=`
        <div class="case-header">
          <div class="case-name">${c.name}</div>
          <div class="case-price">${fmt(c.price)} ü™ô</div>
        </div>
        <div class="case-desc">${c.desc}</div>
        <div class="case-rarity-tag ${rar.class}">${rar.label}</div>
      `;
      container.appendChild(div);
    });
  }

  function renderNftMain(){
    const box=document.getElementById("nftMainBlock");
    if(!state.nft.length){
      box.innerHTML=`<div style="font-size:12px;color:var(--text-secondary);">
        –¢—É—Ç –±—É–¥—É—Ç NFT, –∫–æ–≥–¥–∞ —Ç—ã –Ω–∞—á–Ω–µ—à—å —Ö–æ–∑—è–π–Ω–∏—á–∞—Ç—å —Å –∫–µ–π—Å–∞–º–∏.
      </div>`;
      document.getElementById("tradeCodeOut").value="–Ω–µ—Ç NFT –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏";
      return;
    }
    const active=state.nft.find(n=>n.id===state.activeNftId)||state.nft[0];
    state.activeNftId=active.id;
    const rar=rarCfg(active.rarity);
    const value=estimateValue(active);
    const nftHtml=`
      <div class="nft-header">
        <div>
          <div class="nft-main">
            <div class="nft-avatar">
              <div class="nft-avatar-inner">${active.rarity[0]}</div>
            </div>
            <div class="nft-info">
              <h3>${active.name}</h3>
              <div class="nft-info-sub" style="color:${rar.color};">${rar.label} ¬∑ LVL ${active.level}</div>
              <div class="nft-meta-row">
                <span class="tag">~${fmt(value)} ü™ô</span>
                <span class="tag">NFT: ${state.nft.length}</span>
              </div>
            </div>
          </div>
          <div class="nft-circle-meter">
            <div class="circle-wrap" id="nftCircle">
              <div class="circle-fill"></div>
              <div class="circle-inner">${Math.round(active.exp||0)}%</div>
            </div>
            <div style="font-size:11px;color:var(--text-secondary);">
              –®–∞–Ω—Å –≤—ã–∂–∏—Ç—å –ø—Ä–∏ –∞–ø–≥—Ä–µ–π–¥–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Ä–æ–≤–Ω—è. –ß–µ–º –≤—ã—à–µ ‚Äî —Ç–µ–º –∂–∞—Ä—á–µ.
            </div>
          </div>
        </div>
      </div>
      <div class="nft-list" id="nftList"></div>
    `;
    box.innerHTML=nftHtml;
    const list=document.getElementById("nftList");
    state.nft.forEach(n=>{
      const r=rarCfg(n.rarity);
      const row=document.createElement("div");
      row.className="nft-row";
      row.dataset.nftId=n.id;
      row.innerHTML=`
        <span>${n.name}</span>
        <span style="color:${r.color};">${r.label} ¬∑ L${n.level}</span>
      `;
      row.addEventListener("click",()=>{
        state.activeNftId=n.id;
        renderNftMain();
        updateHeader();
      });
      list.appendChild(row);
    });
    generateTradeCode();
  }

  function updateLeaders(){
    const invValue=state.nft.reduce((s,n)=>s+estimateValue(n),0);
    const key=state.player.user||"user";
    const entry=state.leaders.find(l=>l.user===key);
    if(entry){
      entry.balance=state.player.balance;
      entry.invValue=invValue;
      entry.name=state.player.name;
    }else{
      state.leaders.push({
        user:key,
        name:state.player.name,
        balance:state.player.balance,
        invValue
      });
    }
    const byBal=[...state.leaders].sort((a,b)=>b.balance-a.balance).slice(0,10);
    const byInv=[...state.leaders].sort((a,b)=>b.invValue-a.invValue).slice(0,10);
    const lb=document.getElementById("leadersBalance");
    const li=document.getElementById("leadersInv");
    lb.innerHTML=byBal.map((u,i)=>`
      <div class="leader-row">
        <span>${i+1}. ${u.name} (@${u.user})</span>
        <span class="leader-score-balance">${fmt(u.balance)} ü™ô</span>
      </div>`).join("") || `<div style="padding:6px;color:var(--text-secondary);">–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</div>`;
    li.innerHTML=byInv.map((u,i)=>`
      <div class="leader-row">
        <span>${i+1}. ${u.name} (@${u.user})</span>
        <span class="leader-score-inv">${fmt(Math.round(u.invValue))} ü™ô</span>
      </div>`).join("") || `<div style="padding:6px;color:var(--text-secondary);">–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</div>`;
  }

  function generateTradeCode(){
    const out=document.getElementById("tradeCodeOut");
    if(!state.nft.length){out.value="–Ω–µ—Ç NFT –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏";return;}
    const nft=state.nft.find(n=>n.id===state.activeNftId)||state.nft[0];
    const payload={type:"nft_trade",nft};
    out.value=btoa(JSON.stringify(payload));
  }

  /* === –∫–µ–π—Å—ã: –∞–Ω–∏–º–∞—Ü–∏—è –∏ –¥—Ä–æ–ø === */
  function openCase(caseId){
    const c=CASES.find(x=>x.id===caseId);
    if(!c) return;
    if(state.player.balance<c.price){
      alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç –Ω–∞ —ç—Ç–æ—Ç –∫–µ–π—Å.");
      return;
    }
    state.player.balance-=c.price;
    state.player.totalCases++;
    showCaseAnim(c);
    saveState();
    updateHeader();
  }

  function showCaseAnim(c){
    const overlay=document.getElementById("caseAnimOverlay");
    const title=document.getElementById("caseAnimTitle");
    const status=document.getElementById("caseAnimStatus");
    const lock=document.getElementById("caseAnimLock");
    const fill=document.getElementById("caseAnimFill");
    const dropBlock=document.getElementById("caseAnimDrop");
    title.textContent=`–û—Ç–∫—Ä—ã–≤–∞–µ–º: ${c.name}`;
    status.textContent="–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ELITE RNG...";
    lock.textContent="üîí";
    fill.style.width="0%";
    dropBlock.innerHTML="";
    overlay.classList.add("active");
    let step=0;
    const stages=[
      {text:"–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ö—Ä–∞–Ω–∏–ª–∏—â—É NFT...",icon:"üì°"},
      {text:"–ê–Ω–∞–ª–∏–∑ —Ç–≤–æ–µ–≥–æ —Ñ–∞—Ä—Ç–æ–≤–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è...",icon:"üß†"},
      {text:"–ö—Ä—É—Ç–∏—Ç—Å—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è —Ä—É–ª–µ—Ç–∫–∞...",icon:"üé≤"},
      {text:"–ú–∞–∫—Å —Å–º–æ—Ç—Ä–∏—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ç—ã –Ω–∞–≥–ª—ã–π...",icon:"üëÄ"},
      {text:"–§–∏–∫—Å–∏—Ä—É—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥—Ä–æ–ø–∞...",icon:"üîê"}
    ];
    const timer=setInterval(()=>{
      step++;
      const progress=Math.min(100,(step/stages.length)*100);
      fill.style.width=progress+"%";
      if(step<=stages.length){
        status.textContent=stages[step-1].text;
        lock.textContent=stages[step-1].icon;
      }else{
        clearInterval(timer);
        lock.textContent="‚úÖ";
        status.textContent="RNG –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω.";
        setTimeout(()=>{
          revealDrop(c);
        },350);
      }
    },240);
  }

  function revealDrop(c){
    const dropBlock=document.getElementById("caseAnimDrop");
    const rarity=calculateDropRarity(c.weights);
    const name=randomName(rarity);
    const nft={
      id:"nft_"+Date.now()+"_"+Math.floor(Math.random()*9999),
      name,
      rarity,
      level:0,
      exp:0
    };
    state.nft.push(nft);
    state.activeNftId=nft.id;
    state.player.bestRarity=bestRarity(state.player.bestRarity,rarity);

    const rar=rarCfg(rarity);
    const value=estimateValue(nft);

    dropBlock.innerHTML=`
      <div class="case-drop">
        <div style="font-size:13px;margin-bottom:4px;">üéä –í—ã–ø–∞–ª–æ:</div>
        <div style="font-size:14px;font-weight:600;margin-bottom:2px;">${nft.name}</div>
        <div style="font-size:12px;color:${rar.color};margin-bottom:2px;">${rar.label}</div>
        <div style="font-size:11px;color:var(--text-secondary);">~${fmt(value)} ü™ô</div>
      </div>
      <button id="btnCloseCaseAnim" class="btn btn-primary" style="margin-top:10px;width:100%;">–ó–∞–±—Ä–∞—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    `;
    document.getElementById("btnCloseCaseAnim").onclick=()=>{
      document.getElementById("caseAnimOverlay").classList.remove("active");
    };
    renderNftMain();
    saveState();
    updateHeader();
  }

  function calculateDropRarity(weights){
    const now=Date.now();
    const vip=state.player.vipUntil>now;
    const w={...weights};
    if(state.eventHot){
      w.LEGENDARY=(w.LEGENDARY||0)*1.4;
      w.MYTHIC=(w.MYTHIC||0)*1.6;
    }
    if(vip){
      w.EPIC=(w.EPIC||0)*1.3;
      w.LEGENDARY=(w.LEGENDARY||0)*1.3;
      w.MYTHIC=(w.MYTHIC||0)*1.2;
    }
    return randomRarity(w);
  }

  /* === –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å === */
  function takeDaily(){
    const now=Date.now();
    if(now-state.lastDailyTs<24*3600000){
      alert("–ë–æ–Ω—É—Å —É–∂–µ –∑–∞–±—Ä–∞–Ω. –ñ–¥–∏ –µ—â—ë —á—É—Ç—å-—á—É—Ç—å.");
      return;
    }
    const base=5000;
    let bonus=base;
    if(state.eventHot) bonus*=2;
    state.player.balance+=bonus;
    state.lastDailyTs=now;
    alert(`–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å: +${fmt(bonus)} ü™ô`);
    saveState();
    updateHeader();
  }

  /* === –∫—Ä–∞—Ñ—Ç –∏ —É–ª—É—á—à–µ–Ω–∏–µ === */
  function craft(){
    if(state.nft.length<3){
      alert("–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 NFT –¥–ª—è –∫—Ä–∞—Ñ—Ç–∞.");
      return;
    }
    const removed=state.nft.splice(0,3);
    let maxIdx=0;
    removed.forEach(n=>{
      const idx=RARITIES.indexOf(n.rarity);
      if(idx>maxIdx) maxIdx=idx;
    });
    const newIdx=Math.min(RARITIES.length-1,maxIdx+1);
    const rar=RARITIES[newIdx];
    const nft={
      id:"nft_"+Date.now()+"_"+Math.floor(Math.random()*9999),
      name:randomName(rar),
      rarity:rar,
      level:0,
      exp:0
    };
    state.nft.push(nft);
    state.activeNftId=nft.id;
    alert("–ö—Ä–∞—Ñ—Ç —É–¥–∞–ª—Å—è. –ù–æ–≤—ã–π NFT –≤—ã—à–µ –∫–ª–∞—Å—Å–æ–º.");
    renderNftMain();
    saveState();
    updateHeader();
  }

  function upgrade(){
    if(!state.nft.length){
      alert("–ù–µ—Ç NFT –¥–ª—è –∞–ø–≥—Ä–µ–π–¥–∞.");
      return;
    }
    const nft=state.nft.find(n=>n.id===state.activeNftId)||state.nft[0];
    const baseCost=5000;
    const cost=baseCost+nft.level*4000;
    if(state.player.balance<cost){
      alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è.");
      return;
    }
    state.player.balance-=cost;
    const baseRisk=10+nft.level*7;
    const risk=Math.min(80,baseRisk);
    const circle=document.getElementById("nftCircle");
    if(circle) circle.classList.add("upgrading");
    setTimeout(()=>{
      const roll=Math.random()*100;
      if(roll<risk){
        state.nft=state.nft.filter(n=>n.id!==nft.id);
        state.activeNftId=state.nft[0]?.id||null;
        alert("NFT —Å–≥–æ—Ä–µ–ª –Ω–∞ –∞–ø–≥—Ä–µ–π–¥–µ. –ú–∞–∫—Å –±—ã–ª –Ω–µ –≤–ø–µ—á–∞—Ç–ª—ë–Ω.");
      }else{
        nft.level+=1;
        nft.exp=Math.min(100,(nft.exp||0)+35);
        alert("NFT –≤—ã–∂–∏–ª –∏ —Å—Ç–∞–ª –∂—ë—Å—Ç—á–µ.");
      }
      if(circle) circle.classList.remove("upgrading");
      renderNftMain();
      saveState();
      updateHeader();
    },1000);
  }

  /* === –º–∞–≥–∞–∑–∏–Ω / VIP === */
  function selectPack(id){
    state.selectedPack=id;
    document.querySelectorAll(".pack").forEach(p=>{
      p.classList.toggle("selected",p.dataset.pack===id);
    });
    const label=document.getElementById("packLabel");
    const map={
      "10k":"Starter ¬∑ +10 000 ü™ô",
      "50k":"Grinder ¬∑ +50 000 ü™ô",
      "250k":"Whale ¬∑ +250 000 ü™ô",
      "1m":"ELITE ¬∑ +1 000 000 ü™ô"
    };
    label.textContent=map[id]||"–Ω–µ –≤—ã–±—Ä–∞–Ω";
  }

  function fakeTopup(){
    if(!state.selectedPack){
      alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –ø–∞–∫–µ—Ç.");
      return;
    }
    const map={"10k":10000,"50k":50000,"250k":250000,"1m":1000000};
    const val=map[state.selectedPack]||0;
    state.player.balance+=val;
    alert(`–õ–æ–∫–∞–ª—å–Ω—ã–π –¥–æ–¥–µ–ø: +${fmt(val)} ü™ô`);
    saveState();
    updateHeader();
  }

  function signVip(){
    if(state.player.balance<100000){
      alert("–î–ª—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 100 000 ü™ô.");
      return;
    }
    const fee=state.player.balance*0.1;
    state.player.balance-=fee;
    const now=Date.now();
    state.player.vipUntil=now+24*3600000;
    alert(`–ö–æ–Ω—Ç—Ä–∞–∫—Ç –ø–æ–¥–ø–∏—Å–∞–Ω. –ú–∞–∫—Å –∑–∞–±—Ä–∞–ª ${fmt(Math.round(fee))} ü™ô –∏ –¥–∞–ª —Ç–µ–±–µ 24 —á–∞—Å–∞ –±–æ–Ω—É—Å–æ–≤.`);
    saveState();
    updateHeader();
  }

  /* === –æ–±–º–µ–Ω === */
  function applyTrade(){
    const txt=document.getElementById("tradeCodeIn").value.trim();
    if(!txt){alert("–í—Å—Ç–∞–≤—å –∫–æ–¥ –æ–±–º–µ–Ω–∞.");return;}
    try{
      const payload=JSON.parse(atob(txt));
      if(payload.type!=="nft_trade"||!payload.nft) throw new Error();
      const exists=state.nft.find(n=>n.id===payload.nft.id);
      if(exists){
        alert("–≠—Ç–æ—Ç NFT —É–∂–µ –µ—Å—Ç—å —É —Ç–µ–±—è.");
        return;
      }
      state.nft.push(payload.nft);
      state.activeNftId=payload.nft.id;
      alert("NFT –ø—Ä–∏–Ω—è—Ç –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å.");
      renderNftMain();
      saveState();
      updateHeader();
    }catch(e){
      alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –æ–±–º–µ–Ω–∞.");
    }
  }

  /* === –Ω–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è === */
  function switchScreen(screen){
    document.querySelectorAll(".screen").forEach(s=>{
      s.classList.toggle("active",s.id==="screen-"+screen);
    });
    document.querySelectorAll(".nav-item").forEach(n=>{
      n.classList.toggle("active",n.dataset.screen===screen);
    });
  }

  /* === –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è === */
  function initFromTelegram(){
    if(!tg) return;
    const user=tg.initDataUnsafe?.user;
    if(user){
      state.player.name=user.first_name||state.player.name;
      state.player.user=user.username||state.player.user;
    }
  }

  function attachEvents(){
    // –Ω–∏–∂–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∏
    document.querySelectorAll(".nav-item").forEach(n=>{
      n.addEventListener("click",()=>switchScreen(n.dataset.screen));
    });
    // –∫–µ–π—Å—ã
    document.getElementById("caseList").addEventListener("click",e=>{
      const card=e.target.closest(".case-card");
      if(!card) return;
      openCase(card.dataset.caseId);
    });
    document.getElementById("caseAnimOverlay").addEventListener("click",e=>{
      if(e.target.id==="caseAnimOverlay"){
        document.getElementById("caseAnimOverlay").classList.remove("active");
      }
    });

    document.getElementById("btnDaily").onclick=takeDaily;
    document.getElementById("btnToggleEvent").onclick=()=>{
      state.eventHot=!state.eventHot;
      saveState();
      updateHeader();
    };

    document.getElementById("btnCraft").onclick=craft;
    document.getElementById("btnUpgrade").onclick=upgrade;

    document.querySelectorAll(".pack").forEach(p=>{
      p.addEventListener("click",()=>selectPack(p.dataset.pack));
    });
    document.getElementById("btnFakeTopup").onclick=fakeTopup;
    document.getElementById("btnVip").onclick=signVip;

    document.getElementById("btnGenTrade").onclick=generateTradeCode;
    document.getElementById("btnApplyTrade").onclick=applyTrade;

    document.getElementById("btnVibration").onclick=()=>{
      state.player.vibration=!state.player.vibration;
      document.getElementById("btnVibration").textContent=`üì≥ –í–∏–±—Ä–∞—Ü–∏—è: ${state.player.vibration?"–í–ö–õ":"–í–´–ö–õ"}`;
      saveState();
    };
    document.getElementById("btnSound").onclick=()=>{
      state.player.sound=!state.player.sound;
      document.getElementById("btnSound").textContent=`üîä –ó–≤—É–∫: ${state.player.sound?"–í–ö–õ":"–í–´–ö–õ"}`;
      saveState();
    };
    document.getElementById("btnReset").onclick=()=>{
      if(confirm("–¢–æ—á–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å?")) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      }
    };
    document.getElementById("btnExit").onclick=()=>{
      if(tg) tg.close();
    };
  }

  function init(){
    initFromTelegram();
    loadState();
    renderCases();
    renderNftMain();
    attachEvents();
    updateHeader();
  }

  init();
</script>
</body>
</html>
