<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>BTC MULTIPLAYER TERMINAL</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #0b0e11; --surf: #1e2329; --prim: #f0b90b; --up: #0ecb81; --down: #f6465d; --text: #eaecef; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* AUTH */
        #auth { position: fixed; inset: 0; background: var(--bg); z-index: 100; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .box { background: var(--surf); padding: 30px; border-radius: 12px; width: 300px; border: 1px solid #333; text-align: center; box-shadow: 0 0 30px rgba(240,185,11,0.1); }
        input { width: 100%; padding: 12px; margin: 10px 0; background: #2b3139; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; outline: none; transition: all 0.3s; }
        input:focus { border-color: var(--prim); box-shadow: 0 0 10px rgba(240,185,11,0.2); }
        
        /* BUTTONS WITH ANIMATION */
        .btn { 
            width: 100%; padding: 12px; background: var(--prim); border: none; border-radius: 4px; 
            font-weight: bold; cursor: pointer; margin-top: 10px; color: #000;
            transition: all 0.2s; position: relative; overflow: hidden;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(240,185,11,0.4); }
        .btn:active { transform: scale(0.95); }
        
        /* RIPPLE EFFECT */
        .ripple {
            position: absolute; border-radius: 50%; background: rgba(255,255,255,0.4);
            transform: scale(0); animation: ripple 0.6s linear; pointer-events: none;
        }
        @keyframes ripple { to { transform: scale(4); opacity: 0; } }
        
        /* TRADE BUTTONS SPECIAL */
        .btn-trade {
            position: relative; overflow: hidden;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-trade::after {
            content: ''; position: absolute; inset: 0; background: rgba(255,255,255,0.2);
            opacity: 0; transition: opacity 0.2s;
        }
        .btn-trade:active::after { opacity: 1; }
        .btn-trade:active { transform: scale(0.92); }
        .btn-buy { background: var(--up); color: white; }
        .btn-buy:hover { box-shadow: 0 4px 20px rgba(14,203,129,0.4); }
        .btn-sell { background: var(--down); color: white; }
        .btn-sell:hover { box-shadow: 0 4px 20px rgba(246,70,93,0.4); }
        
        /* APP LAYOUT */
        .app { display: none; grid-template-columns: 1fr 300px; grid-template-rows: 60px 1fr 150px; height: 100vh; }
        header { grid-column: 1/3; background: var(--surf); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; border-bottom: 1px solid #333; }
        #chart { grid-column: 1/2; grid-row: 2/3; position: relative; border-right: 1px solid #333; }
        #side { grid-column: 2/3; grid-row: 2/4; background: var(--surf); display: flex; flex-direction: column; }
        #chat { flex: 1; overflow-y: auto; padding: 10px; font-size: 13px; background: #161a1e; }
        footer { grid-column: 1/2; grid-row: 3/4; background: var(--surf); padding: 20px; display: flex; align-items: center; gap: 20px; border-top: 1px solid #333; }
        .msg { margin-bottom: 5px; border-bottom: 1px solid #2b3139; padding: 3px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .trade-msg { color: var(--prim); font-weight: bold; background: rgba(240,185,11,0.1); padding: 5px; border-radius: 4px; border-left: 3px solid var(--prim); }
        #price { position: absolute; top: 20px; left: 20px; z-index: 10; font-size: 32px; font-weight: bold; font-family: 'Courier New', monospace; text-shadow: 0 0 20px currentColor; transition: all 0.3s; }
        
        /* CLICK FEEDBACK */
        .click-feedback { animation: clickPulse 0.3s; }
        @keyframes clickPulse { 0% { transform: scale(1); } 50% { transform: scale(0.95); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div id="auth">
    <div class="box">
        <h2 style="color:var(--prim); margin-bottom: 20px;">‚ö° BTC LOGIN</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn" onclick="handleAuth(this)">–í–û–ô–¢–ò / –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
        <p id="err" style="color:var(--down); font-size:12px; margin-top: 10px;"></p>
    </div>
</div>

<div class="app" id="app">
    <header>
        <div style="font-weight:bold; color:var(--prim); font-size: 18px;">‚ö° TERMINAL v1.0</div>
        <div style="font-size: 14px;">–ë–∞–ª–∞–Ω—Å: <b id="bal" style="color:var(--up); font-size: 16px;">10000</b> USDT | –ò–≥—Ä–æ–∫: <b id="nick" style="color:var(--prim);">...</b></div>
        <button class="btn" onclick="location.reload()" style="width: auto; padding: 8px 16px; margin: 0; font-size: 12px;">–í—ã—Ö–æ–¥</button>
    </header>
    <div id="chart"><div id="price">0.00</div></div>
    <aside id="side">
        <div style="padding:10px; font-size:11px; color:var(--prim); font-weight: bold; border-bottom: 1px solid #333;">üèÜ –¢–û–ü –¢–†–ï–ô–î–ï–†–û–í</div>
        <div id="leaderboard" style="padding:10px; background:#161a1e; font-size:12px; max-height: 150px; overflow-y: auto;"></div>
        <div style="padding:10px; font-size:11px; color:#888; border-bottom: 1px solid #333; border-top: 1px solid #333;">üí¨ –û–ë–©–ò–ô –ß–ê–¢</div>
        <div id="chat"></div>
        <div style="padding:10px; border-top: 1px solid #333;">
            <input type="text" id="chat-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0; width: 100%;">
        </div>
    </aside>
    <footer>
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="color: #888; font-size: 12px;">–û–±—ä–µ–º:</span>
            <input type="number" id="vol" value="0.1" step="0.01" style="width:100px; margin: 0;">
            <span style="color: var(--prim); font-weight: bold;">BTC</span>
        </div>
        <button class="btn btn-trade btn-buy" style="flex: 1; margin: 0; padding: 15px; font-size: 14px;" onclick="doTrade('BUY', this)">
            <span style="font-size: 18px; margin-right: 5px;">üìà</span> BUY / LONG
        </button>
        <button class="btn btn-trade btn-sell" style="flex: 1; margin: 0; padding: 15px; font-size: 14px;" onclick="doTrade('SELL', this)">
            <span style="font-size: 18px; margin-right: 5px;">üìâ</span> SELL / SHORT
        </button>
    </footer>
</div>

<script>
const SB_URL = "https://ederonvgyvzugahjvxdm.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkZXJvbnZneXZ6dWdhaGp2eGRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MjQ2NzQsImV4cCI6MjA4NzQwMDY3NH0.VjcFQyCBgYcIQq9QE3s4dRCIFZc_Rnrk99b7ZAN6oNg";
const sb = supabase.createClient(SB_URL, SB_KEY);
let user, btcPrice = 0, balance = 10000, nick = "";

// RIPPLE EFFECT
function createRipple(e, btn) {
    const ripple = document.createElement('span');
    ripple.className = 'ripple';
    const rect = btn.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    ripple.style.width = ripple.style.height = size + 'px';
    ripple.style.left = (e.clientX - rect.left - size/2) + 'px';
    ripple.style.top = (e.clientY - rect.top - size/2) + 'px';
    btn.appendChild(ripple);
    setTimeout(() => ripple.remove(), 600);
}

async function handleAuth(btn) {
    createRipple(event, btn);
    const e = document.getElementById('email').value, p = document.getElementById('pass').value;
    if (!e || !p) return document.getElementById('err').innerText = "–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å";
    
    let { data, error } = await sb.auth.signInWithPassword({ email: e, password: p });
    if (error) {
        let reg = await sb.auth.signUp({ email: e, password: p });
        if (reg.error) return document.getElementById('err').innerText = reg.error.message;
        data = reg.data;
        await sb.from('profiles').insert([{ id: data.user.id, username: e.split('@')[0], balance: 10000 }]);
    }
    user = data.user;
    init();
}

async function init() {
    document.getElementById('auth').style.display = 'none';
    document.getElementById('app').style.display = 'grid';
    const { data: p } = await sb.from('profiles').select('*').eq('id', user.id).single();
    if (p) { balance = p.balance; nick = p.username; document.getElementById('nick').innerText = nick; updateUI(); }
    
    const chart = LightweightCharts.createChart(document.getElementById('chart'), { 
        layout: { background: { color: '#0b0e11' }, textColor: '#d1d4dc' },
        grid: { vertLines: { color: '#1e2329' }, horzLines: { color: '#1e2329' } }
    });
    const candles = chart.addCandlestickSeries({ upColor: '#0ecb81', downColor: '#f6465d', borderVisible: false });
    
    const ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@kline_1m');
    ws.onmessage = (e) => {
        const k = JSON.parse(e.data).k; 
        btcPrice = parseFloat(k.c);
        candles.update({ time: k.t/1000, open: parseFloat(k.o), high: parseFloat(k.h), low: parseFloat(k.l), close: btcPrice });
        
        const priceEl = document.getElementById('price');
        const oldColor = priceEl.style.color;
        priceEl.innerText = btcPrice.toFixed(2);
        priceEl.style.color = btcPrice >= parseFloat(k.o) ? 'var(--up)' : 'var(--down)';
        
        // Flash effect on price change
        priceEl.style.transform = 'scale(1.1)';
        setTimeout(() => priceEl.style.transform = 'scale(1)', 150);
    };

    sb.channel('msgs').on('postgres_changes', {event:'INSERT', schema:'public', table:'messages'}, r => addMsg(r.new)).subscribe();
    loadData(); setInterval(loadData, 10000);
}

async function doTrade(t, btn) {
    createRipple(event, btn);
    btn.classList.add('click-feedback');
    setTimeout(() => btn.classList.remove('click-feedback'), 300);
    
    const v = parseFloat(document.getElementById('vol').value);
    if (!v || v <= 0) return alert("–í–≤–µ–¥–∏—Ç–µ –æ–±—ä–µ–º!");
    
    const c = v * btcPrice;
    if (t === 'BUY' && c > balance) return alert("–ú–∞–ª–æ –¥–µ–Ω–µ–≥!");
    
    balance = t === 'BUY' ? balance - c : balance + c;
    updateUI();
    await sb.from('profiles').update({ balance }).eq('id', user.id);
    await sb.from('messages').insert([{ username: nick, text: `${t==='BUY'?'üü¢ LONG':'üî¥ SHORT'} ${v} BTC –ø–æ ${btcPrice.toFixed(2)}`, is_trade: true }]);
    
    // Visual feedback
    const notif = document.createElement('div');
    notif.style.cssText = `position:fixed; top:80px; left:50%; transform:translateX(-50%); background:${t==='BUY'?'var(--up)':'var(--down)'}; color:white; padding:15px 30px; border-radius:8px; font-weight:bold; z-index:1000; animation:slideDown 0.3s;`;
    notif.innerHTML = `${t==='BUY'?'‚úÖ –õ–æ–Ω–≥ –æ—Ç–∫—Ä—ã—Ç':'‚úÖ –®–æ—Ä—Ç –æ—Ç–∫—Ä—ã—Ç'} ${v} BTC`;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 2000);
}

async function loadData() {
    const { data: l } = await sb.from('profiles').select('username, balance').order('balance', {ascending: false}).limit(5);
    if (l) document.getElementById('leaderboard').innerHTML = l.map((x, i) => `<div style="padding:5px 0; ${x.username===nick?'color:var(--prim); font-weight:bold;':''}">${i+1}. ${x.username} - $${x.balance.toFixed(0)}</div>`).join('');
    const { data: m } = await sb.from('messages').select('*').order('created_at', {ascending: false}).limit(20);
    if (m) { document.getElementById('chat').innerHTML = ''; m.reverse().forEach(addMsg); }
}

function addMsg(m) {
    const ch = document.getElementById('chat');
    const div = document.createElement('div');
    div.className = 'msg ' + (m.is_trade ? 'trade-msg' : '');
    div.innerHTML = `<b style="color:${m.is_trade?'var(--prim)':'#888'}">${m.username}:</b> ${m.text}`;
    ch.appendChild(div);
    ch.scrollTop = ch.scrollHeight;
}

function updateUI() { document.getElementById('bal').innerText = balance.toFixed(2); }

document.getElementById('chat-in').onkeypress = async (e) => {
    if (e.key === 'Enter' && e.target.value) {
        await sb.from('messages').insert([{ username: nick, text: e.target.value }]);
        e.target.value = '';
    }
};

// Add slideDown animation
const style = document.createElement('style');
style.innerHTML = `@keyframes slideDown { from { opacity:0; transform:translateX(-50%) translateY(-20px); } to { opacity:1; transform:translateX(-50%) translateY(0); } }`;
document.head.appendChild(style);
</script>
</body>
</html>
