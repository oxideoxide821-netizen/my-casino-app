<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>ELITE DEB // NFT BATTLE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-main:#020617;
      --bg-card:rgba(10,15,30,0.96);
      --bg-soft:rgba(15,23,42,0.9);
      --accent-gold:linear-gradient(135deg,#f59e0b,#fbbf24,#f97316);
      --accent-fire:linear-gradient(135deg,#ef4444,#f97316,#fbbf24);
      --accent-blue:linear-gradient(135deg,#22c55e,#3b82f6,#6366f1);
      --text-primary:#e5e7eb;
      --text-secondary:#9ca3af;
      --border-soft:rgba(148,163,184,0.4);
      --glow-blue:rgba(59,130,246,0.8);
      --glow-gold:rgba(251,191,36,0.9);
      --shadow-main:0 24px 48px rgba(0,0,0,0.9);
    }
    /* –¢–ï–ú–´ (–∫–∞–∫ –≤ NFT Battle ‚Äî —Å–º–µ–Ω–∞ —Ü–≤–µ—Ç–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞) */
    [data-theme="default"]{
      --bg-main:#020617;
      --bg-card:rgba(10,15,30,0.96);
      --bg-soft:rgba(15,23,42,0.9);
      --accent-gold:linear-gradient(135deg,#f59e0b,#fbbf24,#f97316);
      --glow-blue:rgba(59,130,246,0.9);
    }
    [data-theme="neon"]{
      --bg-main:#020016;
      --bg-card:rgba(6,8,30,0.98);
      --bg-soft:rgba(12,14,52,0.96);
      --accent-gold:linear-gradient(135deg,#10b981,#22c55e,#3b82f6);
      --glow-blue:rgba(56,189,248,0.9);
    }
    [data-theme="crimson"]{
      --bg-main:#090012;
      --bg-card:rgba(20,4,24,0.98);
      --bg-soft:rgba(36,5,32,0.96);
      --accent-gold:linear-gradient(135deg,#dc2626,#fb923c,#facc15);
      --glow-blue:rgba(248,113,113,0.9);
    }

    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI',system-ui,sans-serif;
      background:var(--bg-main);
      color:var(--text-primary);
      min-height:100vh;
      overflow-x:hidden;
      position:relative;
    }
    canvas#sparksCanvas{
      position:fixed;
      inset:0;
      z-index:-1;
      background:radial-gradient(circle at top,#111827 0%,#020617 45%,#000 100%);
    }
    .app{min-height:100vh;display:flex;flex-direction:column;}
    .main{
      flex:1;
      padding:12px;
      padding-bottom:90px;
      overflow-y:auto;
      scrollbar-width:none;
    }
    .main::-webkit-scrollbar{display:none;}
    .screen{display:none;min-height:100%;gap:10px;flex-direction:column;}
    .screen.active{display:flex;}
    .card{
      background:var(--bg-card);
      border-radius:18px;
      border:1px solid var(--border-soft);
      padding:14px 14px 16px;
      box-shadow:var(--shadow-main);
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:'';
      position:absolute;
      inset:-40%;
      background:linear-gradient(120deg,transparent 0%,rgba(255,255,255,0.06) 40%,transparent 70%);
      opacity:0;
      transform:translateX(-100%);
    }
    .card:hover::before{
      opacity:1;
      animation:cardShimmer 2s linear infinite;
    }
    @keyframes cardShimmer{0%{transform:translateX(-100%);}100%{transform:translateX(100%);}}
    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .card-title{
      font-size:15px;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .badge{
      font-size:11px;
      padding:4px 9px;
      border-radius:999px;
      background:rgba(15,23,42,0.92);
      border:1px solid rgba(148,163,184,0.6);
      color:var(--text-secondary);
      white-space:nowrap;
    }
    .grid-2{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,0.9fr);
      gap:10px;
    }
    @media(max-width:700px){
      .grid-2{grid-template-columns:1fr;}
    }
    .balance-main{
      font-size:24px;
      font-weight:800;
      display:flex;
      align-items:baseline;
      gap:6px;
    }
    .balance-main span.unit{
      font-size:14px;
      font-weight:600;
      color:#f97316;
    }
    .sub-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
    }
    .chip{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      font-size:11.5px;
      color:var(--text-secondary);
      background:var(--bg-soft);
      max-width:48%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .streak-row{
      margin-top:6px;
      font-size:11.5px;
      color:var(--text-secondary);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    /* –∫–µ–π—Å—ã */
    .case-filter-row{
      display:flex;
      gap:6px;
      margin-bottom:8px;
      overflow-x:auto;
      padding-bottom:2px;
    }
    .filter-pill{
      font-size:11.5px;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      background:var(--bg-soft);
      color:var(--text-secondary);
      white-space:nowrap;
      cursor:pointer;
      flex-shrink:0;
      transition:background 160ms ease, color 160ms ease, box-shadow 160ms ease, border-color 160ms ease;
    }
    .filter-pill.active{
      background:var(--glow-blue);
      color:#020617;
      box-shadow:0 0 18px var(--glow-blue);
      border-color:transparent;
    }
    .case-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
      max-height:260px;
      overflow-y:auto;
      padding-right:2px;
    }
    @media(min-width:900px){
      .case-grid{grid-template-columns:repeat(3,minmax(0,1fr));max-height:300px;}
    }
    .case-card{
      position:relative;
      padding:10px 9px;
      border-radius:16px;
      background:var(--bg-soft);
      border:1px solid rgba(148,163,184,0.4);
      cursor:pointer;
      overflow:hidden;
      transition:
        transform 160ms ease,
        box-shadow 160ms ease,
        border-color 160ms ease,
        background 160ms ease;
      touch-action:manipulation;
    }
    .case-card:hover,
    .case-card:active{
      transform:translateY(-2px) scale(1.015);
      box-shadow:0 18px 30px rgba(0,0,0,0.9);
      border-color:rgba(129,140,248,0.9);
      background:radial-gradient(circle at top,#111827,#020617 60%);
    }
    .case-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:3px;
      gap:4px;
    }
    .case-name{
      font-size:12px;
      font-weight:600;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .case-price{
      font-size:11.5px;
      color:var(--text-secondary);
      display:flex;
      align-items:center;
      gap:3px;
      white-space:nowrap;
    }
    .case-desc{
      font-size:10.5px;
      color:var(--text-secondary);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .case-rarity-tag{
      position:absolute;
      right:6px;
      top:6px;
      font-size:9px;
      padding:2px 6px;
      border-radius:999px;
      text-transform:uppercase;
      letter-spacing:0.08em;
    }
    .rarity-common{background:rgba(107,114,128,0.22);color:#9ca3af;}
    .rarity-rare{background:rgba(59,130,246,0.25);color:#60a5fa;}
    .rarity-epic{background:rgba(168,85,247,0.28);color:#e9d5ff;}
    .rarity-legendary{background:rgba(251,191,36,0.32);color:#fef3c7;}
    .rarity-mythic{background:rgba(248,113,113,0.35);color:#fee2e2;}

    /* –∞–Ω–∏–º–∞—Ü–∏—è –∫–µ–π—Å–æ–≤ + —Ç—Ä–µ–π–¥ –∞–Ω–∏–º–∞—Ü–∏–∏ */
    .case-anim-overlay{
      position:fixed;
      inset:0;
      background:rgba(7,11,25,0.96);
      backdrop-filter:blur(20px);
      z-index:90;
      display:none;
      align-items:center;
      justify-content:center;
    }
    .case-anim-overlay.active{display:flex;}
    .case-anim-box{
      width:min(380px,94vw);
      background:var(--bg-card);
      border-radius:22px;
      border:1px solid var(--border-soft);
      padding:16px;
      box-shadow:var(--shadow-main);
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .case-anim-title{
      font-size:15px;
      font-weight:700;
      margin-bottom:4px;
    }
    .case-anim-status{
      font-size:11.5px;
      color:var(--text-secondary);
      margin-bottom:8px;
    }
    .case-anim-lock{font-size:22px;margin-bottom:8px;animation:lockPulse 1s infinite;}
    @keyframes lockPulse{
      0%,100%{transform:scale(1);}
      50%{transform:scale(1.1);}
    }
    .case-anim-bar{
      height:10px;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.6);
      overflow:hidden;
      margin-bottom:8px;
    }
    .case-anim-fill{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,#22c55e,#eab308,#f97316);
      box-shadow:0 0 16px rgba(234,179,8,0.7);
      transition:width 0.18s cubic-bezier(0.68,-0.55,0.265,1.55);
      position:relative;
      overflow:hidden;
    }
    .case-anim-fill::after{
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,0.4) 50%,transparent 100%);
      animation:barShimmer 1.4s infinite;
    }
    @keyframes barShimmer{0%{transform:translateX(-100%);}100%{transform:translateX(100%);}}

    .case-drop{
      margin-top:8px;
      padding:9px;
      border-radius:16px;
      border:1px solid rgba(251,191,36,0.8);
      background:rgba(15,23,42,0.97);
      font-size:12px;
      box-shadow:0 0 26px rgba(251,191,36,0.8);
    }

    /* —Ä—É–ª–µ—Ç–∫–∞ NFT */
    .nft-reel-wrap{
      margin:8px auto 4px;
      width:100%;
      display:flex;
      justify-content:center;
    }
    .nft-reel-window{
      width:100%;
      max-width:300px;
      height:88px;
      overflow:hidden;
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.6);
      background:radial-gradient(circle at 50% 0,#1f2937 0%,#020617 70%);
      box-shadow:0 0 18px rgba(15,23,42,0.9);
      position:relative;
    }
    .nft-reel{
      position:absolute;
      left:0;
      top:0;
      width:100%;
      transition:transform 1s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .nft-reel-card{
      height:88px;
      display:flex;
      align-items:center;
      padding:7px 10px;
      box-sizing:border-box;
    }
    .nft-reel-card-inner{
      width:100%;
      height:100%;
      border-radius:15px;
      border:1px solid rgba(148,163,184,0.6);
      background:linear-gradient(135deg,#020617,#111827);
      display:flex;
      align-items:center;
      padding:5px 9px;
      gap:9px;
      box-shadow:0 0 16px rgba(15,23,42,0.9);
    }
    .nft-reel-badge{
      width:52px;
      height:70px;
      border-radius:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:22px;
      font-weight:800;
      color:#e5e7eb;
      text-shadow:0 0 10px rgba(248,250,252,0.7);
    }
    .nft-reel-info{
      flex:1;
      min-width:0;
    }
    .nft-reel-name{
      font-size:12.5px;
      font-weight:600;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .nft-reel-meta{
      font-size:10.5px;
      color:#9ca3af;
      margin-top:2px;
    }
    .nft-reel-value{
      font-size:11px;
      color:#fbbf24;
      margin-top:2px;
    }

    /* NFT */
    .nft-header{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;}
    .nft-main{display:flex;gap:10px;align-items:center;margin-bottom:6px;}
    .nft-avatar{
      width:70px;height:70px;
      border-radius:20px;
      background:radial-gradient(circle at 0 0,#4f46e5,#0b1120);
      border:2px solid rgba(129,140,248,0.9);
      display:flex;align-items:center;justify-content:center;
      font-size:22px;font-weight:800;
      position:relative;overflow:hidden;
    }
    .nft-avatar::before{
      content:'';
      position:absolute;
      inset:-40%;
      background:conic-gradient(from 0deg,rgba(129,140,248,0.25),rgba(244,114,182,0.4),rgba(250,204,21,0.4),rgba(129,140,248,0.25));
      animation:nftSpin 3.2s linear infinite;
      mix-blend-mode:screen;
    }
    @keyframes nftSpin{to{transform:rotate(360deg);}}
    .nft-avatar-inner{position:relative;z-index:1;text-shadow:0 0 16px rgba(129,140,248,0.9);}
    .nft-info h3{margin:0;font-size:14.5px;}
    .nft-info-sub{font-size:11.5px;color:var(--text-secondary);margin-top:2px;}
    .nft-meta-row{display:flex;gap:8px;margin-top:4px;font-size:10.5px;color:var(--text-secondary);}
    .tag{padding:2px 7px;border-radius:999px;border:1px solid rgba(148,163,184,0.6);font-size:10.5px;}
    .nft-circle-meter{
      margin-top:6px;display:flex;align-items:center;gap:7px;font-size:11px;color:var(--text-secondary);
    }
    .circle-wrap{
      width:42px;height:42px;border-radius:999px;border:2px solid rgba(148,163,184,0.75);
      display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;
      position:relative;overflow:hidden;
    }
    .circle-fill{
      position:absolute;inset:-10%;
      background:conic-gradient(#22c55e,#eab308,#f97316,#ef4444,#22c55e);
      transform:rotate(0deg);opacity:0;
    }
    .circle-inner{position:relative;z-index:1;background:#020617;border-radius:999px;padding:6px 8px;}
    .circle-wrap.upgrading .circle-fill{opacity:0.9;animation:circleSpin 1.4s linear infinite;}
    @keyframes circleSpin{to{transform:rotate(360deg);}}
    .nft-list{
      margin-top:8px;max-height:140px;overflow-y:auto;
      border-radius:12px;border:1px solid rgba(148,163,184,0.45);background:var(--bg-soft);font-size:11px;
    }
    .nft-row{
      padding:5px 7px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;
      transition:background 140ms ease;
    }
    .nft-row:nth-child(odd){background:rgba(15,23,42,0.95);}
    .nft-row:nth-child(even){background:rgba(15,23,42,0.8);}
    .nft-row:hover{background:rgba(37,99,235,0.5);}

    /* –º–∞–≥–∞–∑–∏–Ω / —Ç–æ–ø / –æ–±–º–µ–Ω / –∏—Å—Ç–æ—Ä–∏—è */
    .pack-row{display:flex;gap:8px;margin-top:6px;}
    .pack{
      flex:1;padding:9px;border-radius:14px;background:var(--bg-soft);
      border:1px solid rgba(148,163,184,0.5);font-size:11.5px;cursor:pointer;transition:all 0.16s;
    }
    .pack.selected{border-color:var(--glow-gold);box-shadow:0 0 20px var(--glow-gold);}
    .pack h4{margin-bottom:3px;font-size:12px;}
    .pack-desc{color:var(--text-secondary);}
    .leader-list{
      margin-top:5px;max-height:170px;overflow-y:auto;border-radius:12px;
      border:1px solid rgba(148,163,184,0.5);background:var(--bg-soft);font-size:11px;
    }
    .leader-row{
      padding:4px 7px;display:flex;justify-content:space-between;align-items:center;
    }
    .leader-row:nth-child(even){background:rgba(15,23,42,0.82);}
    .leader-score-balance{color:#bfdbfe;}
    .leader-score-inv{color:#facc15;}
    .textarea{
      width:100%;min-height:60px;background:var(--bg-soft);
      border-radius:10px;border:1px solid rgba(148,163,184,0.6);color:var(--text-primary);
      font-size:11px;padding:6px;resize:vertical;
    }
    .history-list{
      margin-top:5px;max-height:170px;overflow-y:auto;border-radius:12px;
      border:1px solid rgba(148,163,184,0.5);background:var(--bg-soft);font-size:11px;
    }
    .history-row{
      padding:4px 7px;border-bottom:1px solid rgba(15,23,42,0.9);
      display:flex;justify-content:space-between;gap:6px;
    }
    .history-row:last-child{border-bottom:none;}
    .history-time{color:var(--text-secondary);white-space:nowrap;}

    /* –∑–∞–¥–∞–Ω–∏—è */
    .task-list{
      margin-top:5px;max-height:160px;overflow-y:auto;border-radius:12px;
      border:1px solid rgba(148,163,184,0.5);background:var(--bg-soft);font-size:11px;
    }
    .task-row{
      padding:5px 7px;display:flex;justify-content:space-between;align-items:center;gap:4px;
    }
    .task-row:nth-child(even){background:rgba(15,23,42,0.82);}
    .task-title{font-weight:600;}
    .task-meta{color:var(--text-secondary);font-size:10px;}
    .task-btn{font-size:10.5px;padding:4px 8px;border-radius:999px;border:1px solid rgba(148,163,184,0.6);background:transparent;color:var(--text-primary);cursor:pointer;}
    .task-btn.done{border-color:#22c55e;color:#bbf7d0;}

    /* –Ω–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è */
    .bottom-nav{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(7,11,25,0.97);
      border-top:1px solid rgba(148,163,184,0.4);
      backdrop-filter:blur(18px);
      padding:6px 10px 10px;
      display:flex;gap:6px;z-index:20;
    }
    .nav-item{
      flex:1;text-align:center;padding:8px 4px 6px;border-radius:14px;
      font-size:11.5px;color:var(--text-secondary);cursor:pointer;
      display:flex;flex-direction:column;align-items:center;gap:1px;
      transition:all 0.16s;min-width:0;
    }
    .nav-item-icon{font-size:18px;}
    .nav-item.active{
      background:var(--glow-blue);color:#020617;box-shadow:0 0 22px var(--glow-blue);
    }
    @media(min-width:900px){
      .main{padding:16px 16px 96px;max-width:900px;margin:0 auto;}
      .bottom-nav{max-width:900px;left:50%;transform:translateX(-50%);}
    }

    /* –∫–Ω–æ–ø–∫–∏ */
    .btn{
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      transition:transform 140ms ease, box-shadow 140ms ease, background 140ms ease, color 140ms ease;
      white-space:nowrap;
      min-height:40px;
      touch-action:manipulation;
    }
    .btn-primary{
      background:var(--accent-gold);
      color:#0b1120;
      box-shadow:0 8px 22px var(--glow-gold);
    }
    .btn-primary:hover,
    .btn-primary:active{
      transform:translateY(-1px);
      box-shadow:0 10px 26px var(--glow-gold);
    }
    .btn-ghost{
      background:var(--bg-soft);
      color:var(--text-secondary);
      border:1px solid rgba(148,163,184,0.6);
    }
    .btn-ghost:hover,
    .btn-ghost:active{
      transform:translateY(-1px);
      box-shadow:0 8px 18px rgba(15,23,42,0.9);
    }
    .btn-danger{
      background:rgba(239,68,68,0.25);
      color:#fecaca;
      border:1px solid rgba(239,68,68,0.7);
    }
    .btn-danger:hover,
    .btn-danger:active{
      transform:translateY(-1px);
      box-shadow:0 8px 18px rgba(127,29,29,0.9);
    }
    .btn-small{
      padding:8px 10px;
      font-size:11px;
      min-height:36px;
    }

    /* –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å */
    .admin-row{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px;}
    .admin-row .btn-small{flex:1;min-width:0;}

    /* —Ç—Ä–µ–π–¥ –∞–Ω–∏–º–∞—Ü–∏—è */
    .trade-pulse{
      animation:tradePulse 1.4s infinite;
    }
    @keyframes tradePulse{
      0%{box-shadow:0 0 0 0 rgba(34,197,94,0.5);}
      70%{box-shadow:0 0 0 16px rgba(34,197,94,0);}
      100%{box-shadow:0 0 0 0 rgba(34,197,94,0);}
    }
  </style>
</head>
<body data-theme="default">
<canvas id="sparksCanvas"></canvas>
<div class="app">
  <main class="main">
    <!-- –ö–ï–ô–°–´ -->
    <section id="screen-cases" class="screen active">
      <div class="grid-2">
        <div class="card">
          <div class="card-header">
            <div class="card-title">üíé –ë–∞–ª–∞–Ω—Å</div>
            <div class="badge" id="badgeEvent">üî• –û–≥–Ω–µ–Ω–Ω–∞—è –Ω–µ–¥–µ–ª—è</div>
          </div>
          <div class="balance-main">
            <span id="balanceValue">15 000</span>
            <span class="unit">ü™ô</span>
          </div>
          <div class="sub-row">
            <div class="chip">–ò–≥—Ä–æ–∫: <span id="playerName">–ò–≥—Ä–æ–∫</span></div>
            <div class="chip">@<span id="playerUser">user</span></div>
            <div class="chip">–†–∞–Ω–≥: <span id="playerRank">–ù–æ–≤–∏—á–æ–∫</span></div>
            <div class="chip">–ö–µ–π—Å–æ–≤: <span id="totalCases">0</span></div>
          </div>
          <div class="sub-row" style="margin-top:5px;">
            <div class="chip" style="max-width:100%;">–õ—É—á—à–∏–π –¥—Ä–æ–ø: <span id="bestDrop">–Ω–µ—Ç</span></div>
          </div>
          <div class="streak-row">
            <span>üî• –°–µ—Ä–∏—è —É–¥–∞—á: <span id="streakWins">0</span></span>
            <span>–ú—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä: x<span id="streakMult">1.0</span></span>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">üìÜ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å</div>
            <div class="badge">+ –∏–≤–µ–Ω—Ç —à–∞–Ω—Å</div>
          </div>
          <div style="font-size:12px;color:var(--text-secondary);margin-bottom:6px;">
            –û–¥–∏–Ω –∫–ª–∏–∫ –≤ –¥–µ–Ω—å ‚Äî –∏ –ú–∞–∫—Å –ø–æ–¥–∫–∏–Ω–µ—Ç –º–æ–Ω–µ—Ç. –í –∏–≤–µ–Ω—Ç –¥—Ä–æ–ø —Å–æ—á–Ω–µ–µ.
          </div>
          <button id="btnDaily" class="btn btn-primary" style="width:100%;margin-bottom:4px;">–ó–∞–±—Ä–∞—Ç—å –±–æ–Ω—É—Å ü™ô</button>
          <button id="btnToggleEvent" class="btn btn-ghost btn-small" style="width:100%;">üî• –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∏–≤–µ–Ω—Ç (–ª–æ–∫–∞–ª—å–Ω–æ)</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">üé∞ –ö–µ–π—Å—ã</div>
          <div class="badge"><span id="caseCount">0</span> –∫–µ–π—Å–æ–≤</div>
        </div>
        <div class="case-filter-row" id="caseFilters">
          <div class="filter-pill active" data-filter="all">–í—Å–µ</div>
          <div class="filter-pill" data-filter="COMMON">Common</div>
          <div class="filter-pill" data-filter="RARE">Rare</div>
          <div class="filter-pill" data-filter="EPIC">Epic</div>
          <div class="filter-pill" data-filter="LEGENDARY">Legend</div>
          <div class="filter-pill" data-filter="MYTHIC">Mythic</div>
        </div>
        <div class="case-grid" id="caseGrid"></div>
      </div>

      <!-- –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">üëë –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨</div>
          <div class="badge">MAX POWER</div>
        </div>
        <div style="font-size:11.5px;color:var(--text-secondary);">
          –¢–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ. –ß–∏—Å—Ç–æ –¥–ª—è —Ç–µ—Å—Ç–∞, –º–µ–º–æ–≤ –∏ —Ä–∞–∑–æ–≥—Ä–µ–≤–∞.
        </div>
        <div class="admin-row">
          <button id="btnAdminPlus1M" class="btn btn-ghost btn-small">+1M ü™ô</button>
          <button id="btnAdminAll10M" class="btn btn-ghost btn-small">–í–°–ï–ú 10M</button>
          <button id="btnAdminToggleEvent" class="btn btn-ghost btn-small">üî• –¢–û–ì–ì–õ –ò–í–ï–ù–¢</button>
        </div>
      </div>
    </section>

    <!-- NFT -->
    <section id="screen-nft" class="screen">
      <div class="card">
        <div class="card-header">
          <div class="card-title">üéí NFT –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
          <div class="badge"><span id="nftCount">0</span> NFT</div>
        </div>
        <div id="nftMainBlock">
          <div style="font-size:12px;color:var(--text-secondary);">
            NFT —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —É–ª—É—á—à–µ–Ω–∏—è. –ü–æ–∫–∞ –ø—É—Å—Ç–æ ‚Äî —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–π –ø–∞—Ä—É –∫–µ–π—Å–æ–≤.
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">‚öóÔ∏è –ö—Ä–∞—Ñ—Ç –∏ —É–ª—É—á—à–µ–Ω–∏—è</div>
          <div class="badge">risk / reward</div>
        </div>
        <div style="font-size:11.5px;color:var(--text-secondary);margin-bottom:6px;">
          3 NFT = –Ω–æ–≤—ã–π, –≤—ã—à–µ –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏. –£–ª—É—á—à–∞—Ç–µ–ª—å ‚Äî —ç—Ç–æ —É–∂–µ –∞–∑–∞—Ä—Ç: –ª–∏–±–æ –≥–µ—Ä–æ–π, –ª–∏–±–æ –ø–µ–ø–µ–ª.
        </div>
        <div class="sub-row">
          <button id="btnCraft" class="btn btn-ghost btn-small">‚öóÔ∏è –ö–†–ê–§–¢ 3‚Üí1</button>
          <button id="btnUpgrade" class="btn btn-ghost btn-small">‚ö° –£–õ–£–ß–®–ò–¢–ï–õ–¨</button>
        </div>
      </div>
    </section>

    <!-- –ö–ê–°–°–ê / –í–´–í–û–î -->
    <section id="screen-shop" class="screen">
      <div class="card">
        <div class="card-header">
          <div class="card-title">üíé –ö–∞—Å—Å–∞ ELITE DEB</div>
          <div class="badge">NFT BATTLE STYLE</div>
        </div>
        <div style="font-size:11.5px;color:var(--text-secondary);margin-bottom:4px;">
          –ü–æ–∫–∞ –≤—Å—ë –ª–æ–∫–∞–ª—å–Ω–æ. –ü–æ—Ç–æ–º —Å—é–¥–∞ –º–æ–∂–Ω–æ –ø–æ–¥–≤—è–∑–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –¥–æ–Ω–∞—Ç –∏ –≤—ã–≤–æ–¥ —á–µ—Ä–µ–∑ –±–æ—Ç–∞.
        </div>
        <div class="pack-row">
          <div class="pack" data-pack="10k">
            <h4>Starter</h4>
            <div class="pack-desc">–î–ª—è —Ä–∞–∑–≥–æ–Ω–∞ ¬∑ +10 000 ü™ô</div>
          </div>
          <div class="pack" data-pack="50k">
            <h4>Grinder</h4>
            <div class="pack-desc">–ö–µ–π—Å—ã –Ω–æ–Ω-—Å—Ç–æ–ø ¬∑ +50 000 ü™ô</div>
          </div>
        </div>
        <div class="pack-row">
          <div class="pack" data-pack="250k">
            <h4>Whale</h4>
            <div class="pack-desc">NFT‚Äë–∏–º–ø–µ—Ä–∏—è ¬∑ +250 000 ü™ô</div>
          </div>
          <div class="pack" data-pack="1m">
            <h4>ELITE</h4>
            <div class="pack-desc">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–≥–æ–Ω ¬∑ +1 000 000 ü™ô</div>
          </div>
        </div>
        <div style="margin-top:7px;font-size:11.5px;">
          –¢–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä: <span id="packLabel" style="color:#fbbf24;">–Ω–µ –≤—ã–±—Ä–∞–Ω</span>
        </div>
        <div class="sub-row" style="margin-top:7px;">
          <button id="btnFakeTopup" class="btn btn-ghost" style="flex:1;">‚≠ê –§–µ–π–∫-–¥–æ–¥–µ–ø (–ª–æ–∫–∞–ª—å–Ω–æ)</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">üí∏ –í—ã–≤–æ–¥ (–¥–µ–º–æ)</div>
          <div class="badge">soon‚Ñ¢</div>
        </div>
        <div style="font-size:11.5px;color:var(--text-secondary);margin-bottom:4px;">
          –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ —á–µ—Ä–µ–∑ –±–æ—Ç–∞. –°–µ–π—á–∞—Å —ç—Ç–æ —á–∏—Å—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è.
        </div>
        <div class="sub-row">
          <div class="chip" style="max-width:100%;">–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –≤—ã–≤–æ–¥–∞: <span id="withdrawAvailable">0</span> ü™ô</div>
        </div>
        <button id="btnFakeWithdraw" class="btn btn-primary" style="margin-top:6px;width:100%;">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –≤—ã–≤–æ–¥ (—Ñ–µ–π–∫)</button>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">üëë VIP-–∫–æ–Ω—Ç—Ä–∞–∫—Ç —Å –ú–∞–∫—Å–æ–º</div>
          <div class="badge">24 —á–∞—Å–∞</div>
        </div>
        <div style="font-size:11.5px;color:var(--text-secondary);margin-bottom:4px;">
          –û—Ç–¥–∞—ë—à—å 10% –±–∞–ª–∞–Ω—Å–∞ –ú–∞–∫—Å—É ‚Äî –ø–æ–ª—É—á–∞–µ—à—å 24 —á–∞—Å–∞ –±—É—Å—Ç–æ–≤: x1.2 –∫ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ NFT –∏ –ø–æ–≤—ã—à–µ–Ω–Ω—ã–µ —à–∞–Ω—Å—ã.
        </div>
        <button id="btnVip" class="btn btn-primary" style="width:100%;">‚úíÔ∏è –ü–æ–¥–ø–∏—Å–∞—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç</button>
        <div id="vipStatus" style="margin-top:5px;font-size:11px;color:var(--text-secondary);">
          –ö–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω.
        </div>
      </div>
    </section>

    <!-- –¢–û–ü / –û–ë–ú–ï–ù / –ò–°–¢–û–†–ò–Ø / –†–ï–§–ï–†–ê–õ–ö–ê -->
    <section id="screen-top" class="screen">
      <div class="card">
        <div class="card-header">
          <div class="card-title">üèÜ –õ–∏–¥–µ—Ä—ã (–ª–æ–∫–∞–ª—å–Ω–æ)</div>
          <div class="badge">–±–∞–ª–∞–Ω—Å / NFT</div>
        </div>
        <div style="font-size:11.5px;color:var(--text-secondary);margin-bottom:4px;">
          –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ª —Å–ª–∞–≤—ã. –ö–∞–∂–¥—ã–π –∑–∞–ø—É—Å–∫ –º–∏–Ω–∏‚Äë–∞–ø–ø–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–≤–æ–π —Å—Ç–∞—Ç—É—Å.
        </div>
        <div style="font-size:10.5px;color:var(--text-secondary);margin-bottom:3px;">–ü–æ –±–∞–ª–∞–Ω—Å—É:</div>
        <div id="leadersBalance" class="leader-list"></div>
        <div style="font-size:10.5px;color:var(--text-secondary);margin:6px 0 3px;">–ü–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—é:</div>
        <div id="leadersInv" class="leader-list"></div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">üîÅ –û–±–º–µ–Ω NFT</div>
          <div class="badge">–∫—Ä—É—Ç–æ–π —Ç—Ä–µ–π–¥</div>
        </div>
        <div style="font-size:11.5px;color:var(--text-secondary);margin-bottom:4px;">
          –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—à—å –∫–æ–¥ ‚Äî –∫–∏–¥–∞–µ—à—å –µ–≥–æ –¥—Ä—É–≥—É. –û–Ω –≤—Å—Ç–∞–≤–ª—è–µ—Ç —É —Å–µ–±—è –∏ –∑–∞–±–∏—Ä–∞–µ—Ç –ø—Ä–µ–¥–º–µ—Ç. –ê–Ω–∏–º–∞—Ü–∏—è ‚Äî –∫–∞–∫ –±—É–¥—Ç–æ —Ç—ã —Ä–µ–∞–ª—å–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å –ø–æ—Å—ã–ª–∫—É.
        </div>
        <div style="font-size:10.5px;margin-bottom:3px;">–ö–æ–¥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (–∞–∫—Ç–∏–≤–Ω—ã–π NFT):</div>
        <textarea id="tradeCodeOut" class="textarea" readonly>–Ω–µ—Ç NFT –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏</textarea>
        <div style="font-size:10.5px;margin-top:5px;">–í—Å—Ç–∞–≤–∏—Ç—å –∫–æ–¥ –æ—Ç –¥—Ä—É–≥–∞:</div>
        <textarea id="tradeCodeIn" class="textarea" placeholder="–í—Å—Ç–∞–≤—å —Å—é–¥–∞ –∫–æ–¥ –æ–±–º–µ–Ω–∞..."></textarea>
        <div class="sub-row" style="margin-top:6px;">
          <button id="btnGenTrade" class="btn btn-ghost btn-small">üéØ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
          <button id="btnApplyTrade" class="btn btn-primary btn-small">‚úÖ –ü—Ä–∏–Ω—è—Ç—å NFT</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</div>
          <div class="badge">—Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</div>
        </div>
        <div style="font-size:11.5px;color:var(--text-secondary);margin-bottom:4px;">
          –î–µ–ª–∏—à—å—Å—è —Å—Å—ã–ª–∫–æ–π, –¥—Ä—É–≥ –∑–∞—Ö–æ–¥–∏—Ç ‚Äî –≤—ã –æ–±–∞ –ø–æ–ª—É—á–∞–µ—Ç–µ –±–æ–Ω—É—Å –º–æ–Ω–µ—Ç. –°–µ–π—á–∞—Å —ç—Ç–æ –¥–µ–º–æ, –Ω–æ –ª–æ–≥–∏–∫–∞ –∫–∞–∫ –≤ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Ä–µ—Ñ–µ—Ä–∞–ª–∫–µ.
        </div>
        <textarea id="refLink" class="textarea" readonly>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∑–∞—Ö–æ–¥–∞.</textarea>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">üìú –ò—Å—Ç–æ—Ä–∏—è</div>
          <div class="badge">–ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</div>
        </div>
        <div id="historyList" class="history-list"></div>
      </div>
    </section>

    <!-- –ù–ê–°–¢–†–û–ô–ö–ò / –ó–ê–î–ê–ù–ò–Ø / –¢–ï–ú–´ -->
    <section id="screen-settings" class="screen">
      <div class="card">
        <div class="card-header">
          <div class="card-title">‚úÖ –ó–∞–¥–∞–Ω–∏—è</div>
          <div class="badge">daily / hourly</div>
        </div>
        <div style="font-size:11.5px;color:var(--text-secondary);margin-bottom:4px;">
          –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∏ ‚Äú–ø–æ—á–∞—Å–æ–≤—ã–µ‚Äù –º–∏—Å—Å–∏–∏. –ù–∞ –¥–µ–ª–µ —Ç–∞–π–º–µ—Ä —Ä–∞–Ω–¥–æ–º–Ω—ã–π ‚Äî –∏–Ω–æ–≥–¥–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É, –∏–Ω–æ–≥–¥–∞ —á–µ—Ä–µ–∑ —á–∞—Å.
        </div>
        <div id="taskList" class="task-list"></div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">üé® –¢–µ–º–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</div>
          <div class="badge">–∫–∞–∫ –≤ NFT Battle</div>
        </div>
        <div class="sub-row">
          <button class="btn btn-ghost btn-small theme-btn" data-theme="default">–¢—ë–º–Ω–∞—è</button>
          <button class="btn btn-ghost btn-small theme-btn" data-theme="neon">–ù–µ–æ–Ω</button>
          <button class="btn btn-ghost btn-small theme-btn" data-theme="crimson">–ö—Ä–æ–≤—å</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
          <div class="badge">–ª–æ–∫–∞–ª—å–Ω–æ</div>
        </div>
        <div class="sub-row">
          <button id="btnVibration" class="btn btn-ghost btn-small">üì≥ –í–∏–±—Ä–∞—Ü–∏—è: –í–ö–õ</button>
          <button id="btnSound" class="btn btn-ghost btn-small">üîä –ó–≤—É–∫: –í–ö–õ</button>
        </div>
        <div style="margin-top:7px;font-size:11.5px;color:var(--text-secondary);">
          –ü—Ä–æ–≥—Ä–µ—Å—Å, –∑–∞–¥–∞–Ω–∏—è –∏ –∏—Å—Ç–æ—Ä–∏—è —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ localStorage Telegram‚Äë–±—Ä–∞—É–∑–µ—Ä–∞.
        </div>
        <button id="btnReset" class="btn btn-danger" style="margin-top:8px;width:100%;">üß® –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
        <button id="btnExit" class="btn btn-ghost" style="margin-top:6px;width:100%;">–ó–∞–∫—Ä—ã—Ç—å –º–∏–Ω–∏‚Äë–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
      </div>
    </section>
  </main>

  <!-- –Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å -->
  <nav class="bottom-nav">
    <div class="nav-item active" data-screen="cases">
      <span class="nav-item-icon">üé∞</span>
      <span class="nav-label">–ö–µ–π—Å—ã</span>
    </div>
    <div class="nav-item" data-screen="nft">
      <span class="nav-item-icon">üéí</span>
      <span class="nav-label">NFT</span>
    </div>
    <div class="nav-item" data-screen="shop">
      <span class="nav-item-icon">üíé</span>
      <span class="nav-label">–ö–∞—Å—Å–∞</span>
    </div>
    <div class="nav-item" data-screen="top">
      <span class="nav-item-icon">üèÜ</span>
      <span class="nav-label">–¢–æ–ø</span>
    </div>
    <div class="nav-item" data-screen="settings">
      <span class="nav-item-icon">‚öôÔ∏è</span>
      <span class="nav-label">–ó–∞–¥–∞–Ω–∏—è</span>
    </div>
  </nav>
</div>

<!-- –∞–Ω–∏–º–∞—Ü–∏—è –∫–µ–π—Å–∞ -->
<div id="caseAnimOverlay" class="case-anim-overlay">
  <div class="case-anim-box">
    <div class="case-anim-title" id="caseAnimTitle">–û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–µ–π—Å...</div>
    <div class="case-anim-status" id="caseAnimStatus">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ELITE RNG...</div>
    <div class="case-anim-lock" id="caseAnimLock">üîí</div>
    <div class="case-anim-bar">
      <div class="case-anim-fill" id="caseAnimFill"></div>
    </div>

    <!-- –†—É–ª–µ—Ç–∫–∞ NFT -->
    <div class="nft-reel-wrap">
      <div class="nft-reel-window">
        <div class="nft-reel" id="nftReel"></div>
      </div>
    </div>

    <div id="caseAnimDrop"></div>
  </div>
</div>

<script>
const tg = window.Telegram?.WebApp;
if (tg) tg.expand();

/* === –∏—Å–∫—Ä—ã (canvas) === */
const canvas = document.getElementById("sparksCanvas");
const ctx = canvas.getContext("2d");
let sparks = [];
function resizeCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize",resizeCanvas);
function initSparks(count=80){
  sparks=[];
  for(let i=0;i<count;i++){
    sparks.push({
      x:Math.random()*canvas.width,
      y:Math.random()*canvas.height,
      vy:0.4+Math.random()*0.8,
      vx:(Math.random()-0.5)*0.3,
      size:1+Math.random()*1.8,
      glow:0.4+Math.random()*0.6,
      color:Math.random()<0.5?"rgba(56,189,248,":"rgba(251,191,36,"
    });
  }
}
function drawSparks(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.globalCompositeOperation="lighter";
  sparks.forEach(s=>{
    ctx.beginPath();
    const alpha = 0.15 + s.glow*0.2;
    ctx.fillStyle = `${s.color}${alpha})`;
    ctx.arc(s.x,s.y,s.size,0,Math.PI*2);
    ctx.fill();
    s.y += s.vy;
    s.x += s.vx;
    if(s.y>canvas.height+10){s.y = -10; s.x = Math.random()*canvas.width;}
  });
  ctx.globalCompositeOperation="source-over";
  requestAnimationFrame(drawSparks);
}
resizeCanvas();
initSparks();
drawSparks();

/* === —Å–æ—Å—Ç–æ—è–Ω–∏–µ === */
let state = {
  player:{
    name:"–ò–≥—Ä–æ–∫",
    user:"user",
    balance:15000,
    totalCases:0,
    bestRarity:null,
    vipUntil:0,
    vibration:true,
    sound:true,
    streakWins:0
  },
  eventHot:true,
  nft:[],
  activeNftId:null,
  lastDailyTs:0,
  selectedPack:null,
  leaders:[],
  history:[],
  tasks:[],
  lastTaskRoll:0,
  theme:"default",
  refCode:null
};

const RARITIES=["COMMON","RARE","EPIC","LEGENDARY","MYTHIC"];
let CASES=[];
const STORAGE_KEY="elite_deb_nft_battle_v3";

/* —É—Ç–∏–ª–∏—Ç—ã */
function fmt(n){return n.toLocaleString("ru-RU");}
function rarCfg(r){
  switch(r){
    case"COMMON":return{label:"COMMON",class:"rarity-common",color:"#9ca3af",badge:"C"};
    case"RARE":return{label:"RARE",class:"rarity-rare",color:"#60a5fa",badge:"R"};
    case"EPIC":return{label:"EPIC",class:"rarity-epic",color:"#e9d5ff",badge:"E"};
    case"LEGENDARY":return{label:"LEGEND",class:"rarity-legendary",color:"#fef3c7",badge:"L"};
    case"MYTHIC":return{label:"MYTHIC",class:"rarity-mythic",color:"#fee2e2",badge:"M"};
    default:return{label:r,class:"rarity-common",color:"#9ca3af",badge:"?"};
  }
}
function randomName(r){
  const map={
    COMMON:["Street Chip","Rusty Core","Old Drive","Dust Key","Cheap Fragment"],
    RARE:["Virus Core","Neon Blade","Midnight Node","Cold Barrel","Blue Circuit"],
    EPIC:["Quantum Spike","Ghost Kernel","Stellar Mask","Abyss Dagger","Dark Beacon"],
    LEGENDARY:["Royal Matrix","Emperor Key","Crown Protocol","Gold Operator","Dragon Mask"],
    MYTHIC:["Omega Singularity","Godlike Seed","Chaos Script","Zero Origin","Myth Core"]
  };
  const arr=map[r]||map["COMMON"];
  const base=arr[Math.floor(Math.random()*arr.length)];
  const num=String(Math.floor(Math.random()*999)+1).padStart(3,"0");
  return `${base} #${num}`;
}
function estimateValue(nft){
  const baseMap={COMMON:2000,RARE:8000,EPIC:25000,LEGENDARY:80000,MYTHIC:240000};
  const base=baseMap[nft.rarity]||2000;
  let mult=1+nft.level*0.35;
  if(state.player.vipUntil>Date.now()) mult*=1.2;
  return Math.round(base*mult);
}
function bestRarity(current,n){
  if(!n) return current;
  if(!current) return n;
  return RARITIES.indexOf(n)>RARITIES.indexOf(current)?n:current;
}
function saveState(){
  try{localStorage.setItem(STORAGE_KEY,JSON.stringify(state));}catch(e){}
}
function loadState(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const data=JSON.parse(raw);
    state=Object.assign(state,data);
    if(!Array.isArray(state.nft)) state.nft=[];
    if(!Array.isArray(state.leaders)) state.leaders=[];
    if(!Array.isArray(state.history)) state.history=[];
    if(!Array.isArray(state.tasks)) state.tasks=[];
  }catch(e){}
}

/* –∏—Å—Ç–æ—Ä–∏—è */
function pushHistory(text){
  const now=new Date();
  const t=now.toTimeString().slice(0,5);
  state.history.unshift({time:t,text});
  if(state.history.length>40) state.history.pop();
  renderHistory();
  saveState();
}
function renderHistory(){
  const box=document.getElementById("historyList");
  if(!box) return;
  if(!state.history.length){
    box.innerHTML=`<div style="padding:6px;color:var(--text-secondary);">–ü–æ–∫–∞ —Ç–∏—Ö–æ. –û—Ç–∫—Ä–æ–π –ø–∞—Ä—É –∫–µ–π—Å–æ–≤ ‚Äî –∏ —Ç—É—Ç –æ–∂–∏–≤—ë—Ç.</div>`;
    return;
  }
  box.innerHTML=state.history.map(h=>`
    <div class="history-row">
      <span>${h.text}</span>
      <span class="history-time">${h.time}</span>
    </div>
  `).join("");
}

/* –∑–∞–¥–∞—á–∏ */
function genRandomTasks(){
  const now=Date.now();
  const dailyExists = state.tasks.some(t=>t.type==="daily");
  if(!dailyExists){
    state.tasks.push({
      id:"daily_"+now,
      type:"daily",
      title:"–û—Ç–∫—Ä–æ–π 5 –∫–µ–π—Å–æ–≤",
      target:5,
      progress:0,
      reward:5000,
      done:false
    });
    state.tasks.push({
      id:"daily_nft_"+now,
      type:"daily",
      title:"–ü–æ–ª—É—á–∏—Ç—å 1 EPIC+ NFT",
      target:1,
      progress:0,
      reward:8000,
      done:false
    });
  }
  const needNew = !state.tasks.some(t=>t.type==="hourly");
  const elapsed = now - state.lastTaskRoll;
  if(needNew || elapsed>60*60*1000 || (elapsed>60*1000 && Math.random()<0.3)){
    const variants=[
      {title:"–û—Ç–∫—Ä–æ–π 3 –ª—é–±—ã—Ö –∫–µ–π—Å–∞",target:3,reward:3000},
      {title:"–°–¥–µ–ª–∞–π 1 –∫—Ä–∞—Ñ—Ç 3‚Üí1",target:1,reward:6000},
      {title:"–ü–æ–ø—Ä–æ–±—É–π 1 –∞–ø–≥—Ä–µ–π–¥ NFT",target:1,reward:7000}
    ];
    const pick=variants[Math.floor(Math.random()*variants.length)];
    state.tasks = state.tasks.filter(t=>t.type!=="hourly");
    state.tasks.push({
      id:"hourly_"+now,
      type:"hourly",
      title:pick.title,
      target:pick.target,
      progress:0,
      reward:pick.reward,
      done:false
    });
    state.lastTaskRoll=now;
  }
}
function renderTasks(){
  const box=document.getElementById("taskList");
  if(!box) return;
  genRandomTasks();
  if(!state.tasks.length){
    box.innerHTML=`<div style="padding:6px;color:var(--text-secondary);">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç. –ú–∞–∫—Å –ø—Ä–∏–¥—ë—Ç –ø–æ–∑–∂–µ —Å –∑–∞–¥–∞—á–∞–º–∏.</div>`;
    return;
  }
  box.innerHTML=state.tasks.map(t=>{
    const progress=`${t.progress}/${t.target}`;
    const status=t.done?"–ì–æ—Ç–æ–≤–æ":"–ù–∞–≥—Ä–∞–¥–∞: +"+fmt(t.reward)+" ü™ô";
    return `
      <div class="task-row">
        <div>
          <div class="task-title">${t.title}</div>
          <div class="task-meta">${t.type==="daily"?"–ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ":"–†–∞–Ω–¥–æ–º–Ω–æ–µ"} ¬∑ ${progress}</div>
        </div>
        <button class="task-btn ${t.done?"done":""}" data-task-id="${t.id}">
          ${t.done?"–ó–∞–±—Ä–∞—Ç—å":"..." }
        </button>
      </div>
    `;
  }).join("");
  box.querySelectorAll(".task-btn").forEach(btn=>{
    btn.onclick=()=>{
      const id=btn.dataset.taskId;
      const task=state.tasks.find(t=>t.id===id);
      if(!task) return;
      if(!task.done){
        alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏ –∑–∞–¥–∞—á—É.");
        return;
      }
      state.player.balance+=task.reward;
      pushHistory(`–ó–∞–¥–∞–Ω–∏–µ: "${task.title}" ‚Äî –Ω–∞–≥—Ä–∞–¥–∞ +${fmt(task.reward)} ü™ô`);
      state.tasks = state.tasks.filter(t=>t.id!==id);
      saveState();
      renderTasks();
      updateHeader();
    };
  });
}
function progressTask(kind){
  let changed=false;
  state.tasks.forEach(t=>{
    if(t.done) return;
    if(kind==="case_open" && t.title.includes("–∫–µ–π—Å–æ–≤")){
      t.progress=Math.min(t.target,t.progress+1);
    }
    if(kind==="craft" && t.title.includes("–∫—Ä–∞—Ñ—Ç")){
      t.progress=Math.min(t.target,t.progress+1);
    }
    if(kind==="upgrade" && t.title.includes("–∞–ø–≥—Ä–µ–π–¥")){
      t.progress=Math.min(t.target,t.progress+1);
    }
    if(kind==="epic_plus" && t.title.includes("EPIC")){
      t.progress=Math.min(t.target,t.progress+1);
    }
    if(t.progress>=t.target && !t.done){
      t.done=true;
      changed=true;
      pushHistory(`–ó–∞–¥–∞–Ω–∏–µ "${t.title}" –≤—ã–ø–æ–ª–Ω–µ–Ω–æ. –ó–∞–±–µ—Ä–∏ –Ω–∞–≥—Ä–∞–¥—É.`);
    }
  });
  if(changed){
    saveState();
    renderTasks();
  }
}

/* –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–µ–π—Å–æ–≤ */
function genCases(){
  const templates=[
    {baseName:"–£–ª–∏—á–Ω—ã–π",rarity:"COMMON",basePrice:800,desc:"–î–µ—à—ë–≤—ã–π –≥—Ä—è–∑–Ω—ã–π —Ä–∞–Ω–¥–æ–º."},
    {baseName:"–ü–æ–¥–≤–æ—Ä–æ—Ç–Ω—è",rarity:"COMMON",basePrice:1200,desc:"–ú—É—Å–æ—Ä, –Ω–æ –∏–Ω–æ–≥–¥–∞ –±–ª–µ—Å—Ç–∏—Ç."},
    {baseName:"–ì–æ—Ä–æ–¥—Å–∫–æ–π –º–∏—Ñ",rarity:"RARE",basePrice:4000,desc:"–†–µ–¥–∫–∏–µ –ª–µ–≥–µ–Ω–¥—ã —Å–ø–∞–ª—å–Ω–æ–≥–æ —Ä–∞–π–æ–Ω–∞."},
    {baseName:"–ù–æ—á–Ω–∞—è —Å–º–µ–Ω–∞",rarity:"RARE",basePrice:6000,desc:"–ò–≥—Ä–∞—Ç—å –ø–æ—Å–ª–µ –ø–æ–ª—É–Ω–æ—á–∏ ‚Äî —Ç–≤–æ–π –≤—ã–±–æ—Ä."},
    {baseName:"–ö—Ä–æ–≤–∞–≤—ã–π —Ä–∞—Å—Å–≤–µ—Ç",rarity:"EPIC",basePrice:13000,desc:"–°–æ–ª–Ω—Ü–µ –∏–¥—ë—Ç, –∞ –±–∞–Ω–∫ –≥—É–ª—è–µ—Ç."},
    {baseName:"–õ–∞–≤–∞",rarity:"EPIC",basePrice:17000,desc:"–ú–æ–∂–µ—Ç –æ–±–∂–µ—á—å, –º–æ–∂–µ—Ç –æ—Å–≤–µ—Ç–∏—Ç—å."},
    {baseName:"–¢—Ä–æ–Ω —É–¥–∞—á–∏",rarity:"LEGENDARY",basePrice:55000,desc:"–î–ª—è —Ç–µ—Ö, –∫—Ç–æ –Ω–µ –±–æ–∏—Ç—Å—è —Å–º–æ—Ç—Ä–µ—Ç—å –≤–Ω–∏–∑."},
    {baseName:"–û–ª–∏–º–ø –±–æ–≥–æ–≤",rarity:"MYTHIC",basePrice:160000,desc:"–ó–¥–µ—Å—å RNG –ø–∏—à–µ—Ç –∑–∞–∫–æ–Ω—ã."}
  ];
  const weightsByRarity={
    COMMON:{COMMON:70,RARE:20,EPIC:8,LEGENDARY:2,MYTHIC:0},
    RARE:{COMMON:45,RARE:30,EPIC:18,LEGENDARY:6,MYTHIC:1},
    EPIC:{COMMON:28,RARE:30,EPIC:28,LEGENDARY:10,MYTHIC:4},
    LEGENDARY:{COMMON:18,RARE:25,EPIC:30,LEGENDARY:18,MYTHIC:9},
    MYTHIC:{COMMON:10,RARE:20,EPIC:30,LEGENDARY:25,MYTHIC:15}
  };
  const out=[];
  let idCounter=1;
  templates.forEach(t=>{
    for(let i=0;i<32;i++){
      const price=t.basePrice+ i*250*(RARITIES.indexOf(t.rarity)+1);
      const suffix=i===0?"I":i===1?"II":i===2?"III":`#${i+1}`;
      out.push({
        id:`${t.baseName}_${idCounter}`,
        name:`${t.baseName} ${suffix}`,
        rarity:t.rarity,
        price,
        desc:t.desc,
        weights:weightsByRarity[t.rarity]
      });
      idCounter++;
    }
  });
  CASES=out;
}

/* —Ä–µ–Ω–¥–µ—Ä –∫–µ–π—Å–æ–≤ */
let currentFilter="all";
function renderCases(){
  const grid=document.getElementById("caseGrid");
  grid.innerHTML="";
  CASES.filter(c=>currentFilter==="all"||c.rarity===currentFilter).forEach(c=>{
    const rar=rarCfg(c.rarity);
    const div=document.createElement("div");
    div.className="case-card";
    div.dataset.caseId=c.id;
    div.innerHTML=`
      <div class="case-header">
        <div class="case-name">${c.name}</div>
        <div class="case-price">${fmt(c.price)} ü™ô</div>
      </div>
      <div class="case-desc">${c.desc}</div>
      <div class="case-rarity-tag ${rar.class}" style="color:${rar.color}">${rar.label}</div>
    `;
    div.onclick=()=>openCase(c);
    grid.appendChild(div);
  });
  document.getElementById("caseCount").textContent=CASES.filter(c=>currentFilter==="all"||c.rarity===currentFilter).length;
}

/* RNG */
function pickRarity(weights){
  const entries=Object.entries(weights);
  let sum=entries.reduce((a,[_r,w])=>a+w,0);
  let roll=Math.random()*sum;
  for(const [r,w] of entries){
    if(roll<w) return r;
    roll-=w;
  }
  return "COMMON";
}

/* –∞–Ω–∏–º–∞—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–µ–π—Å–∞ + –∏–Ω—Ç–µ—Ä–µ—Å */
let caseAnimRunning=false;
function openCase(caseObj){
  if(caseAnimRunning) return;
  if(state.player.balance<caseObj.price){
    alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç.");
    return;
  }
  state.player.balance-=caseObj.price;
  state.player.totalCases++;
  progressTask("case_open");
  saveState();
  updateHeader();

  const overlay=document.getElementById("caseAnimOverlay");
  const title=document.getElementById("caseAnimTitle");
  const status=document.getElementById("caseAnimStatus");
  const lock=document.getElementById("caseAnimLock");
  const fill=document.getElementById("caseAnimFill");
  const dropBox=document.getElementById("caseAnimDrop");
  const reel=document.getElementById("nftReel");

  caseAnimRunning=true;
  overlay.classList.add("active");
  dropBox.innerHTML="";
  reel.innerHTML="";
  reel.style.transform="translateY(0px)";
  fill.style.width="0%";
  title.textContent=`${caseObj.name}`;
  status.textContent="RNG –∑–∞–≤–æ–¥–∏—Ç—Å—è...";
  lock.textContent="üîí";

  // –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º 20 NFT –≤ —Ä—É–ª–µ—Ç–∫—É
  const reelItems=[];
  for(let i=0;i<20;i++){
    const r = pickRarity(caseObj.weights);
    reelItems.push({
      rarity:r,
      name:randomName(r),
      level:Math.random()<0.3?1:0
    });
  }
  reel.innerHTML=reelItems.map(item=>{
    const rar=rarCfg(item.rarity);
    const val=fmt(estimateValue({rarity:item.rarity,level:item.level}));
    return `
      <div class="nft-reel-card">
        <div class="nft-reel-card-inner">
          <div class="nft-reel-badge" style="background:${rar.color}33;border:1px solid ${rar.color};">
            ${rar.badge}
          </div>
          <div class="nft-reel-info">
            <div class="nft-reel-name">${item.name}</div>
            <div class="nft-reel-meta">${item.rarity} ¬∑ LVL ${item.level}</div>
            <div class="nft-reel-value">~${val} ü™ô</div>
          </div>
        </div>
      </div>
    `;
  }).join("");

  // –∞–Ω–∏–º–∞—Ü–∏—è –±–∞—Ä–∞ + —Ä—É–ª–µ—Ç–∫–∏
  let progress=0;
  const interval=setInterval(()=>{
    progress+=Math.random()*18+7;
    if(progress>100) progress=100;
    fill.style.width=progress+"%";
    if(progress>40) status.textContent="–ë–∏—Ç–≤–∞ —Å —à–∞–Ω—Å–∞–º–∏...";
    if(progress>75) status.textContent="RNG –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–≤–æ–π NFT...";
    if(progress>=100){
      clearInterval(interval);
      // —Ñ–∏–Ω–∞–ª—å–Ω—ã–π NFT
      const winningIndex=15+Math.floor(Math.random()*3);
      const item=reelItems[Math.min(winningIndex,reelItems.length-1)];
      const cardHeight=88;
      const offset=(winningIndex-1)*cardHeight;
      setTimeout(()=>{
        reel.style.transform=`translateY(-${offset}px)`;
        setTimeout(()=>{
          lock.textContent="‚úÖ";
          status.textContent="–î—Ä–æ–ø –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω.";
          showDropResult(item,caseObj);
          caseAnimRunning=false;
        },1000);
      },150);
    }
  },160);
}
function showDropResult(item,caseObj){
  const dropBox=document.getElementById("caseAnimDrop");
  const rar=rarCfg(item.rarity);
  const nftId=Date.now()+"_"+Math.random().toString(16).slice(2);
  const nft={id:nftId,rarity:item.rarity,name:item.name,level:item.level,createdAt:Date.now()};
  state.nft.push(nft);
  state.player.bestRarity=bestRarity(state.player.bestRarity,nft.rarity);
  const val=fmt(estimateValue(nft));

  // —Å–µ—Ä–∏—è —É–¥–∞—á: –µ—Å–ª–∏ EPIC+, –ø—Ä–∏–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–∏–∫
  if(RARITIES.indexOf(nft.rarity)>=RARITIES.indexOf("EPIC")){
    state.player.streakWins++;
  }else{
    state.player.streakWins=0;
  }

  const mult = 1+state.player.streakWins*0.1;
  const multText = state.player.streakWins>0?`–°–µ—Ä–∏—è x${mult.toFixed(1)} ‚Äî —à–∞–Ω—Å –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –µ—â—ë –≤–∫—É—Å–Ω–µ–µ.`:"–ù–∞—á–Ω–∏ —Å–µ—Ä–∏—é —Ö–æ—Ä–æ—à–∏–º –¥—Ä–æ–ø–æ–º.";
  dropBox.innerHTML=`
    <div class="case-drop" style="border-color:${rar.color};box-shadow:0 0 26px ${rar.color};">
      <div style="font-weight:700;color:${rar.color};margin-bottom:4px;">${nft.rarity} –¥—Ä–æ–ø!</div>
      <div style="font-size:12px;margin-bottom:4px;">${nft.name} ¬∑ LVL ${nft.level}</div>
      <div style="font-size:11.5px;color:#fbbf24;margin-bottom:4px;">–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å: ~${val} ü™ô</div>
      <div style="font-size:11px;color:var(--text-secondary);">${multText}</div>
      <button class="btn btn-ghost btn-small" style="margin-top:6px;width:100%;" onclick="document.getElementById('caseAnimOverlay').classList.remove('active');">
        –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
      </button>
    </div>
  `;
  pushHistory(`–ö–µ–π—Å "${caseObj.name}" ‚Äî ${nft.rarity} ${nft.name}`);
  if(RARITIES.indexOf(nft.rarity)>=RARITIES.indexOf("EPIC")) progressTask("epic_plus");
  saveState();
  updateHeader();
  renderNft();
}

/* –Ω–∞–≤–∏–≥–∞—Ü–∏—è */
function initNav(){
  document.querySelectorAll(".nav-item").forEach(item=>{
    item.onclick=()=>{
      const screen=item.dataset.screen;
      document.querySelectorAll(".nav-item").forEach(i=>i.classList.remove("active"));
      document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
      item.classList.add("active");
      document.getElementById("screen-"+screen).classList.add("active");
    };
  });
}

/* header/balance */
function updateHeader(){
  document.getElementById("balanceValue").textContent=fmt(state.player.balance);
  document.getElementById("playerName").textContent=state.player.name;
  document.getElementById("playerUser").textContent=state.player.user;
  document.getElementById("totalCases").textContent=state.player.totalCases;
  document.getElementById("bestDrop").textContent=state.player.bestRarity?rarCfg(state.player.bestRarity).label:"–Ω–µ—Ç";
  document.getElementById("streakWins").textContent=state.player.streakWins;
  document.getElementById("streakMult").textContent=(1+state.player.streakWins*0.1).toFixed(1);
  document.getElementById("badgeEvent").textContent=state.eventHot?"üî• –û–≥–Ω–µ–Ω–Ω–∞—è –Ω–µ–¥–µ–ª—è":"üí§ –°–ø–æ–∫–æ–π–Ω—ã–π —Ä–µ–∂–∏–º";
}

/* daily –±–æ–Ω—É—Å */
function initDaily(){
  const btn=document.getElementById("btnDaily");
  btn.onclick=()=>{
    const now=Date.now();
    if(now - state.lastDailyTs < 20*60*60*1000){
      alert("–ï—â—ë —Ä–∞–Ω–æ. –ó–∞–π–¥–∏ –ø–æ–∑–∂–µ –∑–∞ –±–æ–Ω—É—Å–æ–º.");
      return;
    }
    const base=5000;
    const bonus=state.eventHot?base*1.5:base;
    state.player.balance+=Math.round(bonus);
    state.lastDailyTs=now;
    pushHistory(`–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å: +${fmt(Math.round(bonus))} ü™ô`);
    saveState();
    updateHeader();
  };
  document.getElementById("btnToggleEvent").onclick=()=>{
    state.eventHot=!state.eventHot;
    updateHeader();
    saveState();
  };
}

/* NFT —Ä–µ–Ω–¥–µ—Ä */
function renderNft(){
  const count=document.getElementById("nftCount");
  const main=document.getElementById("nftMainBlock");
  count.textContent=state.nft.length;
  if(!state.nft.length){
    main.innerHTML=`<div style="font-size:12px;color:var(--text-secondary);">
      NFT –ø–æ–∫–∞ –Ω–µ—Ç. –û—Ç–∫—Ä–æ–π –ø–∞—Ä—É –∫–µ–π—Å–æ–≤, —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å –ø–µ—Ä–≤—É—é –ø–∞—á–∫—É.
    </div>`;
    state.activeNftId=null;
    return;
  }
  if(!state.activeNftId) state.activeNftId=state.nft[0].id;
  const active = state.nft.find(n=>n.id===state.activeNftId) || state.nft[0];
  state.activeNftId=active.id;
  const rar=rarCfg(active.rarity);
  const val=fmt(estimateValue(active));

  const listHtml=state.nft.map(n=>{
    const isActive=n.id===active.id;
    return `
      <div class="nft-row" style="${isActive?'border-left:2px solid '+rarCfg(n.rarity).color:'border-left:2px solid transparent'}" data-nft-id="${n.id}">
        <span>${n.name}</span>
        <span style="color:${rarCfg(n.rarity).color};font-size:10px;">${n.rarity} ¬∑ LVL ${n.level}</span>
      </div>
    `;
  }).join("");

  main.innerHTML=`
    <div class="nft-main">
      <div class="nft-avatar">
        <div class="nft-avatar-inner">${rar.badge}</div>
      </div>
      <div class="nft-info">
        <h3>${active.name}</h3>
        <div class="nft-info-sub">${active.rarity} ¬∑ LVL ${active.level}</div>
        <div class="nft-meta-row">
          <span class="tag">~${val} ü™ô</span>
          <span class="tag">#${active.id.slice(-4)}</span>
        </div>
        <div class="nft-circle-meter">
          <div class="circle-wrap">
            <div class="circle-fill"></div>
            <div class="circle-inner">LVL ${active.level}</div>
          </div>
          <span>–°–æ–∑–¥–∞–Ω: ${new Date(active.createdAt).toLocaleDateString("ru-RU")}</span>
        </div>
      </div>
    </div>
    <div class="nft-list">${listHtml}</div>
  `;
  main.querySelectorAll(".nft-row").forEach(row=>{
    row.onclick=()=>{
      state.activeNftId=row.dataset.nftId;
      renderNft();
      saveState();
    };
  });
}

/* –∫—Ä–∞—Ñ—Ç –∏ –∞–ø–≥—Ä–µ–π–¥ */
function initCraftUpgrade(){
  document.getElementById("btnCraft").onclick=()=>{
    if(state.nft.length<3){
      alert("–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 NFT.");
      return;
    }
    // –±–µ—Ä—ë–º 3 —Å–∞–º—ã—Ö –¥–µ—à—ë–≤—ã—Ö
    const sorted=[...state.nft].sort((a,b)=>estimateValue(a)-estimateValue(b));
    const taken=sorted.slice(0,3);
    const minRarityIdx=Math.max(0, Math.min(...taken.map(n=>RARITIES.indexOf(n.rarity)))+1);
    const newRarity=RARITIES[minRarityIdx] || "EPIC";
    const newNft={
      id:Date.now()+"_"+Math.random().toString(16).slice(2),
      rarity:newRarity,
      name:randomName(newRarity),
      level:0,
      createdAt:Date.now()
    };
    state.nft=state.nft.filter(n=>!taken.includes(n));
    state.nft.push(newNft);
    state.player.bestRarity=bestRarity(state.player.bestRarity,newNft.rarity);
    pushHistory(`–ö—Ä–∞—Ñ—Ç 3‚Üí1 ‚Äî –ø–æ–ª—É—á–µ–Ω ${newNft.rarity} ${newNft.name}`);
    progressTask("craft");
    saveState();
    renderNft();
  };

  document.getElementById("btnUpgrade").onclick=()=>{
    if(!state.activeNftId){
      alert("–í—ã–±–µ—Ä–∏ NFT –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ.");
      return;
    }
    const nft=state.nft.find(n=>n.id===state.activeNftId);
    if(!nft) return;
    const upgradeCost=Math.round(estimateValue(nft)*0.3);
    if(state.player.balance<upgradeCost){
      alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç –Ω–∞ —É–ª—É—á—à–µ–Ω–∏–µ.");
      return;
    }
    if(!confirm(`–ê–ø–≥—Ä–µ–π–¥ —Å—Ç–æ–∏—Ç ${fmt(upgradeCost)} ü™ô. –ï—Å–ª–∏ –Ω–µ –ø–æ–≤–µ–∑—ë—Ç ‚Äî NFT —Å–≥–æ—Ä–∏—Ç. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`)) return;
    state.player.balance-=upgradeCost;
    const circle=document.querySelector(".circle-wrap");
    if(circle) circle.classList.add("upgrading");
    setTimeout(()=>{
      const successChance=0.55;
      if(Math.random()<successChance){
        nft.level++;
        pushHistory(`–£—Å–ø–µ—à–Ω—ã–π –∞–ø–≥—Ä–µ–π–¥: ${nft.name} —Ç–µ–ø–µ—Ä—å LVL ${nft.level}`);
        progressTask("upgrade");
      }else{
        pushHistory(`–ü—Ä–æ–≤–∞–ª—å–Ω—ã–π –∞–ø–≥—Ä–µ–π–¥: ${nft.name} —Å–≥–æ—Ä–µ–ª.`);
        state.nft=state.nft.filter(n=>n.id!==nft.id);
        state.activeNftId=state.nft[0]?.id||null;
      }
      if(circle) circle.classList.remove("upgrading");
      saveState();
      renderNft();
      updateHeader();
    },700);
  };
}

/* —Ç—Ä–µ–π–¥ –∫–æ–¥—ã —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π */
function initTrade(){
  const out=document.getElementById("tradeCodeOut");
  const input=document.getElementById("tradeCodeIn");
  const btnGen=document.getElementById("btnGenTrade");
  const btnApply=document.getElementById("btnApplyTrade");

  btnGen.onclick=()=>{
    if(!state.activeNftId){
      alert("–í—ã–±–µ—Ä–∏ NFT –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.");
      return;
    }
    const nft=state.nft.find(n=>n.id===state.activeNftId);
    if(!nft){
      alert("NFT –Ω–µ –Ω–∞–π–¥–µ–Ω.");
      return;
    }
    const payload={nft:{...nft},ts:Date.now()};
    const code=btoa(JSON.stringify(payload));
    out.value=code;
    out.classList.add("trade-pulse");
    setTimeout(()=>out.classList.remove("trade-pulse"),1800);
    pushHistory(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∫–æ–¥ —Ç—Ä–µ–π–¥–∞ –¥–ª—è ${nft.name}`);
  };

  btnApply.onclick=()=>{
    const code=input.value.trim();
    if(!code){
      alert("–í—Å—Ç–∞–≤—å –∫–æ–¥.");
      return;
    }
    let payload;
    try{
      payload=JSON.parse(atob(code));
    }catch(e){
      alert("–ö–æ–¥ –ø–æ–≤—Ä–µ–∂–¥—ë–Ω.");
      return;
    }
    if(!payload.nft || !payload.nft.id){
      alert("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–¥–∞.");
      return;
    }
    const exists=state.nft.some(n=>n.id===payload.nft.id);
    if(exists){
      alert("–≠—Ç–æ—Ç NFT —É–∂–µ —É —Ç–µ–±—è.");
      return;
    }
    payload.nft.id=Date.now()+"_"+Math.random().toString(16).slice(2);
    payload.nft.createdAt=Date.now();
    state.nft.push(payload.nft);
    state.player.bestRarity=bestRarity(state.player.bestRarity,payload.nft.rarity);
    pushHistory(`–ü–æ–ª—É—á–µ–Ω NFT –ø–æ –∫–æ–¥—É: ${payload.nft.rarity} ${payload.nft.name}`);
    input.value="";
    saveState();
    renderNft();
  };
}

/* –ª–∏–¥–µ—Ä—ã */
function renderLeaders(){
  const lb=document.getElementById("leadersBalance");
  const li=document.getElementById("leadersInv");
  const self={
    name:state.player.name,
    user:state.player.user,
    balance:state.player.balance,
    nftCount:state.nft.length
  };
  state.leaders=[self]; // –ª–æ–∫–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ –æ–¥–∏–Ω –∏–≥—Ä–æ–∫
  lb.innerHTML=state.leaders.map((p,i)=>`
    <div class="leader-row">
      <span>${i+1}. ${p.name}</span>
      <span class="leader-score-balance">${fmt(p.balance)} ü™ô</span>
    </div>
  `).join("");
  li.innerHTML=state.leaders.map((p,i)=>`
    <div class="leader-row">
      <span>${i+1}. ${p.name}</span>
      <span class="leader-score-inv">${p.nftCount} NFT</span>
    </div>
  `).join("");
}

/* –∫–∞—Å—Å–∞/–ø–∞–∫–µ—Ç—ã */
function initShop(){
  document.querySelectorAll(".pack").forEach(p=>{
    p.onclick=()=>{
      document.querySelectorAll(".pack").forEach(pp=>pp.classList.remove("selected"));
      p.classList.add("selected");
      state.selectedPack=p.dataset.pack;
      document.getElementById("packLabel").textContent=p.querySelector("h4").textContent;
      saveState();
    };
  });
  document.getElementById("btnFakeTopup").onclick=()=>{
    let add=0;
    switch(state.selectedPack){
      case"10k":add=10000;break;
      case"50k":add=50000;break;
      case"250k":add=250000;break;
      case"1m":add=1000000;break;
      default:return alert("–í—ã–±–µ—Ä–∏ –ø–∞–∫.");
    }
    state.player.balance+=add;
    pushHistory(`–§–µ–π–∫-–¥–æ–¥–µ–ø: +${fmt(add)} ü™ô`);
    saveState();
    updateHeader();
  };
  document.getElementById("btnFakeWithdraw").onclick=()=>{
    const available = Math.round(state.player.balance*0.3);
    document.getElementById("withdrawAvailable").textContent=fmt(available);
    alert("–§–µ–π–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –≤—ã–≤–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –ö–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–π –±–æ—Ç ‚Äî —Å—é–¥–∞ –ø—Ä–∏–≤—è–∂–µ–º.");
  };
  document.getElementById("btnVip").onclick=()=>{
    const fee=Math.round(state.player.balance*0.1);
    if(fee<=0){
      alert("–°–ª–∏—à–∫–æ–º –º–∞–ª–æ –º–æ–Ω–µ—Ç –¥–ª—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞.");
      return;
    }
    if(!confirm(`10% –±–∞–ª–∞–Ω—Å–∞ (${fmt(fee)} ü™ô) —É–π–¥—ë—Ç –ú–∞–∫—Å—É. –í–∑–∞–º–µ–Ω ‚Äî x1.2 –∫ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ NFT –Ω–∞ 24 —á–∞—Å–∞. –û–∫?`))return;
    state.player.balance-=fee;
    state.player.vipUntil=Date.now()+24*60*60*1000;
    document.getElementById("vipStatus").textContent="VIP –∞–∫—Ç–∏–≤–µ–Ω 24 —á–∞—Å–∞. –ö—Ä—É—Ç–∏ –ø–æ –ø–æ–ª–Ω–æ–π.";
    pushHistory(`VIP-–∫–æ–Ω—Ç—Ä–∞–∫—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –ó–∞ –≤—Ö–æ–¥ –∑–∞–ø–ª–∞—á–µ–Ω–æ ${fmt(fee)} ü™ô`);
    saveState();
    updateHeader();
  };
}

/* —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ (–¥–µ–º–æ) */
function initReferral(){
  const refArea=document.getElementById("refLink");
  if(!state.refCode){
    state.refCode=Math.random().toString(36).slice(2,10);
    saveState();
  }
  const baseUrl=location.origin+location.pathname;
  const link=`${baseUrl}?ref=${state.refCode}`;
  refArea.value=link;
}

/* —Ñ–∏–ª—å—Ç—Ä—ã –∫–µ–π—Å–æ–≤ */
function initCaseFilters(){
  document.querySelectorAll(".filter-pill").forEach(p=>{
    p.onclick=()=>{
      document.querySelectorAll(".filter-pill").forEach(pp=>pp.classList.remove("active"));
      p.classList.add("active");
      currentFilter=p.dataset.filter;
      renderCases();
    };
  });
}

/* –Ω–∞—Å—Ç—Ä–æ–π–∫–∏/—Ç–µ–º—ã */
function initSettings(){
  const vib=document.getElementById("btnVibration");
  const snd=document.getElementById("btnSound");
  function syncButtons(){
    vib.textContent=state.player.vibration?"üì≥ –í–∏–±—Ä–∞—Ü–∏—è: –í–ö–õ":"üì≥ –í–∏–±—Ä–∞—Ü–∏—è: –í–´–ö–õ";
    snd.textContent=state.player.sound?"üîä –ó–≤—É–∫: –í–ö–õ":"üîä –ó–≤—É–∫: –í–´–ö–õ";
  }
  vib.onclick=()=>{state.player.vibration=!state.player.vibration;syncButtons();saveState();};
  snd.onclick=()=>{state.player.sound=!state.player.sound;syncButtons();saveState();};
  syncButtons();

  document.getElementById("btnReset").onclick=()=>{
    if(!confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å?"))return;
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  };
  document.getElementById("btnExit").onclick=()=>{
    if(tg) tg.close();
  };

  document.querySelectorAll(".theme-btn").forEach(btn=>{
    btn.onclick=()=>{
      const theme=btn.dataset.theme;
      document.body.setAttribute("data-theme",theme);
      state.theme=theme;
      saveState();
    };
  });
  document.body.setAttribute("data-theme",state.theme||"default");
}

/* Telegram user */
function initUser(){
  if(tg && tg.initDataUnsafe && tg.initDataUnsafe.user){
    const u=tg.initDataUnsafe.user;
    state.player.name=(u.first_name||"–ò–≥—Ä–æ–∫");
    state.player.user=(u.username||"user");
    saveState();
  }
}

/* init */
function init(){
  loadState();
  initUser();
  genCases();
  initNav();
  initDaily();
  initCaseFilters();
  initCraftUpgrade();
  initTrade();
  initShop();
  initSettings();
  initReferral();
  renderCases();
  renderNft();
  renderLeaders();
  renderTasks();
  renderHistory();
  updateHeader();
}
init();

// –∑–∞–∫—Ä—ã—Ç–∏–µ –æ–≤–µ—Ä–ª–µ—è –ø–æ —Ñ–æ–Ω—É
document.getElementById("caseAnimOverlay").addEventListener("click",e=>{
  if(e.target.id==="caseAnimOverlay"){
    e.currentTarget.classList.remove("active");
    caseAnimRunning=false;
  }
});
</script>
</body>
</html>
