<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON CODER PRO | VISION + GEN</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root { 
            --neon: #00ff88; 
            --neon-dim: rgba(0, 255, 136, 0.3);
            --neon-glow: rgba(0, 255, 136, 0.5);
            --bg: #020502; 
            --glass: rgba(0, 255, 136, 0.08);
            --danger: #ff4444;
            --surface: #0a0f0a;
            --accent: #ff00ff;
            --gold: #ffd700;
        }
        
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
        }
        
        html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
        }
        
        body { 
            margin: 0; 
            padding: 0; 
            width: 100%; 
            height: 100%; 
            background: var(--bg); 
            color: #e8f5e9; 
            overflow: hidden; 
            position: fixed;
            font-size: 16px;
        }
        
        #canvas { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: -1; 
            pointer-events: none; 
        }
        
        .app { 
            display: flex; 
            flex-direction: column; 
            width: 100%; 
            height: 100%; 
            max-width: 100vw;
            overflow: hidden;
            position: relative;
        }
        
        .header { 
            padding: 12px 16px; 
            background: linear-gradient(180deg, rgba(0,0,0,0.95) 0%, rgba(0,20,10,0.9) 100%);
            border-bottom: 1px solid var(--neon-dim); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.15);
            z-index: 10; 
            flex-shrink: 0;
            min-height: 56px;
        }
        
        .header b { 
            color: var(--neon); 
            letter-spacing: 1px; 
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            animation: neonPulse 2s ease-in-out infinite;
            white-space: nowrap;
            text-shadow: 0 0 10px var(--neon-dim);
        }
        
        @keyframes neonPulse {
            0%, 100% { text-shadow: 0 0 10px var(--neon-dim), 0 0 20px var(--neon-dim); }
            50% { text-shadow: 0 0 20px var(--neon), 0 0 40px var(--neon), 0 0 60px var(--neon); }
        }
        
        .energy { 
            background: linear-gradient(135deg, var(--neon) 0%, #00cc6a 100%);
            color: #000; 
            padding: 6px 12px; 
            border-radius: 16px; 
            font-weight: 800; 
            font-size: 11px;
            animation: energyGlow 3s ease-in-out infinite, borderPulse 2s infinite;
            white-space: nowrap;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .energy::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        @keyframes borderPulse {
            0%, 100% { border-color: transparent; }
            50% { border-color: rgba(255,255,255,0.5); }
        }
        
        @keyframes energyGlow {
            0%, 100% { box-shadow: 0 0 15px rgba(0, 255, 136, 0.4), inset 0 0 10px rgba(255,255,255,0.1); }
            50% { box-shadow: 0 0 35px rgba(0, 255, 136, 0.9), 0 0 50px rgba(0, 255, 136, 0.5), inset 0 0 20px rgba(255,255,255,0.2); }
        }
        
        .energy.creator { 
            background: linear-gradient(135deg, var(--gold) 0%, #ffaa00 100%);
            animation: creatorGlow 2s ease-in-out infinite, borderPulseGold 2s infinite;
        }

        @keyframes borderPulseGold {
            0%, 100% { border-color: transparent; }
            50% { border-color: rgba(255,255,255,0.8); }
        }
        
        @keyframes creatorGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.6), inset 0 0 10px rgba(255,255,255,0.2); }
            50% { box-shadow: 0 0 40px rgba(255, 215, 0, 1), 0 0 60px rgba(255, 215, 0, 0.8), inset 0 0 30px rgba(255,255,255,0.4); }
        }

        #chat { 
            flex: 1; 
            overflow-y: auto; 
            overflow-x: hidden;
            padding: 16px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            scroll-behavior: smooth;
            background: linear-gradient(180deg, var(--bg) 0%, var(--surface) 100%);
            -webkit-overflow-scrolling: touch;
        }
        
        .msg { 
            max-width: 85%; 
            padding: 12px 16px; 
            border-radius: 16px; 
            font-size: 14px; 
            line-height: 1.5; 
            animation: messageAppear 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .msg:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }
        
        @keyframes messageAppear {
            0% { opacity: 0; transform: translateY(30px) scale(0.8) rotateX(-15deg); }
            60% { transform: translateY(-5px) scale(1.02) rotateX(5deg); }
            100% { opacity: 1; transform: translateY(0) scale(1) rotateX(0); }
        }
        
        .user { 
            background: linear-gradient(135deg, var(--neon) 0%, #00cc6a 100%);
            color: #001a0d; 
            align-self: flex-end; 
            font-weight: 600;
            border-bottom-right-radius: 4px;
            margin-left: 20px;
            position: relative;
            overflow: hidden;
        }

        .user::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }

        .user:hover::before {
            left: 100%;
        }
        
        .ai { 
            background: var(--surface);
            border: 1px solid var(--glass);
            align-self: flex-start; 
            border-bottom-left-radius: 4px;
            color: #e0f2e9;
            margin-right: 20px;
            position: relative;
        }

        .ai::after {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: 16px;
            padding: 1px;
            background: linear-gradient(135deg, var(--neon-dim), transparent, var(--neon-dim));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .ai:hover::after {
            opacity: 1;
        }
        
        .system { 
            background: rgba(255,68,68,0.08);
            border: 1px solid rgba(255,68,68,0.3);
            color: #ff8888; 
            align-self: center; 
            text-align: center;
            max-width: 90%;
            font-size: 13px;
            animation: glitch 2s infinite;
        }

        @keyframes glitch {
            0%, 90%, 100% { transform: translate(0); filter: none; }
            92% { transform: translate(-2px, 2px); filter: hue-rotate(90deg); }
            94% { transform: translate(2px, -2px); filter: hue-rotate(-90deg); }
            96% { transform: translate(-1px, 1px); }
        }
        
        .preview-img, .generated-img { 
            max-width: 100%; 
            height: auto;
            border-radius: 12px; 
            margin-top: 8px; 
            border: 1px solid var(--neon-dim);
            display: block;
            transition: all 0.3s ease;
        }

        .preview-img:hover {
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.3);
        }

        .generated-img {
            animation: imageGlow 3s ease-in-out infinite, floatImage 4s ease-in-out infinite;
            max-height: 400px;
            object-fit: contain;
        }

        @keyframes floatImage {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes imageGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 136, 0.2), 0 0 40px rgba(0, 255, 136, 0.1); }
            50% { box-shadow: 0 0 40px rgba(0, 255, 136, 0.6), 0 0 80px rgba(0, 255, 136, 0.3); }
        }

        .photo-preview { 
            background: rgba(0,255,136,0.05); 
            border: 2px dashed var(--neon-dim); 
            border-radius: 12px; 
            padding: 12px; 
            margin-bottom: 12px; 
            position: relative;
            max-width: 100%;
            animation: borderDash 3s linear infinite;
        }

        @keyframes borderDash {
            0% { border-style: dashed; border-color: var(--neon-dim); }
            50% { border-style: solid; border-color: var(--neon); }
            100% { border-style: dashed; border-color: var(--neon-dim); }
        }
        
        .remove-photo { 
            position: absolute; 
            top: 8px; 
            right: 8px; 
            background: linear-gradient(135deg, var(--danger) 0%, #ff6666 100%);
            color: white; 
            border: none; 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            line-height: 1;
            padding-bottom: 2px;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 4px 15px rgba(255, 68, 68, 0.4);
            animation: dangerPulse 2s infinite;
        }

        @keyframes dangerPulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(255, 68, 68, 0.4); }
            50% { box-shadow: 0 4px 25px rgba(255, 68, 68, 0.8), 0 0 30px rgba(255, 68, 68, 0.6); }
        }

        .remove-photo:hover {
            transform: scale(1.2) rotate(180deg);
            box-shadow: 0 0 30px var(--danger), 0 0 60px rgba(255, 68, 68, 0.8);
            animation: none;
        }

        .remove-photo:active {
            transform: scale(0.8) rotate(180deg);
            box-shadow: 0 0 50px var(--danger);
        }

        .footer { 
            padding: 12px 12px 20px; 
            background: linear-gradient(0deg, rgba(0,0,0,0.98) 0%, rgba(0,10,5,0.95) 100%);
            border-top: 1px solid rgba(0,255,136,0.1);
            z-index: 100;
            flex-shrink: 0;
        }
        
        .input-area { 
            display: flex; 
            gap: 8px; 
            align-items: center;
            width: 100%;
        }
        
        .tool-btn { 
            background: transparent; 
            border: 2px solid var(--neon-dim); 
            border-radius: 12px; 
            width: 44px; 
            height: 44px; 
            color: var(--neon); 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
        }

        .tool-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(0,255,136,0.6) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.4s ease;
        }

        .tool-btn::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent, rgba(0,255,136,0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tool-btn:hover::after {
            opacity: 1;
        }

        .tool-btn:hover::before {
            width: 120px;
            height: 120px;
        }
        
        .tool-btn:hover {
            transform: scale(1.1) translateY(-3px) rotateX(10deg);
            border-color: var(--neon);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.4), 0 0 0 1px var(--neon);
            background: rgba(0, 255, 136, 0.05);
        }
        
        .tool-btn:active {
            transform: scale(0.9) translateY(0) rotateX(0);
            box-shadow: 0 0 40px rgba(0, 255, 136, 0.8), inset 0 0 20px rgba(0, 255, 136, 0.3);
            transition: all 0.1s;
        }
        
        .tool-btn.active {
            background: var(--neon);
            color: #000;
            box-shadow: 0 0 30px var(--neon-glow), 0 0 60px rgba(0,255,136,0.4);
            animation: pulseActive 1.5s infinite, rotate3d 3s infinite linear;
            border-color: var(--neon);
        }

        @keyframes rotate3d {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }

        @keyframes pulseActive {
            0%, 100% { box-shadow: 0 0 30px var(--neon-glow), 0 0 60px rgba(0,255,136,0.4); }
            50% { box-shadow: 0 0 50px var(--neon), 0 0 100px rgba(0,255,136,0.6), 0 0 150px rgba(0,255,136,0.3); }
        }
        
        .input-wrapper {
            flex: 1;
            position: relative;
            min-width: 0;
        }
        
        #userInput { 
            width: 100%;
            height: 44px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(0,255,136,0.2);
            border-radius: 12px; 
            color: #fff; 
            padding: 0 14px;
            outline: none; 
            font-size: 15px;
            -webkit-appearance: none;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
        }

        #userInput:hover {
            border-color: rgba(0,255,136,0.4);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.1);
        }

        #userInput:focus {
            border-color: var(--neon);
            box-shadow: 0 0 0 4px rgba(0, 255, 136, 0.2), 0 0 30px rgba(0,255,136,0.3);
            transform: scale(1.02);
            background: rgba(255,255,255,0.08);
        }

        #userInput:focus:hover {
            transform: scale(1.02) translateY(-2px);
        }
        
        .send-btn { 
            background: linear-gradient(135deg, var(--neon) 0%, #00cc6a 100%);
            border: none; 
            border-radius: 12px; 
            width: 44px; 
            height: 44px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.4);
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform-style: preserve-3d;
        }

        .send-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }

        .send-btn:hover::before {
            left: 100%;
        }

        .send-btn::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 14px;
            padding: 2px;
            background: linear-gradient(135deg, var(--neon), #fff, var(--neon));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s;
            animation: rotateBorder 2s linear infinite;
        }

        @keyframes rotateBorder {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        .send-btn:hover::after {
            opacity: 1;
        }

        .send-btn:hover {
            transform: scale(1.15) translateY(-3px) rotateX(15deg);
            box-shadow: 0 15px 40px rgba(0, 255, 136, 0.6), 0 0 0 1px rgba(0,255,136,0.5);
        }

        .send-btn:active {
            transform: scale(0.9) rotateX(0);
            box-shadow: 0 0 50px rgba(0, 255, 136, 1), inset 0 0 30px rgba(0,0,0,0.2);
            transition: all 0.1s;
        }

        .send-btn.generating {
            background: linear-gradient(135deg, var(--accent) 0%, #cc00cc 100%);
            animation: pulseGen 0.8s ease-in-out infinite, rotate3d 2s infinite linear;
            pointer-events: none;
        }

        @keyframes pulseGen {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 0, 255, 0.6), 0 0 40px rgba(255, 0, 255, 0.3); transform: scale(1) rotateY(0deg); }
            50% { box-shadow: 0 0 40px rgba(255, 0, 255, 1), 0 0 80px rgba(255, 0, 255, 0.6); transform: scale(1.1) rotateY(180deg); }
        }

        pre { 
            background: #0d1117 !important; 
            border-radius: 12px; 
            padding: 16px; 
            overflow-x: auto; 
            border: 1px solid rgba(0,255,136,0.15);
            position: relative; 
            margin: 12px 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            padding-top: 50px;
            max-width: 100%;
            transition: all 0.3s ease;
        }

        pre:hover {
            border-color: var(--neon-dim);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.1);
            transform: translateY(-2px);
        }
        
        .code-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
        }
        
        .copy-btn, .copy-full-btn {
            padding: 6px 12px; 
            font-size: 11px; 
            font-weight: 700;
            border-radius: 6px; 
            cursor: pointer;
            border: none;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
            overflow: hidden;
        }

        .copy-btn::before, .copy-full-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s;
        }

        .copy-btn:hover::before, .copy-full-btn:hover::before {
            width: 60px;
            height: 60px;
        }

        .copy-btn:hover, .copy-full-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 255, 136, 0.4);
        }

        .copy-btn:active, .copy-full-btn:active {
            transform: scale(0.9);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.6);
        }
        
        .copy-btn { 
            background: rgba(0,255,136,0.1);
            color: var(--neon);
            border: 1px solid var(--neon-dim);
        }

        .copy-btn:hover {
            background: rgba(0,255,136,0.2);
            border-color: var(--neon);
        }
        
        .copy-full-btn {
            background: linear-gradient(135deg, var(--neon) 0%, #00cc6a 100%);
            color: #000;
        }

        .copy-full-btn:hover {
            background: linear-gradient(135deg, #00ff99 0%, #00ff88 100%);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.6);
        }

        .scroll-down-btn { 
            position: fixed; 
            bottom: 100px; 
            right: 16px; 
            width: 48px; 
            height: 48px; 
            background: linear-gradient(135deg, var(--neon) 0%, #00cc6a 100%);
            border: none; 
            border-radius: 50%; 
            color: #000; 
            cursor: pointer; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.5);
            z-index: 100;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            animation: float 3s ease-in-out infinite, pulseBtn 2s infinite;
            transform-style: preserve-3d;
        }

        @keyframes pulseBtn {
            0%, 100% { box-shadow: 0 4px 20px rgba(0, 255, 136, 0.5); }
            50% { box-shadow: 0 4px 40px rgba(0, 255, 136, 0.9), 0 0 60px rgba(0, 255, 136, 0.4); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotateZ(0deg); }
            50% { transform: translateY(-8px) rotateZ(5deg); }
        }
        
        .scroll-down-btn:hover {
            transform: scale(1.2) translateY(-5px) rotateZ(0deg);
            box-shadow: 0 10px 40px rgba(0, 255, 136, 0.8), 0 0 0 3px rgba(0,255,136,0.3);
            animation: none;
        }

        .scroll-down-btn:hover svg {
            animation: bounce 0.5s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(4px); }
        }

        .scroll-down-btn:active {
            transform: scale(0.9);
            box-shadow: 0 0 50px rgba(0, 255, 136, 1);
        }
        
        .scroll-down-btn.visible { display: flex; }

        .history-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 85%;
            max-width: 320px;
            height: 100%;
            background: linear-gradient(180deg, #0a0f0a 0%, #050805 100%);
            border-left: 3px solid var(--neon);
            z-index: 2000;
            transition: right 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            flex-direction: column;
            box-shadow: -10px 0 50px rgba(0, 255, 136, 0.2);
        }
        
        .history-panel.open { 
            right: 0; 
            animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes slideIn {
            0% { right: -100%; opacity: 0; }
            100% { right: 0; opacity: 1; }
        }
        
        .history-header {
            padding: 16px;
            border-bottom: 2px solid var(--neon-dim);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(90deg, transparent, rgba(0,255,136,0.05), transparent);
        }
        
        .history-title {
            color: var(--neon);
            font-size: 16px;
            font-weight: 700;
            animation: neonPulse 2s ease-in-out infinite;
            text-shadow: 0 0 10px var(--neon-dim);
        }
        
        .history-close {
            background: rgba(0,255,136,0.1);
            border: 2px solid var(--neon-dim);
            color: var(--neon);
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border-radius: 50%;
            position: relative;
            overflow: hidden;
        }

        .history-close::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(0,255,136,0.4) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s;
        }

        .history-close:hover::before {
            width: 100px;
            height: 100px;
        }

        .history-close:hover {
            background: rgba(0,255,136,0.2);
            transform: rotate(180deg) scale(1.1);
            border-color: var(--neon);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
        }

        .history-close:active {
            transform: rotate(180deg) scale(0.9);
            box-shadow: 0 0 50px rgba(0, 255, 136, 0.8);
        }
        
        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            -webkit-overflow-scrolling: touch;
        }
        
        .history-item {
            background: rgba(0,255,136,0.05);
            border: 2px solid var(--neon-dim);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
        }

        .history-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,255,136,0.2), transparent);
            transition: left 0.6s;
        }

        .history-item::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 14px;
            padding: 2px;
            background: linear-gradient(135deg, var(--neon), transparent, var(--neon));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .history-item:hover::before {
            left: 100%;
        }

        .history-item:hover::after {
            opacity: 1;
        }

        .history-item:hover {
            background: rgba(0,255,136,0.1);
            transform: translateX(10px) translateY(-2px) rotateX(5deg);
            border-color: var(--neon);
            box-shadow: 0 10px 30px rgba(0,255,136,0.3), 0 0 0 1px var(--neon);
        }

        .history-item:active {
            transform: translateX(5px) scale(0.98);
            box-shadow: 0 0 40px rgba(0,255,136,0.5);
        }
        
        .history-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0);
            backdrop-filter: blur(0px);
            z-index: 1999;
            display: none;
            transition: all 0.3s ease;
        }
        
        .history-overlay.show { 
            display: block; 
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
        }

        .mode-indicator {
            position: absolute;
            top: -20px;
            left: 0;
            font-size: 11px;
            color: var(--accent);
            font-weight: 700;
            display: none;
            white-space: nowrap;
            animation: fadeIn 0.3s, glitchText 2s infinite;
            text-shadow: 0 0 10px var(--accent);
        }

        @keyframes glitchText {
            0%, 90%, 100% { transform: translate(0); opacity: 1; }
            92% { transform: translate(-2px, 1px); opacity: 0.8; }
            94% { transform: translate(2px, -1px); opacity: 1; }
        }

        .mode-indicator.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .gen-options {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(150px) scale(0.8);
            background: rgba(10, 15, 10, 0.98);
            border: 2px solid var(--accent);
            border-radius: 16px;
            padding: 12px;
            z-index: 500;
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 0 50px rgba(255, 0, 255, 0.4), 0 10px 40px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
        }

        .gen-options.show {
            transform: translateX(-50%) translateY(0) scale(1);
            opacity: 1;
            animation: floatOptions 3s ease-in-out infinite;
        }

        @keyframes floatOptions {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-5px); }
        }

        .gen-opt-btn {
            background: rgba(255, 0, 255, 0.1);
            border: 2px solid var(--accent);
            color: #fff;
            padding: 8px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            white-space: nowrap;
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
        }

        .gen-opt-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255,0,255,0.4) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.4s;
        }

        .gen-opt-btn:hover::before {
            width: 120px;
            height: 120px;
        }

        .gen-opt-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .gen-opt-btn:hover::after {
            left: 100%;
        }

        .gen-opt-btn:hover {
            transform: translateY(-3px) scale(1.05) rotateX(10deg);
            box-shadow: 0 10px 30px rgba(255, 0, 255, 0.4);
            background: rgba(255, 0, 255, 0.2);
        }

        .gen-opt-btn:active {
            transform: scale(0.9) rotateX(0);
            box-shadow: 0 0 40px rgba(255, 0, 255, 0.8);
        }

        .gen-opt-btn.active {
            background: var(--accent);
            color: #000;
            box-shadow: 0 0 40px rgba(255, 0, 255, 0.8), 0 0 80px rgba(255, 0, 255, 0.4);
            animation: pulseAccent 1.5s infinite, rotate3d 4s infinite linear;
            border-color: #fff;
        }

        @keyframes pulseAccent {
            0%, 100% { box-shadow: 0 0 40px rgba(255, 0, 255, 0.8), 0 0 80px rgba(255, 0, 255, 0.4); }
            50% { box-shadow: 0 0 60px rgba(255, 0, 255, 1), 0 0 120px rgba(255, 0, 255, 0.6), 0 0 180px rgba(255, 0, 255, 0.3); }
        }

        .loading-gen {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            font-size: 14px;
            animation: pulseText 1.5s infinite;
        }

        @keyframes pulseText {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .loading-gen::before {
            content: '';
            width: 24px;
            height: 24px;
            border: 3px solid rgba(0, 255, 136, 0.2);
            border-top-color: var(--neon);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 10px var(--neon);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .download-btn {
            background: linear-gradient(135deg, var(--neon) 0%, #00cc6a 100%);
            color: #000;
            border: none;
            padding: 10px 18px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.4);
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
        }

        .download-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }

        .download-btn:hover::before {
            left: 100%;
        }

        .download-btn:hover {
            transform: translateY(-3px) scale(1.05) rotateX(10deg);
            box-shadow: 0 10px 35px rgba(0, 255, 136, 0.7), 0 0 0 2px rgba(0,255,136,0.5);
        }

        .download-btn:active {
            transform: scale(0.95) rotateX(0);
            box-shadow: 0 0 50px rgba(0, 255, 136, 1);
        }

        .download-btn svg {
            transition: transform 0.3s;
        }

        .download-btn:hover svg {
            transform: translateY(2px);
            animation: bounceArrow 0.5s infinite;
        }

        @keyframes bounceArrow {
            0%, 100% { transform: translateY(2px); }
            50% { transform: translateY(5px); }
        }

        .msg-actions {
            position: absolute;
            top: -32px;
            right: 0;
            display: none;
            gap: 6px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .msg:hover .msg-actions,
        .msg:active .msg-actions {
            display: flex;
        }

        .msg-action-btn {
            background: rgba(0,0,0,0.9);
            border: 2px solid var(--neon);
            color: var(--neon);
            padding: 5px 12px;
            font-size: 11px;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
        }

        .msg-action-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(0,255,136,0.3) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s;
        }

        .msg-action-btn:hover::before {
            width: 60px;
            height: 60px;
        }

        .msg-action-btn:hover {
            background: var(--neon);
            color: #000;
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.5), 0 0 0 1px var(--neon);
        }

        .msg-action-btn:active {
            transform: scale(0.9);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.8);
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(0, 255, 136, 0.6);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ */
        .tool-btn[onclick="openHistory()"] {
            animation: historyPulse 3s infinite;
        }

        @keyframes historyPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(0, 255, 136, 0); }
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ */
        .tool-btn[onclick="toggleGenMode()"] {
            transition: all 0.3s;
        }

        .tool-btn[onclick="toggleGenMode()"]:hover svg {
            animation: starSpin 0.5s linear infinite;
        }

        @keyframes starSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @media (max-width: 380px) {
            .header b {
                font-size: 12px;
                letter-spacing: 0.5px;
            }
            .tool-btn {
                width: 40px;
                height: 40px;
            }
            .send-btn {
                width: 40px;
                height: 40px;
            }
            #userInput {
                height: 40px;
                font-size: 16px;
            }
            .gen-options {
                flex-wrap: wrap;
                justify-content: center;
                width: 95%;
                max-width: 300px;
            }
        }

        @media (max-height: 600px) {
            .header {
                padding: 8px 12px;
                min-height: 48px;
            }
            #chat {
                padding: 12px;
            }
            .footer {
                padding: 8px 12px 12px;
            }
        }
    </style>
</head>
<body>
<canvas id="canvas"></canvas>

<div class="history-overlay" id="historyOverlay" onclick="closeHistory()"></div>

<div class="history-panel" id="historyPanel">
    <div class="history-header">
        <div class="history-title">üìú –ò–°–¢–û–†–ò–Ø</div>
        <button class="history-close" onclick="closeHistory()" type="button">√ó</button>
    </div>
    <div class="history-list" id="historyList"></div>
    <button class="tool-btn" onclick="clearHistory()" style="margin: 12px; width: calc(100% - 24px); height: 48px; border-radius: 12px; font-weight: 700;" type="button">üóëÔ∏è –û–ß–ò–°–¢–ò–¢–¨ –ò–°–¢–û–†–ò–Æ</button>
</div>

<div class="gen-options" id="genOptions">
    <button class="gen-opt-btn active" onclick="setGenMode('fast')" id="btnFast" type="button">‚ö° –ë—ã—Å—Ç—Ä–æ</button>
    <button class="gen-opt-btn" onclick="setGenMode('quality')" id="btnQuality" type="button">‚ú® –ö–∞—á–µ—Å—Ç–≤–æ</button>
    <button class="gen-opt-btn" onclick="setGenMode('turbo')" id="btnTurbo" type="button">üöÄ –¢—É—Ä–±–æ</button>
</div>

<button class="scroll-down-btn" id="scrollDownBtn" onclick="scrollToBottom()" type="button">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>
</button>

<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleImage(this)">
<input type="file" id="galleryInput" accept="image/*" style="display:none" onchange="handleImage(this)">

<div class="app">
    <div class="header">
        <b>‚ö°Ô∏è NEON VISION</b>
        <div style="display:flex;gap:8px;align-items:center;">
            <button class="tool-btn" onclick="openHistory()" style="width:44px;height:44px;" type="button" title="–ò—Å—Ç–æ—Ä–∏—è">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10H12V2z"></path></svg>
            </button>
            <div class="energy" id="energy">–ó–ê–ì–†–£–ó–ö–ê...</div>
        </div>
    </div>
    <div id="chat">
        <div class="msg ai">–°–∏—Å—Ç–µ–º–∞ VISION –æ–Ω–ª–∞–π–Ω. üëÅÔ∏è<br><br>–Ø –≤–∏–∂—É –≤—Å—ë: –∫–æ–¥, –ø—Ä–∏–º–µ—Ä—ã, —Å—Ö–µ–º—ã. –ü—Ä–∏—à–ª–∏ —Ñ–æ—Ç–æ –∏–ª–∏ –Ω–∞–ø–∏—à–∏ –∑–∞–¥–∞—á—É!<br><br>üé® <b>–ù–æ–≤–æ–µ:</b> –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π! –ù–∞–∂–º–∏ üé® –∏ –æ–ø–∏—à–∏ —á—Ç–æ —Å–æ–∑–¥–∞—Ç—å.</div>
    </div>
    <div class="footer">
        <div id="photoPreview" class="photo-preview" style="display:none;">
            <button class="remove-photo" onclick="removePhoto()" type="button">√ó</button>
            <img id="previewImg" src="" alt="Preview" style="max-width:100%;border-radius:8px;display:block;">
        </div>
        
        <div class="input-area">
            <button class="tool-btn" onclick="openCamera()" type="button" title="–ö–∞–º–µ—Ä–∞">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
            </button>
            
            <button class="tool-btn" onclick="openGallery()" type="button" title="–ì–∞–ª–µ—Ä–µ—è">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
            </button>
            
            <button class="tool-btn" onclick="toggleGenMode()" type="button" title="–ì–µ–Ω–µ—Ä–∞—Ü–∏—è" id="genBtn">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
            </button>
            
            <button class="tool-btn" onclick="showRef()" type="button" title="–†–µ—Ñ–µ—Ä–∞–ª–∫–∞">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
            </button>
            
            <div class="input-wrapper">
                <div class="mode-indicator" id="modeIndicator">üé® –†–ï–ñ–ò–ú –ì–ï–ù–ï–†–ê–¶–ò–ò</div>
                <input type="text" id="userInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="handleKey(event)" autocomplete="off">
            </div>
            
            <button class="send-btn" id="sendBtn" onclick="handleSend()" type="button">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"></path></svg>
            </button>
        </div>
    </div>
</div>

<script>
    const ADMIN_ID = 8371345434;
    let energy = localStorage.getItem('energy') ? parseInt(localStorage.getItem('energy')) : 8;
    let currentImageData = null;
    let editingMsgId = null;
    let isCreator = false;
    let currentUserId = null;
    let genMode = false;
    let genQuality = 'fast';
    
    let messageHistory = JSON.parse(localStorage.getItem('vision_history') || '[]');
    const MAX_HISTORY = 20;
    
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    function setViewportHeight() {
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    window.addEventListener('resize', setViewportHeight);
    setViewportHeight();

    function init() {
        currentUserId = tg.initDataUnsafe?.user?.id || tg.initDataUnsafe?.user_id;
        if (!currentUserId) currentUserId = parseInt(localStorage.getItem('test_user_id')) || null;
        isCreator = (currentUserId === ADMIN_ID);
        
        if (isCreator) { 
            energy = 9999; 
            document.getElementById('energy').innerText = "CREATOR";
            document.getElementById('energy').classList.add('creator');
        } else { 
            document.getElementById('energy').innerText = `‚ö° ${energy}`;
        }
        renderHistory();
        
        // –î–æ–±–∞–≤–ª—è–µ–º ripple —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞ –≤—Å–µ –∫–Ω–æ–ø–∫–∏
        document.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', createRipple);
        });
    }
    setTimeout(init, 100);

    function createRipple(e) {
        const button = e.currentTarget;
        const rect = button.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = e.clientX - rect.left - size / 2;
        const y = e.clientY - rect.top - size / 2;
        
        const ripple = document.createElement('span');
        ripple.classList.add('ripple');
        ripple.style.width = ripple.style.height = size + 'px';
        ripple.style.left = x + 'px';
        ripple.style.top = y + 'px';
        
        button.appendChild(ripple);
        setTimeout(() => ripple.remove(), 600);
    }

    const c = document.getElementById('canvas'), x = c.getContext('2d');
    let ps = [];
    function rs() { c.width = innerWidth; c.height = innerHeight; }
    window.onresize = rs; rs();
    
    class Dust { 
        constructor() { this.init(); } 
        init() { 
            this.x = Math.random() * c.width; 
            this.y = Math.random() * -c.height; 
            this.size = Math.random() * 2; 
            this.speed = Math.random() * 1 + 0.5; 
            this.opacity = Math.random() * 0.5 + 0.1; 
        } 
        update() { 
            this.y += this.speed; 
            if (this.y > c.height) this.init(); 
        } 
        draw() { 
            x.fillStyle = `rgba(0, 255, 136, ${this.opacity})`; 
            x.beginPath(); 
            x.arc(this.x, this.y, this.size, 0, Math.PI * 2); 
            x.fill(); 
        } 
    }
    for(let i=0; i<50; i++) ps.push(new Dust());
    function loop() { 
        x.clearRect(0,0,c.width,c.height); 
        ps.forEach(p=>{p.update();p.draw();}); 
        requestAnimationFrame(loop); 
    }
    loop();

    function toggleGenMode() {
        genMode = !genMode;
        const btn = document.getElementById('genBtn');
        const indicator = document.getElementById('modeIndicator');
        const options = document.getElementById('genOptions');
        const input = document.getElementById('userInput');
        
        if (genMode) {
            btn.classList.add('active');
            indicator.classList.add('active');
            options.classList.add('show');
            input.placeholder = "–û–ø–∏—à–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...";
            input.style.borderColor = 'var(--accent)';
            input.style.boxShadow = '0 0 20px rgba(255, 0, 255, 0.3)';
            // –í–∏–±—Ä–∞—Ü–∏—è –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞
            if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
        } else {
            btn.classList.remove('active');
            indicator.classList.remove('active');
            options.classList.remove('show');
            input.placeholder = "–°–æ–æ–±—â–µ–Ω–∏–µ...";
            input.style.borderColor = 'rgba(0,255,136,0.2)';
            input.style.boxShadow = 'none';
        }
        input.focus();
    }

    function setGenMode(mode) {
        genQuality = mode;
        document.querySelectorAll('.gen-opt-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active');
        if (navigator.vibrate) navigator.vibrate(30);
    }

    function openHistory() {
        document.getElementById('historyPanel').classList.add('open');
        document.getElementById('historyOverlay').classList.add('show');
        renderHistory();
        if (navigator.vibrate) navigator.vibrate([40, 20, 40]);
    }
    
    function closeHistory() {
        document.getElementById('historyPanel').classList.remove('open');
        document.getElementById('historyOverlay').classList.remove('show');
    }
    
    function renderHistory() {
        const list = document.getElementById('historyList');
        if (messageHistory.length === 0) {
            list.innerHTML = '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4);font-size:14px;animation:fadeIn 0.5s;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
            return;
        }
        list.innerHTML = messageHistory.slice().reverse().map((item, idx) => `
            <div class="history-item" onclick="loadFromHistory(${messageHistory.length - 1 - idx})" style="animation:slideIn 0.3s ${idx * 0.05}s both;">
                <div style="font-size:13px;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:4px;">${item.text || '(–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)'}</div>
                <div style="font-size:11px;color:rgba(255,255,255,0.5);">${new Date(item.time).toLocaleString('ru-RU', {hour: '2-digit', minute:'2-digit'})}</div>
            </div>
        `).join('');
    }
    
    function loadFromHistory(index) {
        const item = messageHistory[index];
        if (item) {
            document.getElementById('userInput').value = item.text || '';
            document.getElementById('userInput').focus();
        }
        closeHistory();
        if (navigator.vibrate) navigator.vibrate(30);
    }
    
    function addToHistory(text, isUser = true, isImage = false) {
        messageHistory.push({ text: text, isUser: isUser, isImage: isImage, time: Date.now() });
        if (messageHistory.length > MAX_HISTORY) messageHistory = messageHistory.slice(-MAX_HISTORY);
        localStorage.setItem('vision_history', JSON.stringify(messageHistory));
    }
    
    function clearHistory() {
        if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?')) {
            messageHistory = [];
            localStorage.removeItem('vision_history');
            renderHistory();
            if (navigator.vibrate) navigator.vibrate([50, 100, 50, 100, 50]);
        }
    }

    const chat = document.getElementById('chat');
    const scrollDownBtn = document.getElementById('scrollDownBtn');
    
    chat.addEventListener('scroll', () => {
        const isNearBottom = chat.scrollHeight - chat.scrollTop - chat.clientHeight < 100;
        scrollDownBtn.classList.toggle('visible', !isNearBottom);
    });
    
    function scrollToBottom() {
        chat.scrollTo({ top: chat.scrollHeight, behavior: 'smooth' });
        if (navigator.vibrate) navigator.vibrate([30, 50, 30]);
    }
    
    function checkScroll() {
        const isNearBottom = chat.scrollHeight - chat.scrollTop - chat.clientHeight < 100;
        if (!isNearBottom) scrollDownBtn.classList.add('visible');
        else scrollDownBtn.classList.remove('visible');
    }

    function openCamera() {
        document.getElementById('cameraInput').click();
        if (navigator.vibrate) navigator.vibrate(40);
    }
    
    function openGallery() {
        document.getElementById('galleryInput').click();
        if (navigator.vibrate) navigator.vibrate(40);
    }

    function handleImage(input) {
        const file = input.files[0];
        if (!file) return;
        
        if (file.size > 10 * 1024 * 1024) {
            alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º 10MB');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            currentImageData = e.target.result;
            document.getElementById('previewImg').src = currentImageData;
            document.getElementById('photoPreview').style.display = 'block';
            document.getElementById('userInput').focus();
            setTimeout(() => chat.scrollTop = chat.scrollHeight, 100);
            if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
        };
        reader.onerror = () => alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
        reader.readAsDataURL(file);
        input.value = '';
    }
    
    function removePhoto() {
        currentImageData = null;
        document.getElementById('photoPreview').style.display = 'none';
        document.getElementById('previewImg').src = '';
        if (navigator.vibrate) navigator.vibrate(30);
    }
    
    function handleKey(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            handleSend();
        }
    }

    function showRef() {
        const userId = currentUserId || 'guest';
        const refLink = `https://t.me/NeonVisionBot?start=${userId}`;
        
        const div = document.createElement('div');
        div.className = 'msg ai';
        div.innerHTML = `
            <div style="font-size:13px;opacity:0.8;margin-bottom:8px;">üîó –†–ï–§–ï–†–ê–õ–¨–ù–ê–Ø –°–ò–°–¢–ï–ú–ê</div>
            <div style="background:rgba(0,0,0,0.3);padding:12px;border-radius:8px;margin:12px 0;font-family:monospace;font-size:12px;word-break:break-all;border:1px solid var(--neon-dim);transition:all 0.3s;" onmouseover="this.style.borderColor='var(--neon)';this.style.boxShadow='0 0 20px rgba(0,255,136,0.2)'" onmouseout="this.style.borderColor='var(--neon-dim)';this.style.boxShadow='none'">${refLink}</div>
            <div style="font-size:13px;margin-bottom:12px;"><span style="color:var(--neon);font-weight:700;">1 –¥—Ä—É–≥ = +3 –∑–∞—Ä—è–¥–∞</span></div>
            <button onclick="copyRef(this, '${refLink}')" style="width:100%;background:linear-gradient(135deg,var(--neon) 0%,#00cc6a 100%);color:#000;border:none;padding:12px;border-radius:10px;font-weight:700;cursor:pointer;font-size:14px;transition:all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);position:relative;overflow:hidden;transform-style:preserve-3d;" onmouseover="this.style.transform='translateY(-3px) scale(1.02)'" onmouseout="this.style.transform='translateY(0) scale(1)'" onmousedown="this.style.transform='scale(0.95)'" onmouseup="this.style.transform='scale(1.02)'" type="button">–ö–û–ü–ò–†–û–í–ê–¢–¨</button>
        `;
        chat.appendChild(div);
        checkScroll();
        if (navigator.vibrate) navigator.vibrate(40);
    }

    function copyRef(btn, link) {
        navigator.clipboard.writeText(link).then(() => {
            btn.innerHTML = '‚úì –°–ö–û–ü–ò–†–û–í–ê–ù–û';
            btn.style.background = 'linear-gradient(135deg, #00cc6a 0%, var(--neon) 100%)';
            if (navigator.vibrate) navigator.vibrate([50, 100, 50]);
            setTimeout(() => {
                btn.innerHTML = '–ö–û–ü–ò–†–û–í–ê–¢–¨';
                btn.style.background = 'linear-gradient(135deg, var(--neon) 0%, #00cc6a 100%)';
            }, 2000);
        });
    }

    function generateId() {
        return 'msg_' + Date.now();
    }

    function editMessage(msgId) {
        const msgEl = document.getElementById(msgId);
        if (!msgEl) return;
        const text = msgEl.getAttribute('data-text');
        const imgData = msgEl.getAttribute('data-img');
        
        document.getElementById('userInput').value = text;
        if (imgData) {
            currentImageData = imgData;
            document.getElementById('previewImg').src = imgData;
            document.getElementById('photoPreview').style.display = 'block';
        }
        editingMsgId = msgId;
        msgEl.style.border = '2px solid var(--neon)';
        msgEl.style.boxShadow = '0 0 20px rgba(0,255,136,0.5)';
        document.getElementById('userInput').focus();
        if (navigator.vibrate) navigator.vibrate(30);
    }

    function deleteMessage(msgId) {
        const msgEl = document.getElementById(msgId);
        if (msgEl) {
            msgEl.style.animation = 'messageAppear 0.3s reverse forwards';
            setTimeout(() => {
                msgEl.remove();
                if (editingMsgId === msgId) cancelEdit();
            }, 300);
        }
    }

    function cancelEdit() {
        if (editingMsgId) {
            const el = document.getElementById(editingMsgId);
            if (el) {
                el.style.border = '';
                el.style.boxShadow = '';
            }
            editingMsgId = null;
        }
        document.getElementById('userInput').value = '';
        removePhoto();
    }

    async function generateImage(prompt) {
        const seed = Math.floor(Math.random() * 1000000);
        let width = 1024;
        let height = 1024;
        let model = 'flux';
        
        if (genQuality === 'fast') {
            width = 512;
            height = 512;
            model = 'flux';
        } else if (genQuality === 'quality') {
            width = 1024;
            height = 1024;
            model = 'flux-realism';
        } else if (genQuality === 'turbo') {
            width = 512;
            height = 512;
            model = 'turbo';
        }

        const encodedPrompt = encodeURIComponent(prompt);
        
        const params = new URLSearchParams({
            width: width,
            height: height,
            seed: seed,
            nologo: 'true',
            model: model,
            enhance: 'true'
        });
        
        const imageUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?${params.toString()}`;
        
        console.log('Generated URL:', imageUrl);
        
        return imageUrl;
    }

    async function analyzeImageWithAI(imageBase64, userText) {
        try {
            const base64Data = imageBase64.split(',')[1];
            const formData = new FormData();
            formData.append('image', base64Data);
            
            const uploadRes = await fetch('https://api.imgur.com/3/image', {
                method: 'POST',
                headers: { 'Authorization': 'Client-ID 546c25a59c58ad7' },
                body: formData
            });
            
            const uploadData = await uploadRes.json();
            if (!uploadData.success) throw new Error('Upload failed');
            
            const imageUrl = uploadData.data.link;
            const prompt = userText 
                ? `–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${imageUrl}\n\n–í–æ–ø—Ä–æ—Å: ${userText}\n\n–û—Ç–≤–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º.`
                : `–û–ø–∏—à–∏ —á—Ç–æ –Ω–∞ —Ñ–æ—Ç–æ: ${imageUrl}\n\n–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º.`;
            
            const response = await fetch("https://text.pollinations.ai", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    messages: [
                        { role: "system", content: "–¢—ã –∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û–ø–∏—Å—ã–≤–∞–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º." },
                        { role: "user", content: prompt }
                    ],
                    model: "openai"
                })
            });
            
            let result = await response.text();
            result = result.replace(/\{.*?\}/g, '').trim();
            return result || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.";
            
        } catch (err) {
            console.error(err);
            return "–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.";
        }
    }

    async function handleSend() {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        const sendBtn = document.getElementById('sendBtn');
        
        if (!text && !currentImageData) return;
        if (!isCreator && energy <= 0) { 
            alert('–ó–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –∑–∞—Ä—è–¥—ã! –ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞.');
            return; 
        }

        if (navigator.vibrate) navigator.vibrate([60, 40, 60]);

        if (editingMsgId) {
            const oldMsg = document.getElementById(editingMsgId);
            if (oldMsg) oldMsg.remove();
            editingMsgId = null;
        }

        const msgId = generateId();
        const userDiv = document.createElement('div');
        userDiv.className = 'msg user';
        userDiv.id = msgId;
        userDiv.setAttribute('data-text', text);
        if (currentImageData) userDiv.setAttribute('data-img', currentImageData);
        
        let content = '';
        if (text) content += text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        if (currentImageData) {
            content += (text ? '<br>' : '') + `<img src="${currentImageData}" class="preview-img">`;
        }
        
        userDiv.innerHTML = content + `
            <div class="msg-actions">
                <button class="msg-action-btn" onclick="event.stopPropagation(); editMessage('${msgId}')" type="button">‚úèÔ∏è –ò–∑–º</button>
                <button class="msg-action-btn" onclick="event.stopPropagation(); deleteMessage('${msgId}')" type="button">üóëÔ∏è –£–¥–ª</button>
            </div>
        `;
        
        chat.appendChild(userDiv);
        addToHistory(text || '(–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)', true);
        
        input.value = '';
        const imgToSend = currentImageData;
        removePhoto();
        checkScroll();
        
        if (!isCreator) {
            energy--;
            document.getElementById('energy').innerText = `‚ö° ${energy}`;
            localStorage.setItem('energy', energy);
        }

        const load = document.createElement('div');
        load.className = 'msg ai';
        load.innerHTML = genMode ? '<div class="loading-gen">–ì–µ–Ω–µ—Ä–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...</div>' : '<div class="loading-gen">üëÅÔ∏è –î—É–º–∞—é...</div>';
        chat.appendChild(load);
        checkScroll();
        
        sendBtn.disabled = true;
        if (genMode) sendBtn.classList.add('generating');

        try {
            if (genMode && text) {
                console.log('Starting image generation...');
                const imageUrl = await generateImage(text);
                
                const img = new Image();
                img.crossOrigin = "anonymous";
                
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = () => {
                        console.log('Retrying with new seed...');
                        const retryUrl = imageUrl.replace(/seed=\d+/, 'seed=' + Math.floor(Math.random() * 1000000));
                        img.src = retryUrl;
                        img.onload = resolve;
                        img.onerror = reject;
                    };
                    img.src = imageUrl;
                });
                
                load.remove();
                
                const aiDiv = document.createElement('div');
                aiDiv.className = 'msg ai';
                aiDiv.innerHTML = `
                    <div style="font-size:12px;opacity:0.8;margin-bottom:6px;color:var(--accent);font-weight:700;">üé® ${text}</div>
                    <img src="${img.src}" class="generated-img" alt="Generated" style="display:block;max-width:100%;">
                    <br>
                    <button class="download-btn" onclick="downloadImage('${img.src}')" type="button">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        –°–ö–ê–ß–ê–¢–¨
                    </button>
                `;
                chat.appendChild(aiDiv);
                addToHistory(`[–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${text}]`, false, true);
                
                if (navigator.vibrate) navigator.vibrate([50, 100, 50, 100, 50]);
                
            } else if (imgToSend) {
                const resText = await analyzeImageWithAI(imgToSend, text);
                load.remove();
                
                const aiDiv = document.createElement('div');
                aiDiv.className = 'msg ai';
                aiDiv.innerHTML = formatText(resText);
                chat.appendChild(aiDiv);
                addToHistory(resText, false);
                
            } else {
                const historyContext = messageHistory.slice(-4).map(h => ({
                    role: h.isUser ? 'user' : 'assistant',
                    content: h.text
                }));

                const response = await fetch("https://text.pollinations.ai", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        messages: [
                            { role: "system", content: "–¢—ã NEON VISION PRO. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º. –ö–æ–¥ –≤ ```." },
                            ...historyContext,
                            { role: "user", content: text }
                        ],
                        model: "openai"
                    })
                });
                let resText = await response.text();
                resText = resText.replace(/\{.*?\}/g, '').trim() || "–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞";
                
                load.remove();
                
                const aiDiv = document.createElement('div');
                aiDiv.className = 'msg ai';
                aiDiv.innerHTML = formatText(resText);
                chat.appendChild(aiDiv);
                addToHistory(resText, false);
            }
            
            checkScroll();

        } catch (e) { 
            console.error('Error:', e);
            load.innerHTML = "‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.<br><small>–í–æ–∑–º–æ–∂–Ω–æ, —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω</small>"; 
        } finally {
            sendBtn.disabled = false;
            sendBtn.classList.remove('generating');
        }
    }

    function formatText(text) {
        return text
            .replace(/```(\w+)?([\s\S]*?)```/g, (m, l, code) => {
                const lang = l || 'text';
                return `<pre><div class="code-buttons"><button class="copy-btn" onclick="copyCode(this)" type="button">üìã –ö–û–ü–ò–†–û–í–ê–¢–¨</button></div><code class="language-${lang}">${code.trim().replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre>`;
            })
            .replace(/\*\*(.*?)\*\*/g, '<b style="color:var(--neon);text-shadow:0 0 10px var(--neon-dim);">$1</b>')
            .replace(/\n/g, '<br>');
    }

    function downloadImage(url) {
        window.open(url, '_blank');
        if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
    }

    function copyCode(btn) {
        const code = btn.closest('.code-buttons').nextElementSibling.innerText;
        navigator.clipboard.writeText(code).then(() => { 
            btn.innerHTML = "‚úì –°–ö–û–ü–ò–†–û–í–ê–ù–û"; 
            btn.style.background = "rgba(0,255,136,0.3)";
            if (navigator.vibrate) navigator.vibrate(50);
            setTimeout(() => {
                btn.innerHTML = "üìã –ö–û–ü–ò–†–û–í–ê–¢–¨";
                btn.style.background = "";
            }, 2000); 
        });
    }
</script>
</body>
    </html>
