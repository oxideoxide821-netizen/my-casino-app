<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Military Case Opener</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; touch-action: none; font-family: sans-serif; }
        #ui { position: absolute; width: 100%; text-align: center; color: #0ff; font-weight: bold; top: 10%; pointer-events: none; text-shadow: 0 0 10px #0ff; font-size: 24px; z-index: 10; }
        #openBtn { position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%); padding: 15px 40px; background: #0ff; border: none; border-radius: 5px; font-weight: bold; font-size: 18px; cursor: pointer; box-shadow: 0 0 20px #0ff; z-index: 20; transition: 0.2s; }
        #openBtn:disabled { background: #333; box-shadow: none; color: #666; }
    </style>
</head>
<body>
    <div id="ui">ИСПЫТАЙ УДАЧУ!</div>
    <button id="openBtn">ОТКРЫТЬ КЕЙС</button>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com", "three/addons/": "https://unpkg.com" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        document.body.appendChild(renderer.domElement);

        // МОЩНЫЙ СВЕТ СО ВСЕХ СТОРОН
        const ambient = new THREE.AmbientLight(0xffffff, 2);
        const sun = new THREE.DirectionalLight(0xffffff, 3);
        sun.position.set(5, 10, 7);
        const point = new THREE.PointLight(0x00ffff, 0, 20); // Свет внутри кейса
        scene.add(ambient, sun, point);

        let caseModel, weaponPack, mixer, openAction, isOpening = false;
        const loader = new GLTFLoader();

        // 1. ЗАГРУЗКА КЕЙСА (Ammo Can)
        loader.load('case.glb', (gltf) => {
            caseModel = gltf.scene;
            scene.add(caseModel);
            
            // Автоматический подбор размера и центрирование
            const box = new THREE.Box3().setFromObject(caseModel);
            const size = box.getSize(new THREE.Vector3()).length();
            const center = box.getCenter(new THREE.Vector3());
            caseModel.position.x += (caseModel.position.x - center.x);
            caseModel.position.y += (caseModel.position.y - center.y) - 0.5;
            caseModel.position.z += (caseModel.position.z - center.z);
            caseModel.scale.setScalar(3 / size); // Масштабируем до удобного размера

            mixer = new THREE.AnimationMixer(caseModel);
            if(gltf.animations.length > 0) {
                openAction = mixer.clipAction(gltf.animations[0]); // Первая анимация крышки
                openAction.setLoop(THREE.LoopOnce);
                openAction.clampWhenFinished = true;
            }
        });

        // 2. ЗАГРУЗКА ОРУЖИЯ
        loader.load('weapon.glb', (gltf) => {
            weaponPack = gltf.scene;
            weaponPack.visible = false;
            scene.add(weaponPack);
            weaponPack.traverse(c => { if(c.isMesh) c.visible = false; });
        });

        camera.position.set(0, 1.5, 6);

        function showPrize() {
            if (!weaponPack) return;
            weaponPack.visible = true;
            const items = weaponPack.children.filter(c => c.type === "Group" || c.type === "Mesh");
            const prize = items[Math.floor(Math.random() * items.length)];
            
            items.forEach(c => c.visible = false);
            prize.visible = true;
            prize.position.set(0, 0, 0);
            prize.scale.setScalar(0.1);
            
            let start = Date.now();
            const anim = setInterval(() => {
                let prog = (Date.now() - start) / 1500;
                prize.position.y = prog * 2.5; // Вылетает выше
                prize.rotation.y += 0.05;
                prize.scale.setScalar(prog * 1.5);
                if (prog >= 1) { 
                    clearInterval(anim); 
                    prize.position.y = 2; 
                    prize.scale.setScalar(1.5); 
                }
            }, 16);
        }

        document.getElementById('openBtn').onclick = () => {
            if (isOpening || !caseModel) return;
            isOpening = true;
            document.getElementById('openBtn').disabled = true;
            document.getElementById('ui').innerText = "УДАЧИ...";

            // Эффект тряски
            let start = Date.now();
            const shake = setInterval(() => {
                caseModel.position.x = Math.sin(Date.now() * 0.1) * 0.1;
                if (Date.now() - start > 1500) {
                    clearInterval(shake);
                    caseModel.position.x = 0;
                    if (openAction) openAction.play();
                    point.intensity = 100; // Вспышка внутри
                    setTimeout(() => { 
                        showPrize(); 
                        document.getElementById('ui').innerText = "ВЫПАЛ ПРЕДМЕТ!"; 
                    }, 800);
                }
            }, 16);
        };

        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            if (mixer) mixer.update(clock.getDelta());
            renderer.render(scene, camera);
        }
        animate();

        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>
