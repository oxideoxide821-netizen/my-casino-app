<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON CODER PRO | VISION</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

    <style>
        :root { --neon: #00ff88; --bg: #020502; --glass: rgba(0, 255, 136, 0.1); --danger: #ff4444; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); color: #e0f2e9; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; overflow: hidden; }
        #canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .app { display: flex; flex-direction: column; width: 100vw; height: 100vh; }
        
        .header { padding: 15px; background: rgba(0,0,0,0.9); border-bottom: 2px solid var(--neon); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 0 15px var(--neon); z-index: 10; }
        .header b { color: var(--neon); letter-spacing: 1px; font-size: 16px; }
        .energy { background: var(--neon); color: #000; padding: 4px 10px; border-radius: 20px; font-weight: 900; font-size: 11px; }
        .energy.creator { background: #ffd700; color: #000; box-shadow: 0 0 10px #ffd700; }

        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; position: relative; }
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 15px; font-size: 14px; line-height: 1.5; animation: fadeIn 0.3s; position: relative; word-wrap: break-word; }
        .user { background: var(--neon); color: #000; align-self: flex-end; font-weight: bold; border-bottom-right-radius: 2px; }
        .ai { background: rgba(255,255,255,0.05); border: 1px solid var(--glass); align-self: flex-start; border-bottom-left-radius: 2px; }
        .system { background: rgba(255,68,68,0.1); border: 1px solid var(--danger); color: #ff8888; align-self: center; text-align: center; font-size: 13px; max-width: 95%; }
        .preview-img { max-width: 100%; border-radius: 10px; margin-top: 5px; border: 1px solid var(--neon); display: block; }
        
        .msg-actions { position: absolute; top: -20px; right: 0; display: none; gap: 5px; }
        .msg:hover .msg-actions { display: flex; }
        .edit-btn, .delete-btn { background: #333; border: 1px solid var(--neon); color: var(--neon); padding: 2px 8px; font-size: 10px; border-radius: 4px; cursor: pointer; }

        .photo-preview { background: rgba(0,255,136,0.1); border: 1px dashed var(--neon); border-radius: 10px; padding: 10px; margin-bottom: 10px; position: relative; }
        .photo-preview img { max-width: 100%; border-radius: 8px; display: block; }
        .remove-photo { position: absolute; top: 5px; right: 5px; background: var(--danger); color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 16px; line-height: 1; }

        .footer { padding: 10px 15px 30px; background: #000; border-top: 1px solid #222; }
        .input-area { display: flex; gap: 8px; align-items: flex-end; }
        
        .tool-btn { background: transparent; border: 1px solid var(--neon); border-radius: 12px; width: 42px; height: 42px; color: var(--neon); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; flex-shrink: 0; }
        .tool-btn:active { background: var(--neon); color: #000; }
        
        textarea { flex: 1; background: #111; border: 1px solid #333; border-radius: 12px; color: #fff; padding: 12px; min-height: 42px; max-height: 120px; outline: none; resize: none; font-size: 14px; border-color: var(--neon); font-family: inherit; }
        
        .send-btn { background: var(--neon); border: none; border-radius: 12px; width: 48px; height: 42px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 10px var(--neon); flex-shrink: 0; }
        .send-btn svg { width: 22px; height: 22px; stroke: #000; fill: none; stroke-width: 2.5; }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        pre { background: #000 !important; border-radius: 10px; padding: 10px; overflow-x: auto; border: 1px solid #333; position: relative; margin: 5px 0; }
        .copy-btn { position: absolute; right: 5px; top: 5px; background: var(--neon); border: none; padding: 4px 8px; font-size: 10px; font-weight: bold; border-radius: 4px; color: #000; cursor: pointer; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } }
        .editing { background: rgba(0,255,136,0.2) !important; border: 2px solid var(--neon) !important; }
        
        /* –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –∫–∞–º–µ—Ä—ã/–≥–∞–ª–µ—Ä–µ–∏ */
        .photo-menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: flex-end; justify-content: center; }
        .photo-menu { background: #111; border-top: 2px solid var(--neon); width: 100%; padding: 20px; border-radius: 20px 20px 0 0; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .photo-menu-title { color: var(--neon); text-align: center; margin-bottom: 20px; font-size: 16px; font-weight: bold; }
        .photo-menu-btn { width: 100%; padding: 15px; margin: 10px 0; background: transparent; border: 2px solid var(--neon); color: var(--neon); border-radius: 12px; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .photo-menu-btn:active { background: var(--neon); color: #000; }
        .photo-menu-close { width: 100%; padding: 15px; margin-top: 10px; background: #333; border: none; color: #fff; border-radius: 12px; font-size: 16px; cursor: pointer; }

        /* –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤–Ω–∏–∑ */
        .scroll-down-btn { position: fixed; bottom: 100px; right: 20px; width: 45px; height: 45px; background: var(--neon); border: none; border-radius: 50%; color: #000; cursor: pointer; display: none; align-items: center; justify-content: center; box-shadow: 0 0 15px var(--neon); z-index: 100; animation: bounce 2s infinite; }
        .scroll-down-btn.visible { display: flex; }
        .scroll-down-btn svg { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-5px); } 60% { transform: translateY(-3px); } }
    </style>
</head>
<body>
<canvas id="canvas"></canvas>

<!-- –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –∫–∞–º–µ—Ä—ã/–≥–∞–ª–µ—Ä–µ–∏ -->
<div class="photo-menu-overlay" id="photoMenu" onclick="closePhotoMenu(event)">
    <div class="photo-menu">
        <div class="photo-menu-title">–í–´–ë–†–ê–¢–¨ –ò–°–¢–û–ß–ù–ò–ö</div>
        <button class="photo-menu-btn" onclick="selectCamera()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
            –ö–ê–ú–ï–†–ê
        </button>
        <button class="photo-menu-btn" onclick="selectGallery()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
            –ì–ê–õ–ï–†–ï–Ø
        </button>
        <button class="photo-menu-close" onclick="closePhotoMenu()">–û–¢–ú–ï–ù–ê</button>
    </div>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤–Ω–∏–∑ -->
<button class="scroll-down-btn" id="scrollDownBtn" onclick="scrollToBottom()">
    <svg viewBox="0 0 24 24"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>
</button>

<!-- –°–∫—Ä—ã—Ç—ã–µ –∏–Ω–ø—É—Ç—ã -->
<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleImage(this)">
<input type="file" id="galleryInput" accept="image/*" style="display:none" onchange="handleImage(this)">

<div class="app">
    <div class="header">
        <b>‚ö°Ô∏è NEON VISION PRO</b>
        <div class="energy" id="energy">–ó–ê–ì–†–£–ó–ö–ê...</div>
    </div>
    <div id="chat">
        <div class="msg ai">–°–∏—Å—Ç–µ–º–∞ VISION –æ–Ω–ª–∞–π–Ω. üëÅÔ∏è <br>–Ø –≤–∏–∂—É –≤—Å—ë: –∫–æ–¥, –ø—Ä–∏–º–µ—Ä—ã, —Å—Ö–µ–º—ã.<br><br>üí° –ü—Ä–∏–∫—Ä–µ–ø–ª—è–π —Ñ–æ—Ç–æ + –ø–∏—à–∏ —Ç–µ–∫—Å—Ç!</div>
    </div>
    <div class="footer">
        <div id="photoPreview" class="photo-preview" style="display:none;">
            <button class="remove-photo" onclick="removePhoto()">√ó</button>
            <img id="previewImg" src="" alt="Preview">
        </div>
        
        <div class="input-area">
            <button class="tool-btn" onclick="openPhotoMenu()" type="button">
                <svg viewBox="0 0 24 24" width="22" height="22" stroke="currentColor" fill="none" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
            </button>
            
            <button class="tool-btn" onclick="showRef()" type="button">üîó</button>
            <textarea id="userInput" placeholder="–¢–µ–∫—Å—Ç –∏–ª–∏ —Ñ–æ—Ç–æ..." rows="1" oninput="autoResize(this)" onkeydown="handleKey(event)"></textarea>
            <button class="send-btn" id="sendBtn" onclick="handleSend()" type="button">
                <svg viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"></path></svg>
            </button>
        </div>
    </div>
</div>

<script>
    const ADMIN_ID = 8371345434;
    let energy = localStorage.getItem('energy') ? parseInt(localStorage.getItem('energy')) : 8;
    let currentImageData = null;
    let editingMsgId = null;
    let isCreator = false;
    let currentUserId = null;
    
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    function init() {
        currentUserId = tg.initDataUnsafe?.user?.id || tg.initDataUnsafe?.user_id;
        
        if (!currentUserId) {
            currentUserId = parseInt(localStorage.getItem('test_user_id')) || null;
        }
        
        isCreator = (currentUserId === ADMIN_ID);
        
        console.log('User ID:', currentUserId, 'Is Creator:', isCreator);
        
        if (isCreator) { 
            energy = 9999; 
            document.getElementById('energy').innerText = "CREATOR";
            document.getElementById('energy').classList.add('creator');
        } else { 
            updateUI(); 
        }
    }

    setTimeout(init, 100);

    function updateUI() { 
        const el = document.getElementById('energy');
        if (isCreator) {
            el.innerText = "CREATOR";
            el.classList.add('creator');
        } else {
            el.innerText = `‚ö° ${energy}`;
        }
        localStorage.setItem('energy', energy); 
    }

    // –ú–ï–ù–Æ –ö–ê–ú–ï–†–´/–ì–ê–õ–ï–†–ï–ò
    function openPhotoMenu() {
        document.getElementById('photoMenu').style.display = 'flex';
    }

    function closePhotoMenu(e) {
        if (!e || e.target === document.getElementById('photoMenu')) {
            document.getElementById('photoMenu').style.display = 'none';
        }
    }

    function selectCamera() {
        closePhotoMenu();
        document.getElementById('cameraInput').click();
    }

    function selectGallery() {
        closePhotoMenu();
        document.getElementById('galleryInput').click();
    }

    // –ü–ê–î–ê–Æ–©–ò–ï –ó–ï–õ–ï–ù–´–ï –ò–°–ö–†–´ (100 —á–∞—Å—Ç–∏—Ü)
    const c = document.getElementById('canvas'), x = c.getContext('2d');
    let ps = [];
    function rs() { c.width = innerWidth; c.height = innerHeight; }
    window.onresize = rs; rs();
    
    class Spark {
        constructor() { this.init(); }
        init() {
            this.x = Math.random() * c.width;
            this.y = Math.random() * -c.height;
            this.size = Math.random() * 2 + 0.5;
            this.speed = Math.random() * 2 + 0.5;
            this.opacity = Math.random() * 0.8 + 0.2;
            this.wind = (Math.random() - 0.5) * 0.5;
        }
        update() {
            this.y += this.speed;
            this.x += this.wind;
            if (this.y > c.height) this.init();
            if (this.x < 0 || this.x > c.width) this.init();
        }
        draw() {
            x.fillStyle = `rgba(0, 255, 136, ${this.opacity})`;
            x.beginPath();
            x.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            x.fill();
        }
    }
    
    for(let i = 0; i < 100; i++) ps.push(new Spark());
    
    function loop() {
        x.clearRect(0, 0, c.width, c.height);
        ps.forEach(p => { p.update(); p.draw(); });
        requestAnimationFrame(loop);
    }
    loop();

    // –ö–ù–û–ü–ö–ê –ü–†–û–ö–†–£–¢–ö–ò –í–ù–ò–ó
    const chat = document.getElementById('chat');
    const scrollDownBtn = document.getElementById('scrollDownBtn');
    
    chat.addEventListener('scroll', () => {
        const isNearBottom = chat.scrollHeight - chat.scrollTop - chat.clientHeight < 100;
        if (isNearBottom) {
            scrollDownBtn.classList.remove('visible');
        } else {
            scrollDownBtn.classList.add('visible');
        }
    });

    function scrollToBottom() {
        chat.scrollTop = chat.scrollHeight;
        scrollDownBtn.classList.remove('visible');
    }

    function checkScroll() {
        const isNearBottom = chat.scrollHeight - chat.scrollTop - chat.clientHeight < 100;
        if (!isNearBottom) {
            scrollDownBtn.classList.add('visible');
        }
    }

    // –û–ë–†–ê–ë–û–¢–ö–ê –§–û–¢–û
    function handleImage(input) {
        const file = input.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            currentImageData = e.target.result;
            document.getElementById('previewImg').src = currentImageData;
            document.getElementById('photoPreview').style.display = 'block';
            document.getElementById('userInput').focus();
        };
        reader.readAsDataURL(file);
        input.value = '';
    }

    function removePhoto() {
        currentImageData = null;
        document.getElementById('photoPreview').style.display = 'none';
        document.getElementById('previewImg').src = '';
    }

    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    function handleKey(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSend();
        }
    }

    function showRef() {
        const userId = currentUserId || 'guest';
        const refLink = `https://t.me/NeonVisionBot?start=${userId}`;
        
        const div = document.createElement('div');
        div.className = 'msg ai';
        div.style.cssText = 'border:1px dashed var(--neon); background:rgba(0,255,136,0.05);';
        div.innerHTML = `
            <b>üîó –¢–í–û–Ø –†–ï–§–ï–†–ê–õ–¨–ù–ê–Ø –°–°–´–õ–ö–ê:</b><br>
            <code style="font-size:11px;word-break:break-all;display:block;margin:8px 0;padding:8px;background:#000;border-radius:6px;">${refLink}</code>
            <div style="font-size:12px;color:var(--neon);margin-bottom:8px;">1 –¥—Ä—É–≥ = +3 –∑–∞—Ä—è–¥–∞</div>
            <button onclick="copyText('${refLink}')" style="background:var(--neon);color:#000;border:none;padding:8px 16px;border-radius:20px;font-weight:bold;cursor:pointer;width:100%;">–ö–û–ü–ò–†–û–í–ê–¢–¨ –°–°–´–õ–ö–£</button>
        `;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
        checkScroll();
    }

    function copyText(text) {
        navigator.clipboard.writeText(text).then(() => {
            if (tg.showPopup) {
                tg.showPopup({title: '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!', message: '–û—Ç–ø—Ä–∞–≤—å —Å—Å—ã–ª–∫—É –¥—Ä—É–∑—å—è–º –∏ –ø–æ–ª—É—á–∏ +3 –∑–∞—Ä—è–¥–∞ –∑–∞ –∫–∞–∂–¥–æ–≥–æ'});
            } else {
                alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
            }
        });
    }

    function generateId() {
        return 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function editMessage(msgId) {
        const msgEl = document.getElementById(msgId);
        if (!msgEl) return;
        
        const text = msgEl.getAttribute('data-text');
        const imgData = msgEl.getAttribute('data-img');
        
        document.getElementById('userInput').value = text;
        if (imgData) {
            currentImageData = imgData;
            document.getElementById('previewImg').src = imgData;
            document.getElementById('photoPreview').style.display = 'block';
        }
        
        editingMsgId = msgId;
        msgEl.classList.add('editing');
        document.getElementById('userInput').focus();
        autoResize(document.getElementById('userInput'));
    }

    function deleteMessage(msgId) {
        const msgEl = document.getElementById(msgId);
        if (msgEl) {
            msgEl.remove();
            if (editingMsgId === msgId) cancelEdit();
        }
    }

    function cancelEdit() {
        if (editingMsgId) {
            const el = document.getElementById(editingMsgId);
            if (el) el.classList.remove('editing');
            editingMsgId = null;
        }
        document.getElementById('userInput').value = '';
        removePhoto();
    }

    function showRefBanner() {
        const needed = Math.ceil((3 - energy) / 3);
        
        const div = document.createElement('div');
        div.className = 'msg system';
        div.innerHTML = `
            <div style="padding:10px;">
                <h3 style="margin:0 0 10px 0;color:var(--danger);">‚ö°Ô∏è –ó–ê–ö–û–ù–ß–ò–õ–ò–°–¨ –ó–ê–†–Ø–î–´!</h3>
                <div style="margin-bottom:10px;">–£ —Ç–µ–±—è <b>${energy}</b> –∑–∞—Ä—è–¥–æ–≤</div>
                <div style="font-size:14px;margin-bottom:15px;">
                    –ü—Ä–∏–≥–ª–∞—Å–∏ <b>${needed} ${needed === 1 ? '–¥—Ä—É–≥–∞' : '–¥—Ä—É–∑–µ–π'}</b> –∏ –ø–æ–ª—É—á–∏ +${needed * 3} –∑–∞—Ä—è–¥–æ–≤!<br>
                    <small style="opacity:0.7;">1 –¥—Ä—É–≥ = +3 –∑–∞—Ä—è–¥–∞</small>
                </div>
                <button onclick="showRef()" style="background:var(--neon);color:#000;border:none;padding:12px 24px;border-radius:25px;font-weight:bold;cursor:pointer;font-size:14px;">
                    –ü–û–õ–£–ß–ò–¢–¨ –ó–ê–†–Ø–î–´
                </button>
            </div>
        `;
        chat.appendChild(div);
        checkScroll();
    }

    async function handleSend() {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        const sendBtn = document.getElementById('sendBtn');
        
        if (!text && !currentImageData) return;
        
        if (!isCreator && energy <= 0) { 
            showRefBanner();
            return; 
        }

        if (editingMsgId) {
            const oldMsg = document.getElementById(editingMsgId);
            if (oldMsg) oldMsg.remove();
            editingMsgId = null;
        }

        const msgId = generateId();
        const userDiv = document.createElement('div');
        userDiv.className = 'msg user';
        userDiv.id = msgId;
        userDiv.setAttribute('data-text', text);
        if (currentImageData) userDiv.setAttribute('data-img', currentImageData);
        
        let content = '';
        if (text) content += escapeHtml(text).replace(/\n/g, '<br>');
        if (currentImageData) {
            content += (text ? '<br>' : '') + `<img src="${currentImageData}" class="preview-img">`;
        }
        
        userDiv.innerHTML = content + `
            <div class="msg-actions">
                <button class="edit-btn" onclick="editMessage('${msgId}')">‚úèÔ∏è</button>
                <button class="delete-btn" onclick="deleteMessage('${msgId}')">üóëÔ∏è</button>
            </div>
        `;
        
        chat.appendChild(userDiv);
        input.value = '';
        input.style.height = '42px';
        
        const imgToSend = currentImageData;
        removePhoto();
        checkScroll();
        
        if (!isCreator) {
            energy--;
            updateUI();
        }

        const load = document.createElement('div');
        load.className = 'msg ai';
        load.innerHTML = 'üëÅÔ∏è –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —á–µ—Ä–µ–∑ VISION...';
        chat.appendChild(load);
        checkScroll();
        
        sendBtn.disabled = true;

        try {
            let promptText = text || "–û–ø–∏—à–∏ —á—Ç–æ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏";
            
            if (imgToSend) {
                promptText = `[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª —Ñ–æ—Ç–æ] ${promptText}\n–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –æ—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å.`;
            }

            const payload = {
                messages: [
                    { role: "system", content: "–¢—ã NEON VISION PRO ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –∫–æ–¥–∞. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ ‚Äî –¥–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—Å—ã–≤–∞–π —á—Ç–æ –≤–∏–¥–∏—à—å. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º." },
                    { role: "user", content: promptText }
                ],
                model: "openai",
                seed: Math.floor(Math.random() * 1000)
            };

            const response = await fetch("https://text.pollinations.ai", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const resText = await response.text();
            load.remove();

            const formatted = resText.replace(/```(\w+)?([\s\S]*?)```/g, (m, l, code) => {
                return `<pre><button class="copy-btn" onclick="copy(this)">COPY</button><code class="language-${l || 'python'}">${escapeHtml(code.trim())}</code></pre>`;
            }).replace(/\n/g, '<br>');

            const aiDiv = document.createElement('div');
            aiDiv.className = 'msg ai';
            aiDiv.innerHTML = formatted;
            chat.appendChild(aiDiv);
            
            if (window.Prism) Prism.highlightAll();
            checkScroll();

        } catch (e) { 
            console.error(e);
            load.innerHTML = "‚ùå –û—à–∏–±–∫–∞ Vision-–º–æ–¥—É–ª—è.<br><small>" + escapeHtml(e.message) + "</small>"; 
        } finally {
            sendBtn.disabled = false;
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function copy(btn) {
        const code = btn.nextElementSibling.innerText;
        navigator.clipboard.writeText(code).then(() => { 
            btn.innerText = "OK!"; 
            setTimeout(() => btn.innerText = "COPY", 2000); 
        });
    }
</script>
</body>
</html>
